# æ ‡é¢˜: äº‹ä»¶å¾ªçŽ¯è¡¥å…¨è®¡åˆ’

# å‰è¨€

äº‹ä»¶å¾ªçŽ¯(event loop)æ˜¯ä¸€ä¸ªåœ¨ JavaScript å¸¸è¢«æèµ·çš„æ¦‚å¿µ, å®ƒå­˜åœ¨äºŽæµè§ˆå™¨ä¹Ÿå­˜åœ¨äºŽ Node.js ä¸­, å› ä¸ºå®ƒå¤æ‚çš„è¿è¡Œæœºåˆ¶å’Œå˜å¹»èŽ«æµ‹çš„è¡Œä¸ºä»¤äººéš¾ä»¥ç¢ç£¨, æ›´æ˜¯æˆä¸ºé¢è¯•æ—¶å€™çš„å¿…è€ƒé¢˜ç›®.

åœ¨æœ¬ç¯‡æ–‡ç« ä¸­å°†ä¼šæ€»ç»“ "äº‹ä»¶å¾ªçŽ¯" è¿™ä¸ªæ¦‚å¿µ, æ— è®ºæ˜¯æµè§ˆå™¨ç«¯è¿˜æ˜¯ Node.js ç«¯éƒ½ä¼šæ¶‰åŠ.

ä¸ºäº†å°½å¯èƒ½çš„å‡å°‘é”™è¯¯, æœ¬ç¯‡æ–‡ç« çš„ä¿¡æ¯æ¥æºåŸºäºŽ "å®˜æ–¹æ–‡æ¡£" ä»¥åŠ "è§„èŒƒ" å’Œ åŽ†å±Š jsconf å¤§ä¼šä¸Šçš„æœ‰å…³ "äº‹ä»¶å¾ªçŽ¯" çš„æ¼”è®², æœ¬ç¯‡æ–‡ç« å®žé™…ä¸Šå°±æ˜¯æŠŠè¿™äº›å†…å®¹æ€»ç»“åˆ°äº†ä¸€èµ·çš„ç»“æžœ, ä½ å¯ä»¥åœ¨æ–‡ç« çš„æœ«å°¾èŽ·å–è¿™äº›å†…å®¹æºåœ°å€.

# è¿›ç¨‹ä¸Žçº¿ç¨‹æ¨¡åž‹



# æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªçŽ¯

> https://youtu.be/8aGhZQkoFbQ



æˆ‘ä»¬å…ˆä»Žæµè§ˆå™¨å¼€å§‹, å› ä¸ºå¤§éƒ¨åˆ†ä»Žäº‹ Node.js å¼€å‘çš„å¤§å¤šæ•°äººæˆ–å¤šæˆ–å°‘éƒ½äº†è§£æµè§ˆå™¨ä¸­çš„äº‹ä»¶å¾ªçŽ¯çš„åŸºæœ¬æ¦‚å¿µ.

## JavaScriptè¿è¡Œçš„åŸºæœ¬æµç¨‹

æˆ‘ä»¬éƒ½çŸ¥é“JavaScriptæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ç¼–ç¨‹è¯­è¨€, è¿™æ„å‘³ç€å®ƒåªèƒ½æœ‰ä¸€ä¸ªè°ƒç”¨æ ˆ, æ‰§è¡Œè¿‡ç¨‹ä¸­æ¯æ¬¡åªèƒ½åšä¸€ä»¶äº‹æƒ….

ä¸ºäº†å……åˆ†ç†è§£, æˆ‘ä»¬æ¥ä¾‹ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­:

```javascript
function fun1() {
  return 'fun1'
}

function fun2() {
  return 'fun2' + fun1();
}

function fun3() {
  console.log(fun2());
}

fun3();
```

ä¸€æ—¦ä»£ç æ‰§è¡Œè°ƒç”¨æ ˆä¸­å‡½æ•°åŽ‹å…¥çš„é¡ºåºå¦‚ä¸‹:

```
fun3 // ç¬¬ä¸€ä¸ªå‡½æ•°è°ƒç”¨
fun3 -> fun2 // ç¬¬äºŒä¸ªå‡½æ•°è°ƒç”¨
fun3 -> fun2 -> fun1 // ç¬¬ä¸‰ä¸ªå‡½æ•°è°ƒç”¨
```

ä½äºŽæ ˆé¡¶çš„å‡½æ•°æ‰§è¡Œå®ŒæˆåŽè°ƒç”¨æ ˆä¼šæŠŠä»–å¼¹å‡º:

```
fun3 -> fun2 -> fun1 // fun1 æ‰§è¡Œå®Œæˆè°ƒç”¨æ ˆå¼¹å‡º
fun3 -> fun2 // fun2 æ‰§è¡Œå®Œæˆè°ƒç”¨æ ˆå¼¹å‡º
fun3 // fun3 æ‰§è¡Œå®Œæˆè°ƒç”¨æ ˆå¼¹å‡º
// è°ƒç”¨æ ˆæ¸…ç©º
```

è°ƒç”¨æ ˆè¢«JavaScriptå¼•æ“Žä½¿ç”¨å’Œç›‘è§†, æ‰€ä»¥å½“æˆ‘ä»¬åœ¨å‡½æ•°ä¸­æŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯ä½†æ˜¯æ²¡æœ‰å¯¹åº”çš„ `try/catch` è¯­å¥çš„æ—¶å€™:

```javascript
function fun1() {
  throw new Error('Warning: Nuclear Missile Launched') // æŠ›å‡ºä¸€ä¸ªé”™è¯¯ä½†æ˜¯æ²¡æœ‰å¯¹äºŽçš„ try/catch è¯­å¥
}

function fun2() {
  return 'fun2' + fun1();
}

function fun3() {
  console.log(fun2());
}

fun3();
```

å¯ä»¥åœ¨æŽ§åˆ¶å°ä¸­çš„æŠ¥é”™ä¸­çœ‹åˆ°è°ƒç”¨æ ˆçš„ä¿¡æ¯:

![1566047594418](C:\Users\zhao\Documents\library\article\assets\1566047594418.png)

ä½†æ˜¯è°ƒç”¨æ ˆä¹Ÿæ˜¯è„†å¼±çš„å¦‚æžœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ— æ³•ä¸­æ–­è°ƒç”¨å‡½æ•°, é‚£ä¹ˆè°ƒç”¨æ ˆä¼šçž¬é—´çˆ†ç‚¸ðŸ’¥è¿™ç§è¡Œä¸ºè¢«ç§°ä¸º "æ ˆæº¢å‡º". å¯å–œå¯è´ºçš„æ˜¯JavaScriptä¼šç›‘è§†è°ƒç”¨æ ˆ, ä¸€æ—¦è°ƒç”¨æ ˆå‡ºçŽ° "æ ˆæº¢å‡º" JavaScript ä¼šç»ˆæ­¢ä»£ç çš„æ‰§è¡Œå¹¶ä¸”æŠ›å‡ºé”™è¯¯:

```javascript
function foobar() {
	foobar();
}

foobar();
```

æŠ›å‡º "æ ˆæº¢å‡º" é”™è¯¯:

![1566048013705](C:\Users\zhao\Documents\library\article\assets\1566048013705.png)

## é˜»å¡žçš„åå¤„

åœ¨ Web å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸è¦ä¼šå¬åˆ°è¦é¿å…æµè§ˆå™¨é˜»å¡ž, "é˜»å¡ž" å¬èµ·æ¥æœ‰ç‚¹åƒæˆ‘ä»¬å¸¸è¯´çš„ "ç”µè„‘å¡ä½äº†" ä¸­çš„ "å¡".

å®žé™…ä¸Šé˜»å¡žå¹¶æ²¡æœ‰ä¸€ä¸ªä¸¥æ ¼çš„å®šä¹‰, JavaScript çš„è¿è¡Œé€Ÿåº¦æ˜¯å¾ˆå¿«çš„, æ‰§è¡Œå‡ ä¸ªç®€å•çš„ "console.log" ä½ æ— æ³•ä½“ä¼šåˆ°è¿™å…¶ä¸­æ‰€èŠ±è´¹çš„æ—¶é—´, å¦‚æžœè°ƒç”¨æ ˆä¸­æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°èŠ±è´¹çš„å¤§é‡çš„æ—¶é—´, æ­¤æ—¶æˆ‘ä»¬è¯´æµè§ˆå™¨è¢«é˜»å¡žäº†.

ä½†æ˜¯æµè§ˆå™¨ä¸ä»…ä»…æ‰§è¡Œ JavaScript ä»£ç è¿˜ä¼šå¼‚æ­¥çš„åŠ è½½å¤–éƒ¨èµ„æºæ–‡ä»¶, è¿™äº›åŠ è½½çš„æµç¨‹ä¹Ÿå¯ä»¥è¢« JavaScript æ‰€æŽ§åˆ¶, ä¾‹å¦‚æˆ‘ä»¬é€šè¿‡ JavaScript å‘èµ·ä¸€ä¸ªåŒæ­¥çš„ç½‘ç»œè¯·æ±‚:

```javascript
var oReq = new XMLHttpRequest();
oReq.onload = function(){};
oReq.open("get", "https://xxx.com/", false); // false è¡¨ç¤ºåŒæ­¥å‘é€è¯·æ±‚(è¿™ç§æ–¹å¼å·²ç»ä¸åœ¨è¢«æŽ¨èä½¿ç”¨ä»…ä»…ç”¨äºŽç¤ºä¾‹)
oReq.send();
alert('running!'); // åªæœ‰è¯·æ±‚å®ŒæˆåŽ alert æ‰ä¼šæ‰§è¡Œ
```

è¿™ä¸ªè¯·æ±‚æœ‰å¯èƒ½éœ€è¦ 20ms æˆ–è€… 300ms ç”šè‡³æ›´é•¿, åœ¨è¯·æ±‚çš„è¿‡ç¨‹ä¸­æµè§ˆå™¨ä¼šä¸€ç›´ç­‰å¾…è¯·æ±‚å®Œæˆç”šè‡³ä¼šåœæ­¢é¡µé¢çš„æ¸²æŸ“, æˆ‘ä»¬å¯ä»¥æ˜Žæ˜¾çš„æ„Ÿå—åˆ°æµè§ˆå™¨å¡ä½äº†, è¿™æ˜¯å…¸åž‹çš„é˜»å¡ž.

## å¼‚æ­¥å›žè°ƒ

æµè§ˆå™¨å°†æ‰€æœ‰å¯èƒ½èŠ±è´¹å¤§é‡æ—¶é—´ç­‰å¾…çš„æ“ä½œéƒ½æä¾›äº†å¯¹åº”çš„å¼‚æ­¥æŽ¥å£, åœ¨æµè§ˆå™¨ä¸­è¿™ç§è§£å†³æ–¹å¼è¢«ç§°ä¸º "å¼‚æ­¥å‡½æ•°" æˆ–è€… "å›žè°ƒå‡½æ•°" æˆ–è€… "å¼‚æ­¥å›žè°ƒ" ç­‰.

ä¸€ä¸ªå…¸åž‹çš„ä¾‹å­å¦‚ä¸‹:

```javascript
console.log('hello');

setTimeout(function foobar(){
    console.log('delay');
},1000);

console.log('world');
```

æˆ‘ä»¬éƒ½çŸ¥é“è¿™æ®µä»£ç ä¼šè¾“å‡ºçš„é¡ºåºæ˜¯:

1. hello
2. world
3. delay

é‚£ä¹ˆæµè§ˆå™¨åˆ°åº•æ˜¯å¦‚ä½•è§£é‡Šè¿™æ®µä»£ç çš„å‘¢, æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿæµè§ˆå™¨çš„è°ƒç”¨æ ˆ:

```
console.log('hello'); // åŽ‹å…¥æ ˆä¸­æ‰§è¡Œ
console.log('hello'); // æ‰§è¡Œå®Œæˆæ ˆå¼¹å‡º

setTimeout            // åŽ‹å…¥æ ˆä¸­æ‰§è¡Œ
setTimeout            // æ‰§è¡Œå®Œæˆæ ˆå¼¹å‡º

console.log('world'); // åŽ‹å…¥æ ˆä¸­æ‰§è¡Œ
console.log('world'); // æ‰§è¡Œå®Œæˆæ ˆå¼¹å‡º

-------1000msè¿‡åŽ------

foobar                // åŽ‹å…¥æ ˆä¸­æ‰§è¡Œ
console.log('delay'); // åŽ‹å…¥æ ˆä¸­æ‰§è¡Œ
console.log('delay'); // æ‰§è¡Œå®Œæˆå¼¹å‡º
foobar                // æ‰§è¡Œå®Œæˆå¼¹å‡º

```

æœ€ç¥žå¥‡çš„äº‹æƒ…å‡ºçŽ°äº† `setTimeout` æ‰§è¡Œå®ŒæˆåŽå°±è¢«è°ƒç”¨æ ˆå¼¹å‡ºäº†, ä½†æ˜¯ä¸çŸ¥ä½•æ•… 1000ms åŽ `setTimeout` ä¸­çš„ `foobar` è¢«ç¥žå¥‡çš„å”¤é†’äº†, è¿™æ˜¯æ€Žä¹ˆå›žäº‹?

## åŸºæœ¬äº‹ä»¶å¾ªçŽ¯

æˆ‘ä»¬ä¹‹å‰æåˆ°äº† JavaScript ç”±äºŽå…¶å•çº¿ç¨‹çš„ç‰¹æ€§åªèƒ½åœ¨åŒä¸€æ—¶é—´æ‰§è¡ŒåŒä¸€é—´äº‹æƒ…, è¿™æ˜¯æ­£ç¡®çš„, ä½†æ˜¯æµè§ˆå™¨ä¸ä»…ä»…æ‹¥æœ‰è§£é‡Š JavaScript è„šæœ¬çš„å¼•æ“Ž, è¿˜æœ‰ä¸€å †å…¶ä»–çš„ç¨‹åºæ¥å¤„ç†è¯¸å¦‚ `DOM` `XmlHttpRequest` `setTimeout` è¿™äº›ä»»åŠ¡.

è¿™äº›ç¨‹åºå„å¸å…¶èŒå®Œæˆè‡ªå·±è´Ÿè´£çš„éƒ¨åˆ†, å®ƒä»¬æ˜¯ç‹¬ç«‹äºŽ JavaScript å¼•æ“Žä¹‹å¤–çš„å†…å®¹, è¿™äº›ç¨‹åºæœ‰å¯èƒ½è¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹ä¸Šæˆ–è€…è¿›ç¨‹ä¸Šå®ƒä»¬é€šè¿‡`webapi` æ¥å’Œ JavaScriptå¼•æ“Žè¿›è¡Œé€šä¿¡, è¿™äº›ç¨‹åºæ˜¯å¼‚æ­¥çš„æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ "å›žè°ƒ" çš„æ–¹å¼è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹.

`setTimeout` ä½œä¸º `webapi` å…¸åž‹çš„ä¾‹å­, æˆ‘ä»¬æ¥è§‚å¯Ÿä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•è¿è¡Œçš„, é¦–å…ˆ `setTimeout` ä¸€æ—¦è¢«æ‰§è¡Œä¾¿å°†å‡½æ•°é’©å­ç§»äº¤ç»™å¯¹åº”çš„ `webapi` å¹¶ä¸”å¼€å§‹è®¡æ—¶:

```
+--------------------------------+     +---------------------+
|                                |     |webapis              |
|                                |     | +----------------+  |
| setTimeout(function foobar() { |     | |                |  |
| 	console.log('delay')         | +-> | | timer-0 -- cb()|  |
| },0);                          |     | |                |  |
|                                |     | +----------------+  |
|                                |     |                     |
+--------------------------------+     +---------------------+
```

ç”±äºŽæˆ‘ä»¬çš„å€’è®¡æ—¶æ˜¯0, æ‰€ä»¥è®¡æ—¶ä¼šç«‹å³å®Œæˆ, `webapi` å°†å‡½æ•°é’©å­ç§»äº¤ç»™ **ä»»åŠ¡é˜Ÿåˆ—** .

```
+--------------------------------+     +----------+
|                                |     |webapis   |
|                                |     |          |
| setTimeout(function foobar() { |     |          |
| 	console.log('delay')         | +-> |          | +-+
| },0);                          |     |          |   |
|                                |     |          |   |
|                                |     |          |   |
+--------------------------------+     +----------+   |
                                                      |
+-------------------------------------------------+   |
|                               task queue        |   |
| +--------------+                                |   |
| |              |                                |   |
| |    cb()      |                                | <-+
| |              |                                |
| +--------------+                                |
|                                                 |
+-------------------------------------------------+

```

æŽ¥ä¸‹æ¥ç»ˆäºŽè½®åˆ° **äº‹ä»¶å¾ªçŽ¯** ä¸Šåœºäº†, äº‹ä»¶å¾ªçŽ¯å®Œæˆä¸€ä»¶éžå¸¸ç®€å•çš„å·¥ä½œ, å®ƒåˆ¤æ–­å¦‚æžœ:

1. è°ƒç”¨æ ˆæ˜¯ç©ºçš„
2. ä»»åŠ¡é˜Ÿåˆ—ä¸­å­˜åœ¨ç€ä»»åŠ¡

é‚£ä¹ˆå°±å°†è¿™ä¸ªä»»åŠ¡ç§»å…¥åˆ°è°ƒç”¨æ ˆä¸­æ‰§è¡Œ:

```
+--------------------------------+ +------------------+
|                                | |           stack  |
|                                | | +--------------+ |
| setTimeout(function foobar() { | | |              | |
| 	console.log('delay')         | | |  cb - foobar | |
| },0);                          | | |              | |
|                                | | +--------+-----+ |
|                                | |          ^       |
+--------------------------------+ |          |       |
event loop â³                      |          |       |
+----+---------------------------+ |          |       |
|    |                           | |          |       |
|    |                           | |          |       |
|    +-- task ------> push -------------------+       |
|                                | |                  |
+--------------------------------+ +------------------+

```

ç„¶åŽå¾€å¤å¾ªçŽ¯è¿™ä¸ªè¿‡ç¨‹, è¿™å°±æ˜¯äº‹ä»¶å¾ªçŽ¯çš„åŸºæœ¬æµç¨‹.

çŽ°åœ¨æˆ‘ä»¬æ¥æå‡ºä¸€ä¸ª `ajax` çš„ä¾‹å­, å°è¯•ä¸€ä¸‹ä½ èƒ½è¯´å‡ºä»–çš„æ‰§è¡Œæµç¨‹å—:

```javascript
console.log('hello');

$.get('https:www.google.com',function foobar(){ console.log('callback') });

console.log('world');
```

ä»–çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹:

1. console.log('hello') --> åŽ‹å…¥è°ƒç”¨æ ˆä¸­æ‰§è¡Œ
2. console.log('hello') --> æ‰§è¡Œå®Œæˆå¼¹å‡ºè°ƒç”¨æ ˆ
3. $.get --> åŽ‹å…¥æ ˆä¸­æ‰§è¡Œ
4. $.get --> è°ƒç”¨äº† `webapi` ä¸­çš„ `XHR` å‘èµ·äº†ç½‘ç»œè¯·æ±‚, å¹¶ä¿å­˜å…¶å‡½æ•°é’©å­
5. $.get --> æ‰§è¡Œå®Œæˆå¼¹å‡ºè°ƒç”¨æ ˆ
6. console.log('world') --> åŽ‹å…¥è°ƒç”¨æ ˆä¸­æ‰§è¡Œ
7. console.log('world') --> æ‰§è¡Œå®Œæˆå¼¹å‡ºè°ƒç”¨æ ˆ
8. ç½‘ç»œè¯·æ±‚å®Œæˆ `webapi` å°†å‡½æ•°é’©å­ç§»åŠ¨åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­
9. äº‹ä»¶å¾ªçŽ¯--> æ£€æŸ¥è°ƒç”¨æ ˆæ˜¯å¦ä¸ºç©º æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ (äº‹ä»¶å¾ªçŽ¯ä¸€ç›´å­˜åœ¨å¹¶éžåœ¨åªåœ¨æ­¤åˆ»è¿›è¡Œæ£€æŸ¥)
   1. è°ƒç”¨æ ˆä¸ºç©º
   2. æ£€æŸ¥åˆ°è¯·æ±‚ä»»åŠ¡
   3. å°†è¯¥ä»»åŠ¡(foobarå‡½æ•°)åŽ‹å…¥åˆ°è°ƒç”¨æ ˆä¸­
10. console.log('callback') --> åŽ‹å…¥è°ƒç”¨æ ˆä¸­æ‰§è¡Œ
11. console.log('callback') --> æ‰§è¡Œå®Œæˆå¼¹å‡ºè°ƒç”¨æ ˆ
12. foobar --> æ‰§è¡Œå®Œæˆå¼¹å‡ºè°ƒç”¨æ ˆ
13. è°ƒç”¨æ ˆå†æ¬¡æ¸…ç©º

## å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

## äº‹ä»¶å¾ªçŽ¯å¦‚ä½•å½±å“æµè§ˆå™¨

# node.js ä¸­çš„äº‹ä»¶å¾ªçŽ¯

node.js çš„äº‹ä»¶å¾ªçŽ¯æ¨¡åž‹å’Œæµè§ˆå™¨ä¸åŒ, ä¸è¿‡åœ¨ node11 åŽè¿›è¡Œäº†ç»Ÿä¸€, è¿™é‡Œæˆ‘ä»¬ä¼šåˆ†å¼€è®¨è®º.

# ä¸¤è€…ä¹‹é—´çš„æ¯”è¾ƒ

# å¼•ç”¨

> https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/
>
> https://nodejs.org/dist/latest-v12.x/docs/api/worker_threads.html
>
> https://www.dynatrace.com/news/blog/all-you-need-to-know-to-really-understand-the-node-js-event-loop-and-its-metrics/#disqus_thread
>
> https://blog.csdn.net/Fundebug/article/details/86487117
>
> https://www.cnblogs.com/MuYunyun/p/7287413.html
>
> http://www.ruanyifeng.com/blog/2018/02/node-event-loop.html
>
> https://jsbin.com/dijodahawi/edit?html,css,js,console,output
>
> https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
>
> https://segmentfault.com/a/1190000019759283



