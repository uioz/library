# Ê†áÈ¢ò: ‰∫ã‰ª∂Âæ™ÁéØË°•ÂÖ®ËÆ°Âàí

# ÂâçË®Ä

‰∫ã‰ª∂Âæ™ÁéØ(event loop)ÊòØ‰∏Ä‰∏™Âú® JavaScript Â∏∏Ë¢´ÊèêËµ∑ÁöÑÊ¶ÇÂøµ, ÂÆÉÂ≠òÂú®‰∫éÊµèËßàÂô®‰πüÂ≠òÂú®‰∫é Node.js ‰∏≠, Âõ†‰∏∫ÂÆÉÂ§çÊùÇÁöÑËøêË°åÊú∫Âà∂ÂíåÂèòÂπªËé´ÊµãÁöÑË°å‰∏∫‰ª§‰∫∫Èöæ‰ª•Áê¢Á£®, Êõ¥ÊòØÊàê‰∏∫Èù¢ËØïÊó∂ÂÄôÁöÑÂøÖËÄÉÈ¢òÁõÆ.

Âú®Êú¨ÁØáÊñáÁ´†‰∏≠Â∞Ü‰ºöÊÄªÁªì "‰∫ã‰ª∂Âæ™ÁéØ" Ëøô‰∏™Ê¶ÇÂøµ, Êó†ËÆ∫ÊòØÊµèËßàÂô®Á´ØËøòÊòØ Node.js Á´ØÈÉΩ‰ºöÊ∂âÂèä.

‰∏∫‰∫ÜÂ∞ΩÂèØËÉΩÁöÑÂáèÂ∞ëÈîôËØØ, Êú¨ÁØáÊñáÁ´†ÁöÑ‰ø°ÊÅØÊù•Ê∫êÂü∫‰∫é "ÂÆòÊñπÊñáÊ°£" ‰ª•Âèä "ËßÑËåÉ" Âíå ÂéÜÂ±ä jsconf Â§ß‰ºö‰∏äÁöÑÊúâÂÖ≥ "‰∫ã‰ª∂Âæ™ÁéØ" ÁöÑÊºîËÆ≤, Êú¨ÁØáÊñáÁ´†ÂÆûÈôÖ‰∏äÂ∞±ÊòØÊääËøô‰∫õÂÜÖÂÆπÊÄªÁªìÂà∞‰∫Ü‰∏ÄËµ∑ÁöÑÁªìÊûú, ‰Ω†ÂèØ‰ª•Âú®ÊñáÁ´†ÁöÑÊú´Â∞æËé∑ÂèñËøô‰∫õÂÜÖÂÆπÊ∫êÂú∞ÂùÄ.



# ÊµèËßàÂô® - ‰∫ã‰ª∂Âæ™ÁéØÂàùÊé¢

> https://youtu.be/8aGhZQkoFbQ



Êàë‰ª¨ÂÖà‰ªéÊµèËßàÂô®ÂºÄÂßã, Âõ†‰∏∫Â§ßÈÉ®ÂàÜ‰ªé‰∫ã Node.js ÂºÄÂèëÁöÑÂ§ßÂ§öÊï∞‰∫∫ÊàñÂ§öÊàñÂ∞ëÈÉΩ‰∫ÜËß£ÊµèËßàÂô®‰∏≠ÁöÑ‰∫ã‰ª∂Âæ™ÁéØÁöÑÂü∫Êú¨Ê¶ÇÂøµ.

## JavaScriptËøêË°åÁöÑÂü∫Êú¨ÊµÅÁ®ã

Êàë‰ª¨ÈÉΩÁü•ÈÅìJavaScriptÊòØ‰∏Ä‰∏™ÂçïÁ∫øÁ®ãÁöÑÁºñÁ®ãËØ≠Ë®Ä, ËøôÊÑèÂë≥ÁùÄÂÆÉÂè™ËÉΩÊúâ‰∏Ä‰∏™Ë∞ÉÁî®Ê†à, ÊâßË°åËøáÁ®ã‰∏≠ÊØèÊ¨°Âè™ËÉΩÂÅö‰∏Ä‰ª∂‰∫ãÊÉÖ.

‰∏∫‰∫ÜÂÖÖÂàÜÁêÜËß£, Êàë‰ª¨Êù•‰æã‰∏æ‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰æãÂ≠ê:

```javascript
function fun1() {
  return 'fun1'
}

function fun2() {
  return 'fun2' + fun1();
}

function fun3() {
  console.log(fun2());
}

fun3();
```

‰∏ÄÊó¶‰ª£Á†ÅÊâßË°åË∞ÉÁî®Ê†à‰∏≠ÂáΩÊï∞ÂéãÂÖ•ÁöÑÈ°∫Â∫èÂ¶Ç‰∏ã:

```
+----------+ +----------+ +----------+
|    stack | |    stack | |    stack |
|          | |          | |          |
|          | |          | |          |
|          | |          | | +------+ |
|          | |          | | | fun3 | |
|          | |          | | +------+ |
|          | |          | |          |
|          | | +------+ | | +------+ |
|          | | | fun2 | | | | fun2 | |
|          | | +------+ | | +------+ |
|          | |          | |          |
| +------+ | | +------+ | | +------+ |
| | fun1 | | | | fun1 | | | | fun1 | |
| +------+ | | +------+ | | +------+ |
|          | |          | |          |
+----------+ +----------+ +----------+
```

‰Ωç‰∫éÊ†àÈ°∂ÁöÑÂáΩÊï∞(fun3)ÊâßË°åÂÆåÊàêÂêéË∞ÉÁî®Ê†à‰ºöÊää‰ªñÂºπÂá∫:

```
+----------+ +----------+ +----------+
|    stack | |    stack | |    stack |
|          | |          | |          |
|          | |          | |          |
|          | |          | |          |
|   üí•     | |          | |          |
|          | |          | |          |
|          | |          | |          |
| +------+ | |          | |          |
| | fun2 | | |    üí•    | |          |
| +------+ | |          | |          |
|          | |          | |          |
| +------+ | | +------+ | |          |
| | fun1 | | | | fun1 | | |    ‚ú®    |
| +------+ | | +------+ | |          |
|          | |          | |          |
+----------+ +----------+ +----------+
```

Ë∞ÉÁî®Ê†àË¢´JavaScriptÂºïÊìé‰ΩøÁî®ÂíåÁõëËßÜ, ÊâÄ‰ª•ÂΩìÊàë‰ª¨Âú®ÂáΩÊï∞‰∏≠ÊäõÂá∫‰∫Ü‰∏Ä‰∏™ÈîôËØØ‰ΩÜÊòØÊ≤°ÊúâÂØπÂ∫îÁöÑ `try/catch` ËØ≠Âè•ÁöÑÊó∂ÂÄô:

```javascript
function fun1() {
  throw new Error('Warning: Nuclear Missile Launched') // ÊäõÂá∫‰∏Ä‰∏™ÈîôËØØ‰ΩÜÊòØÊ≤°ÊúâÂØπ‰∫éÁöÑ try/catch ËØ≠Âè•
}

function fun2() {
  return 'fun2' + fun1();
}

function fun3() {
  console.log(fun2());
}

fun3();
```

ÂèØ‰ª•Âú®ÊéßÂà∂Âè∞‰∏≠ÁöÑÊä•Èîô‰∏≠ÁúãÂà∞Ë∞ÉÁî®Ê†àÁöÑ‰ø°ÊÅØ:

![1566047594418](C:\Users\zhao\Documents\library\article\assets\1566047594418.png)

‰ΩÜÊòØË∞ÉÁî®Ê†à‰πüÊòØËÑÜÂº±ÁöÑÂ¶ÇÊûúÊàë‰ª¨ÂàõÂª∫‰∏Ä‰∏™Êó†Ê≥ï‰∏≠Êñ≠Ë∞ÉÁî®ÂáΩÊï∞, ÈÇ£‰πàË∞ÉÁî®Ê†à‰ºöÁû¨Èó¥ÁàÜÁÇ∏üí•ËøôÁßçË°å‰∏∫Ë¢´Áß∞‰∏∫ "Ê†àÊ∫¢Âá∫". ÂèØÂñúÂèØË¥∫ÁöÑÊòØJavaScript‰ºöÁõëËßÜË∞ÉÁî®Ê†à, ‰∏ÄÊó¶Ë∞ÉÁî®Ê†àÂá∫Áé∞ "Ê†àÊ∫¢Âá∫" JavaScript ‰ºöÁªàÊ≠¢‰ª£Á†ÅÁöÑÊâßË°åÂπ∂‰∏îÊäõÂá∫ÈîôËØØ:

```javascript
function foobar() {
	foobar();
}

foobar();
```

ÊäõÂá∫ "Ê†àÊ∫¢Âá∫" ÈîôËØØ:

![1566048013705](C:\Users\zhao\Documents\library\article\assets\1566048013705.png)

## ÈòªÂ°ûÁöÑÂùèÂ§Ñ

Âú® Web ÂºÄÂèë‰∏≠Êàë‰ª¨ÁªèÂ∏∏Ë¶Å‰ºöÂê¨Âà∞Ë¶ÅÈÅøÂÖçÊµèËßàÂô®ÈòªÂ°û, "ÈòªÂ°û" Âê¨Ëµ∑Êù•ÊúâÁÇπÂÉèÊàë‰ª¨Â∏∏ËØ¥ÁöÑ "ÁîµËÑëÂç°‰Ωè‰∫Ü" ‰∏≠ÁöÑ "Âç°‰Ωè".

ÂÆûÈôÖ‰∏äÈòªÂ°ûÂπ∂Ê≤°Êúâ‰∏Ä‰∏™‰∏•Ê†ºÁöÑÂÆö‰πâ, JavaScript ÁöÑËøêË°åÈÄüÂ∫¶ÊòØÂæàÂø´ÁöÑ, ÊâßË°åÂá†‰∏™ÁÆÄÂçïÁöÑ "console.log" ‰Ω†Êó†Ê≥ï‰Ωì‰ºöÂà∞ËøôÂÖ∂‰∏≠ÊâÄËä±Ë¥πÁöÑÊó∂Èó¥, Â¶ÇÊûúË∞ÉÁî®Ê†à‰∏≠Ê≠£Âú®ÊâßË°åÁöÑÂáΩÊï∞Ëä±Ë¥π‰∫ÜÂ§ßÈáèÁöÑÊó∂Èó¥, Êàë‰ª¨ÊÑüËßâÊµèËßàÂô®Ë¢´Âç°‰Ωè‰∫Ü, ‰ΩìÈ™å‰∏çÊµÅÁïÖÊ≠§Êó∂Êàë‰ª¨ËØ¥, ÊµèËßàÂô®Ë¢´ÈòªÂ°û‰∫Ü.

‰ΩÜÊòØÊµèËßàÂô®‰∏ç‰ªÖ‰ªÖÊâßË°å JavaScript ‰ª£Á†ÅËøò‰ºöÂºÇÊ≠•ÁöÑÂä†ËΩΩÂ§ñÈÉ®ËµÑÊ∫êÊñá‰ª∂, Ëøô‰∫õÂä†ËΩΩÁöÑÊµÅÁ®ã‰πüÂèØ‰ª•Ë¢´ JavaScript ÊâÄÊéßÂà∂, ‰æãÂ¶ÇÊàë‰ª¨ÈÄöËøá JavaScript ÂèëËµ∑‰∏Ä‰∏™ÂêåÊ≠•ÁöÑÁΩëÁªúËØ∑Ê±Ç:

```javascript
var oReq = new XMLHttpRequest();
oReq.onload = function(){};
oReq.open("get", "https://xxx.com/", false); // false Ë°®Á§∫ÂêåÊ≠•ÂèëÈÄÅËØ∑Ê±Ç(ËøôÁßçÊñπÂºèÂ∑≤Áªè‰∏çÂú®Ë¢´Êé®Ëçê‰ΩøÁî®‰ªÖ‰ªÖÁî®‰∫éÁ§∫‰æã)
oReq.send();
alert('running!'); // Âè™ÊúâËØ∑Ê±ÇÂÆåÊàêÂêé alert Êâç‰ºöÊâßË°å
```

Ëøô‰∏™ËØ∑Ê±ÇÊúâÂèØËÉΩÈúÄË¶Å 20ms ÊàñËÄÖ 300ms ÁîöËá≥Êõ¥Èïø, Âú®ËØ∑Ê±ÇÁöÑËøáÁ®ã‰∏≠ÊµèËßàÂô®‰ºö‰∏ÄÁõ¥Á≠âÂæÖËØ∑Ê±ÇÂÆåÊàêÁîöËá≥‰ºöÂÅúÊ≠¢È°µÈù¢ÁöÑÊ∏≤Êüì, Êàë‰ª¨ÂèØ‰ª•ÊòéÊòæÁöÑÊÑüÂèóÂà∞ÊµèËßàÂô®Âç°‰Ωè‰∫Ü, ËøôÊòØÂÖ∏ÂûãÁöÑÈòªÂ°û.

## ÂºÇÊ≠•ÂõûË∞É

ÊµèËßàÂô®Â∞ÜÊâÄÊúâÂèØËÉΩËä±Ë¥πÂ§ßÈáèÊó∂Èó¥Á≠âÂæÖÁöÑÊìç‰ΩúÈÉΩÊèê‰æõ‰∫ÜÂØπÂ∫îÁöÑÂºÇÊ≠•Êé•Âè£, ËøôÁßçËß£ÂÜ≥ÊñπÂºèË¢´Áß∞‰∏∫ "ÂºÇÊ≠•ÂáΩÊï∞" ÊàñËÄÖ "ÂõûË∞ÉÂáΩÊï∞" ÊàñËÄÖ "ÂºÇÊ≠•ÂõûË∞É" Á≠â.

‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑ‰æãÂ≠êÂ¶Ç‰∏ã:

```javascript
console.log('hello');

setTimeout(function foobar(){
    console.log('delay');
},1000);

console.log('world');
```

Êàë‰ª¨ÈÉΩÁü•ÈÅìËøôÊÆµ‰ª£Á†Å‰ºöËæìÂá∫ÁöÑÈ°∫Â∫èÊòØ:

1. hello
2. world
3. delay

ÈÇ£‰πàÊµèËßàÂô®Âà∞Â∫ïÊòØÂ¶Ç‰ΩïËß£ÈáäËøôÊÆµ‰ª£Á†ÅÁöÑÂë¢, Êàë‰ª¨ÂèØ‰ª•ËßÇÂØüÊµèËßàÂô®ÁöÑË∞ÉÁî®Ê†à:

```
console.log('hello'); // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('hello'); // ÊâßË°åÂÆåÊàêÊ†àÂºπÂá∫

setTimeout            // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
setTimeout            // ÊâßË°åÂÆåÊàêÊ†àÂºπÂá∫

console.log('world'); // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('world'); // ÊâßË°åÂÆåÊàêÊ†àÂºπÂá∫

-------1000msËøáÂêé------

foobar                // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('delay'); // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('delay'); // ÊâßË°åÂÆåÊàêÂºπÂá∫
foobar                // ÊâßË°åÂÆåÊàêÂºπÂá∫

```

ÊúÄÁ•ûÂ•áÁöÑ‰∫ãÊÉÖÂá∫Áé∞‰∫Ü `setTimeout` ÊâßË°åÂÆåÊàêÂêéÂ∞±Ë¢´Ë∞ÉÁî®Ê†àÂºπÂá∫‰∫Ü, ‰ΩÜÊòØ‰∏çÁü•‰ΩïÊïÖ 1000ms Âêé `setTimeout` ‰∏≠ÁöÑ `foobar` Ë¢´Á•ûÂ•áÁöÑÂî§ÈÜí‰∫Ü, ËøôÊòØÊÄé‰πàÂõû‰∫ã?

## È¢òÂ§ñËØù webapi

Âú® JavaScript ‰∏≠ÊâßË°åÂÖÉÁ¥†ÁªëÂÆö‰∫ã‰ª∂, ‰ΩøÁî® `setTimeout` ËÆæÁΩÆ‰∏Ä‰∏™Âª∂Êó∂ÊâßË°å, ÊàñËÄÖÂèëËµ∑‰∏ÄÊ¨°ÁΩëÁªúËØ∑Ê±Ç. Ëøô‰∫õÈÉΩÊòØwebÂºÄÂèëËÄÖÁöÑÂÆ∂Â∏∏‰æøÈ•≠, ÂØπ‰∫éÊàë‰ª¨Êù•ËØ¥Ëøô‰∫õÂÜÖÂÆπÂ∞±ÊòØ JavaScript ÁöÑ‰∏ÄÈÉ®ÂàÜ‰∫Ü, ‰ΩÜÊòØÂÆûÈôÖ‰∏äËøô‰∫õÂÜÖÂÆπÂπ∂Ê≤°ÊúâÂú® ECMAScript Âà∂ÂÆöÁöÑÊ†áÂáÜ‰∏≠, ÂåÖÊã¨Êàë‰ª¨ËÆ®ËÆ∫ÁöÑ "‰∫ã‰ª∂Âæ™ÁéØ" Êú∫Âà∂ÂÆÉ‰πüÊ≤°ÊúâÂ≠òÂú®‰∫éËßÑËåÉ‰∏≠‰πüÂ∞±ÊòØËØ¥Ëøô‰∏™Êú∫Âà∂ÊòØÁã¨Á´ã‰∫é JavaScript ÂºïÊìéÁöÑÂäüËÉΩ.

Ëøô‰∫õAPIË¢´Áß∞‰∏∫ `webapi` ÂÆÉ‰ª¨ÊúâËá™Â∑±ÁöÑËßÑËåÉÂíåÂÆûÁé∞‰∏é JavaScript ËøôÈó®ËØ≠Ë®ÄÊ≤°ÊúâÂÖ≥Á≥ª, Âú®Ëøô‰ªΩÊù•Ëá™‰∫éMDNÁöÑ[È°µÈù¢‰∏ä](https://developer.mozilla.org/zh-CN/docs/Web/API)Âàó‰∏æ‰∫ÜÊâÄÊúâÁöÑAPI.

## Âü∫Êú¨‰∫ã‰ª∂Âæ™ÁéØ

Êàë‰ª¨‰πãÂâçÊèêÂà∞‰∫Ü JavaScript Áî±‰∫éÂÖ∂ÂçïÁ∫øÁ®ãÁöÑÁâπÊÄßÂè™ËÉΩÂú®Âêå‰∏ÄÊó∂Èó¥ÊâßË°åÂêå‰∏ÄÈó¥‰∫ãÊÉÖ, ËøôÊòØÊ≠£Á°ÆÁöÑ, ‰ΩÜÊòØÊµèËßàÂô®‰∏ç‰ªÖ‰ªÖÊã•ÊúâËß£Èáä JavaScript ËÑöÊú¨ÁöÑÂºïÊìé, ËøòÊúâ‰∏ÄÂ†ÜÂÖ∂‰ªñÁöÑÁ®ãÂ∫èÊù•Â§ÑÁêÜËØ∏Â¶Ç `DOM` `XmlHttpRequest` `setTimeout` Ëøô‰∫õ‰ªªÂä°.

Ëøô‰∫õÁ®ãÂ∫èÂêÑÂè∏ÂÖ∂ËÅåÂÆåÊàêËá™Â∑±Ë¥üË¥£ÁöÑÈÉ®ÂàÜ, ÂÆÉ‰ª¨ÊòØÁã¨Á´ã‰∫é JavaScript ÂºïÊìé‰πãÂ§ñÁöÑÂÜÖÂÆπ, Ëøô‰∫õÁ®ãÂ∫èÂèØËÉΩËøêË°åÂú®Áã¨Á´ãÁ∫øÁ®ã‰∏äÊàñËÄÖËøõÁ®ã‰∏äÂÆÉ‰ª¨ÈÄöËøá`webapi` Êù•Âíå JavaScriptÂºïÊìéËøõË°åÈÄö‰ø°, ÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶ÅÈÄöËøá "ÂõûË∞É" ÁöÑÊñπÂºèËøõË°åÂºÇÊ≠•ÁºñÁ®ã.

ËÄå **‰∫ã‰ª∂Âæ™ÁéØ** Áî®‰∫éÁÆ°ÁêÜËøô‰∫õÂºÇÊ≠•‰ªªÂä°Âú®ÂêàÈÄÇÁöÑÊó∂Êú∫ÊâßË°å.

`setTimeout` ‰Ωú‰∏∫ `webapi` ÂÖ∏ÂûãÁöÑ‰æãÂ≠ê, Êàë‰ª¨Êù•ËßÇÂØü‰∏Ä‰∏ãÂÆÉÊòØÂ¶Ç‰ΩïËøêË°åÁöÑ, È¶ñÂÖà `setTimeout` ‰∏ÄÊó¶Ë¢´ÊâßË°å‰æøÂ∞ÜÂáΩÊï∞Èí©Â≠êÁßª‰∫§ÁªôÂØπÂ∫îÁöÑ `webapi` Âπ∂‰∏îÂºÄÂßãËÆ°Êó∂:

```
+--------------------------------+     +---------------------+
|                                |     |webapis              |
|                                |     | +----------------+  |
| setTimeout(function foobar() { |     | |                |  |
| 	console.log('delay')         | +-> | | timer-0 -- cb()|  |
| },0);                          |     | |                |  |
|                                |     | +----------------+  |
|                                |     |                     |
+--------------------------------+     +---------------------+
```

Áî±‰∫éÊàë‰ª¨ÁöÑÂÄíËÆ°Êó∂ÊòØ0, ÊâÄ‰ª•ËÆ°Êó∂‰ºöÁ´ãÂç≥ÂÆåÊàê, `webapi` Â∞ÜÂáΩÊï∞Èí©Â≠êÁßª‰∫§Áªô **‰ªªÂä°ÈòüÂàó** .

```
+--------------------------------+     +----------+
|                                |     |webapis   |
|                                |     |          |
| setTimeout(function foobar() { |     |          |
| 	console.log('delay')         |     |          | +-+
| },0);                          |     |          |   |
|                                |     |          |   |
|                                |     |          |   |
+--------------------------------+     +----------+   |
                                                      |
+-------------------------------------------------+   |
|                               task queue        |   |
| +--------------+                                |   |
| |              |                                |   |
| |    cb()      |                                | <-+
| |              |                                |
| +--------------+                                |
|                                                 |
+-------------------------------------------------+

```

Êé•‰∏ãÊù•Áªà‰∫éËΩÆÂà∞ **‰∫ã‰ª∂Âæ™ÁéØ** ‰∏äÂú∫‰∫Ü, ‰∫ã‰ª∂Âæ™ÁéØÂÆåÊàê‰∏Ä‰ª∂ÈùûÂ∏∏ÁÆÄÂçïÁöÑÂ∑•‰Ωú, ÂÆÉÂà§Êñ≠Â¶ÇÊûú:

1. Ë∞ÉÁî®Ê†àÊòØÁ©∫ÁöÑ
2. ‰ªªÂä°ÈòüÂàó‰∏≠Â≠òÂú®ÁùÄ‰ªªÂä°

ÈÇ£‰πàÂ∞±Â∞ÜËøô‰∏™‰ªªÂä°ÁßªÂÖ•Âà∞Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å:

```
+--------------------------------+ +------------------+
|                                | |           stack  |
|                                | | +--------------+ |
| setTimeout(function foobar() { | | |              | |
| 	console.log('delay')         | | |  cb - foobar | |
| },0);                          | | |              | |
|                                | | +--------+-----+ |
|                                | |          ^       |
+--------------------------------+ |          |       |
event loop ‚è≥                      |          |       |
+----+---------------------------+ |          |       |
|    |                           | |          |       |
|    |                           | |          |       |
|    +-- task ------> push -------------------+       |
|                                | |                  |
+--------------------------------+ +------------------+

```

ÁÑ∂ÂêéÂæÄÂ§çÂæ™ÁéØËøô‰∏™ËøáÁ®ã, ËøôÂ∞±ÊòØ‰∫ã‰ª∂Âæ™ÁéØÁöÑÂü∫Êú¨ÊµÅÁ®ã.

Áé∞Âú®Êàë‰ª¨Êù•ÊèêÂá∫‰∏Ä‰∏™ `ajax` ÁöÑ‰æãÂ≠ê, Â∞ùËØï‰∏Ä‰∏ã‰Ω†ËÉΩËØ¥Âá∫‰ªñÁöÑÊâßË°åÊµÅÁ®ãÂêó:

```javascript
console.log('hello');

$.get('https:www.google.com',function foobar(){ console.log('callback') });

console.log('world');
```

‰ªñÁöÑÊâßË°åÊµÅÁ®ãÂ¶Ç‰∏ã:

1. console.log('hello') --> ÂéãÂÖ•Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å
2. console.log('hello') --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
3. $.get --> ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
4. $.get --> Ë∞ÉÁî®‰∫Ü `webapi` ‰∏≠ÁöÑ `XHR` ÂèëËµ∑‰∫ÜÁΩëÁªúËØ∑Ê±Ç, Âπ∂‰øùÂ≠òÂÖ∂ÂáΩÊï∞Èí©Â≠ê
5. $.get --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
6. console.log('world') --> ÂéãÂÖ•Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å
7. console.log('world') --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
8. ÁΩëÁªúËØ∑Ê±ÇÂÆåÊàê `webapi` Â∞ÜÂáΩÊï∞Èí©Â≠êÁßªÂä®Âà∞‰ªªÂä°ÈòüÂàó‰∏≠
9. ‰∫ã‰ª∂Âæ™ÁéØ--> Ê£ÄÊü•Ë∞ÉÁî®Ê†àÊòØÂê¶‰∏∫Á©∫ Ê£ÄÊü•‰ªªÂä°ÈòüÂàó‰∏≠ÊòØÂê¶Êúâ‰ªªÂä° (‰∫ã‰ª∂Âæ™ÁéØ‰∏ÄÁõ¥Â≠òÂú®Âπ∂ÈùûÂú®Âè™Âú®Ê≠§ÂàªËøõË°åÊ£ÄÊü•)
   1. Ë∞ÉÁî®Ê†à‰∏∫Á©∫
   2. Ê£ÄÊü•Âà∞ËØ∑Ê±Ç‰ªªÂä°
   3. Â∞ÜËØ•‰ªªÂä°(foobarÂáΩÊï∞)ÂéãÂÖ•Âà∞Ë∞ÉÁî®Ê†à‰∏≠
10. console.log('callback') --> ÂéãÂÖ•Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å
11. console.log('callback') --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
12. foobar --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
13. Ë∞ÉÁî®Ê†àÂÜçÊ¨°Ê∏ÖÁ©∫

# ‰∫ã‰ª∂Âæ™ÁéØÂ¶Ç‰ΩïÂΩ±ÂìçÊ∏≤Êüì

> https://youtu.be/cCOL7MC4Pl0

Âú®‰∏ä‰∏ÄËäÇ‰∏≠Êàë‰ª¨ÊèêÂà∞‰∫Ü JavaScript ÊòØÂçïÁ∫øÁ®ãÁöÑÂ¶ÇÊûúËä±Ë¥πÂ§ßÈáèÁöÑÊó∂Èó¥ËøêË°å JavaScript ÈÇ£‰πàÂ∞±‰ºöÈòªÂ°ûÊµèËßàÂô®, ÂØºËá¥ÊµèËßàÂô®Êó†Ê≥ïÂÆåÊàêÂÖ∂‰ªñÂ∑•‰Ωú, Âπ∂‰∏îÂàùÊ¨°‰∫ÜËß£‰∫Ü "‰∫ã‰ª∂Âæ™ÁéØ" ÊòØÂ¶Ç‰ΩïËß£ÂÜ≥ÈóÆÈ¢òÁöÑ. Âú®Ëøô‰∏ÄËäÇ‰∏≠Êàë‰ª¨‰ºöÊõ¥Âä†Ê∑±ÂÖ•, Êé¢ËÆ® "‰∫ã‰ª∂Âæ™ÁéØ" ÊòØÂ¶Ç‰ΩïÂΩ±ÂìçÊ∏≤Êüì.

ÂÆûÈôÖ‰∏ä‰∫ã‰ª∂Âæ™ÁéØÁöÑ‰ΩúÁî®ËåÉÂõ¥ÂèØËÉΩË∂Ö‰πé‰Ω†ÁöÑÊÉ≥Ë±°, ‰∏æ‰∏™‰æãÂ≠êÊâÄÊúâÁöÑDOM‰∫ã‰ª∂ÂÆûÈôÖ‰∏äÈÉΩÊòØÂèóÂà∞‰∫Ü "‰∫ã‰ª∂Âæ™ÁéØ" ÊéßÂà∂ÁöÑ, Èô§Ê≠§‰ª•Â§ñËøòÂåÖÊã¨ÂåÖÊã¨ÁΩëÁªúËØ∑Ê±Ç, IOÊìç‰ΩúÁ≠âÁ≠âËøô‰∫õÂ∏∏ËßÅÁöÑÂäüËÉΩ. Âõ†‰∏∫Âú®ËÉåÂêéËøô‰∫õ‰∫ã‰ª∂ÁöÑËß¶ÂèëËÄÖÂÆûÈôÖ‰∏äÈÉΩÊòØÂ∞Ü‰∏é‰∫ã‰ª∂ÊúâÂÖ≥ÁöÑ‰ø°ÊÅØÊîæÂÖ•Âà∞‰∫Ü "‰ªªÂä°ÈòüÂàó" ‰∏≠ÁúüÊ≠£ËÆ©Ëøô‰∫õÂÜÖÂÆπË¢´ÊâßË°åÁöÑÂÆûÈôÖ‰∏äÊòØ "‰∫ã‰ª∂Âæ™ÁéØ", ËøòËÆ∞Âæó "‰∫ã‰ª∂Âæ™ÁéØ" ÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÂêó? ÈÄöËøá‰ª•‰∏ãÁöÑ‰∏§‰∏™Âà§Êñ≠, "‰∫ã‰ª∂Âæ™ÁéØ" ‰ºöÂ∞ÜÊúÄËøëÁöÑ‰ªªÂä°ÁßªÈÄÅÂà∞ "Ë∞ÉÁî®Ê†à" ‰∏≠:

1. ‰ªªÂä°ÈòüÂàó‰∏≠Âê´Êúâ‰ªªÂä°
2. Ë∞ÉÁî®Ê†à‰∏∫Á©∫

‰ΩÜÊòØÊµèËßàÂô®‰∏≠‰∏ç‰ªÖ‰ªÖÊâßË°å JavaScript ‰ª£Á†ÅËøò‰ºöÂ§ÑÁêÜÈ°µÈù¢Ê∏≤Êüì, Êàë‰ª¨Áü•ÈÅìÂ¶ÇÊûúËøõË°åÂ§ßÈáèÁöÑ JavaScript ËÆ°ÁÆóÈÇ£‰πàÊµèËßàÂô®‰ºöÂÅúÊ≠¢Ê∏≤ÊüìËøôÈáåÈù¢Âà∞Â∫ïÈöêËóèÁùÄ‰ΩïÁßçÁöÑÂü∫ÊÉÖÂÖ≥Á≥ª? Êàë‰ª¨ÂÖàÊù•‰∫ÜËß£‰∏Ä‰∏ãÂü∫Êú¨ÁöÑÊ∏≤ÊüìÊ¶ÇÂøµ.

## Âü∫Êú¨ÁöÑÊ∏≤Êüì

Êàë‰ª¨Âú®È°µÈù¢‰∏≠Âä®ÊÄÅÁöÑ‰øÆÊîπÊ†∑ÂºèÁïåÈù¢‰ºöËøõË°åÂÆûÊó∂ÂèçÂ∫î, ÊâÄ‰ª•Êàë‰ª¨ËÆ§‰∏∫Ëøô‰∫õÊìç‰ΩúÊòØÂêåÊ≠•ÁöÑÊìç‰Ωú, ‰ΩÜÊòØÂÆûÈôÖ‰∏äÊµèËßàÂô®Âú®ËÉåÂêéËøõË°å‰∫Ü‰ºòÂåñ, ÈáçÂ§çÂ§öÊ≠§ÁöÑÊ†∑ÂºèÊìç‰Ωú‰ºöË¢´ËøõË°åÂêàÂπ∂ÁÑ∂ÂêéÁî±ÊµèËßàÂô®ÂÜ≥ÂÆö‰∏Ä‰∏™ÂêàÈÄÇÁöÑÊó∂Êú∫ÁÑ∂ÂêéÁªü‰∏ÄÊõ¥Êñ∞: 

```javascript
element.style.transition = "transform 1s";
element.style.transform = "translateX(100px)";
element.style.transform = "translateX(500px)";
```

Â∫îÁî®‰∫ÜÊ†∑ÂºèÁöÑÂÖÉÁ¥†Âπ∂‰∏ç‰ºöÊ®™ÂêëÂú® 100px Âíå 500px ‰πãÈó¥Êù•ÂõûÁßªÂä®ËÄåÊòØÁõ¥Êé•ÁßªÂä®Âà∞‰∫Ü 500px, ÊµèËßàÂô®ÊäõÂºÉ‰∫ÜÊóßÁöÑÊó†Áî®ÁöÑÊ†∑Âºè‰øÆÊîπ.

ÊâÄ‰ª•ËØ¥‰øÆÊîπÊ†∑ÂºèÂπ∂‰∏çÊòØÂêåÊ≠•ÁöÑ, ÊµèËßàÂô®ÁöÑ‰ºòÂåñÂ∏¶Êù•ÁöÑÂºÇÊ≠•ÁöÑÊõ¥Êñ∞Êú∫Âà∂ÂØºËá¥ÂÆÉÂíå "‰∫ã‰ª∂Âæ™ÁéØ" ‰πãÈó¥‰∫ßÁîüÂÖ≥ËÅî, Âú®‰∫ÜËß£Ëøô‰∫õÂÖ≥ËÅîÂâçÊàë‰ª¨ÂÖàÊù•‰∫ÜËß£‰∏Ä‰∏ãÊµèËßàÂô®ÁöÑÂü∫Êú¨Ê∏≤ÊüìÊú∫Âà∂.

ÂÖÉÁ¥†Ê†∑ÂºèÂÜ≥ÂÆöÊ∏≤ÊüìÁöÑÁªìÊûú, ‰ªé‰∏ÄÂ†Ü‰ª£Á†ÅËΩ¨‰∏∫ÂèØËßÜÂåñÁöÑÁïåÈù¢ÁªèÂéÜ‰∫ÜËÆ∏Â§öÁéØËäÇ, ËøôÈáåÊàë‰ª¨Êù•ÁÆÄÂçïÁöÑ‰∫ÜËß£‰∏Ä‰∏ãÂÖ∂‰∏≠ÁöÑÂá†‰∏™ÂÖ≥ÈîÆÊ≠•È™§:

1. ËÆ°ÁÆóÊ†∑Âºè - Êî∂ÈõÜ css ËÆ°ÁÆóÂ∫îÁî®Âà∞ÊØè‰∏™ÂÖÉÁ¥†‰∏äÁöÑÊ†∑Âºè
2. Â∏ÉÂ±Ä - Á°ÆÂÆöÈ°µÈù¢‰∏äÁöÑÂÖÉÁ¥†ÁöÑ‰ΩçÁΩÆÂ±ÇÂè†ÂÖ≥Á≥ª
3. ÁªòÂà∂ - ÂàõÂª∫ÂÆûÈôÖÁöÑÂÉèÁ¥†ÁªòÂà∂Âà∞È°µÈù¢‰∏ä

## Ë¢´Âä®ÁöÑÊ∏≤Êüì

Âú®‰∏ãÈù¢ÁöÑËøô‰∏™‰æãÂ≠ê‰∏≠‰ΩøÁî®‰∫Ü‰∏Ä‰∏™ `video` Êù•Ë°®Á§∫È°µÈù¢ËøõË°åÂä®ÊÄÅÁöÑÊåÅÁª≠ÁöÑÈ°µÈù¢Ê∏≤Êüì, Ëøô‰∫õÂµåÂÖ•ÁöÑÂÜÖÂÆπÂèØ‰ª•Âú®‰∏çÂèó JavaScript ÁöÑÂπ≤Êâ∞‰∏ãÂΩ±ÂìçÈ°µÈù¢ÁöÑÊòæÁ§∫, ÂΩìÁÇπÂáªÊåâÈíÆÁöÑÊó∂ÂÄô JavaScript ËøõÂÖ•Ê≠ªÂæ™ÁéØ:

```javascript
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>test</title>
</head>
<body>
  <video src="https://vjs.zencdn.net/v/oceans.mp4" controls autoplay></video>
  <button id="button">while true</button>
  <script>
    document.getElementById('button').addEventListener('click',()=>{
      while(true);
    });
  </script>
</body>
</html>
```

ÂΩìÊàë‰ª¨ÁÇπÂáª‰∫ÜÊåâÈíÆÁöÑÊó∂ÂÄô:

1. click ‰∫ã‰ª∂Ë¢´ÊîæÂÖ•Âà∞‰∫Ü‰ªªÂä°ÈòüÂàó‰∏≠
2. ‰∫ã‰ª∂Âæ™ÁéØÂ∞Üclick ‰∫ã‰ª∂ÂéãÂÖ•Ë∞ÉÁî®Ê†à
3. `while true` ÊâßË°å

Ê≠§Êó∂Ê∏≤ÊüìÂ∑•‰ΩúÂú®Á≠âÂæÖ JavaScript ÊâßË°åÂÆåÊàê, ‰ΩÜÊòØ JavaScript ËøõÂÖ•‰∫ÜÊó†ÈôêÂæ™ÁéØ‰∏≠ÊâÄ‰ª•Ê∏≤ÊüìÂ∑•‰ΩúÂ∞±‰∏ÄÁõ¥Âú®Á≠âÂæÖ‰∏≠Ê∞∏Ëøú‰∏ç‰ºöÂæóÂà∞ÂÆåÊàê.

Ëß£ÈáäËøôÁßçË°å‰∏∫ÁöÑ‰∏Ä‰∏™Â•ΩÁöÑÊñπÂºèÂ∞±ÊòØ: **Êàë‰ª¨‰∏çÂ¶®ÊääÈ°µÈù¢ÁöÑÊ∏≤ÊüìËøáÁ®ã‰πüËßÜ‰∏∫ "‰ªªÂä°ÈòüÂàó" ‰∏≠ÁöÑ‰∏Ä‰∏™‰ªªÂä°, Ëøô‰∏™‰ªªÂä°ÁöÑÂàõÂª∫ËÄÖÂ∞±ÊòØÊµèËßàÂô®Êú¨Ë∫´,ÂÆÉÂú®‰∏Ä‰∏™ÂêàÈÄÇÁöÑÊó∂Êú∫ÊääÊ∏≤Êüì‰ªªÂä°ÊîæÂÖ•Âà∞‰ªªÂä°ÈòüÂàó‰∏≠Á≠âÂæÖÊâßË°å, ‰ΩÜÊòØÁî±‰∫é‰ª£Á†ÅÈòªÂ°ûÂØºËá¥È°µÈù¢Êó†Ê≥ïÂèäÊó∂Êõ¥Êñ∞.**

// TODO ÊúâÂæÖËØÅÂÆû

‰ΩÜÊòØÂÆûÈôÖÁöÑÊÉÖÂÜµË¶ÅÊõ¥‰∏∫Â§çÊùÇ‰∏Ä‰∫õ "‰ªªÂä°ÈòüÂàó" ÂÆûÈôÖ‰∏äÊúâÂ§ö‰∏™, Ê∏≤ÊüìÊòØ‰∏Ä‰∏™Â§çÊùÇÁöÑËøáÁ®ãÂÆÉÊúâËá™Â∑±ÁöÑ‰ªªÂä°ÈòüÂàó, ‰ΩÜÊòØ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÊâßË°åÈ°∫Â∫è‰æùÁÑ∂ÊòØÈÄöËøá "‰∫ã‰ª∂Âæ™ÁéØ" Êù•ÂÜ≥ÂÆöÁöÑ, ÊâÄ‰ª•‰πãÂâçÊèêÂà∞ÁöÑÁêÜËß£ÊñπÂºèÂπ∂Ê≤°ÊúâÂ§™Â§ßÁöÑÈóÆÈ¢ò.

## ÊÄùËÄÉ

‰∏ãÂàó‰ª£Á†Å‰ºöÈÄ†ÊàêÈòªÂ°ûÂêó:

```javascript
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>test</title>
</head>
<body>
  <video src="https://vjs.zencdn.net/v/oceans.mp4" controls autoplay></video>
  <button id="button">while true</button>
  <script>
    function loop(){
      setTimeout(loop,0);
    }
    loop();
  </script>
</body>
</html>
```

ËøôÊÆµ‰ª£Á†Å‰∏ç‰ªÖ‰∏ç‰ºöÈÄ†ÊàêÈòªÂ°ûÁîöËá≥‰∏ç‰ºöÈÄ†ÊàêÊ†àÊ∫¢Âá∫, ÊØèÊ¨°Ë∞ÉÁî® `loop` ÂáΩÊï∞‰ºöÂêë "‰ªªÂä°ÈòüÂàó" Ê∑ªÂä†‰∏Ä‰∏™‰ªªÂä°ÁÑ∂Âêé `loop` Â∞±‰ºöË¢´ÂºπÂá∫Ë∞ÉÁî®Ê†à, Ê≠§Êó∂ÁöÑË∞ÉÁî®Ê†àÂ∞±Ë¢´Ê∏ÖÁ©∫‰∫Ü. ËÄåË¥üË¥£ÊéßÂà∂‰ªªÂä°ÈòüÂàóÁöÑ‰∫ã‰ª∂Âæ™ÁéØÂè™ÊúâÂú®Ë∞ÉÁî®Ê†à‰∏∫Á©∫ÁöÑÊó∂ÂÄôÊâçËÉΩÁªßÁª≠ÊâßË°å‰ªªÂä°, ‰πüÂ∞±ÊòØËØ¥Ë∞ÉÁî®Ê†àÊ∞∏Ëøú‰∏ç‰ºöÁ¥ØÂä†.

ÂÖ∂Ê¨°‰ªªÂä°ÁöÑÊâßË°åÂπ∂‰∏çÂΩ±Âêë‰ªªÂä°ÈòüÂàóÊ∑ªÂä†ÂÜÖÂÆπ, Âú®Ë∞ÉÁî® `setTimeout(loop,0)` Âêé "‰∫ã‰ª∂Âæ™ÁéØ" ÁªßÁª≠Â∑•‰ΩúÂ§ÑÁêÜÈÇ£‰∫õÂ∑≤ÁªèË¢´Â°´ÂÖ•Âà∞‰ªªÂä°ÈòüÂàó‰∏≠Âú®Ê≠§‰πãÂâçÁöÑÂ°´ÂÖ•ÁöÑÂÖ∂‰ªñ‰∫ã‰ª∂‰ª•ÂèäÈ°µÈù¢ÁöÑÊ∏≤Êüì, Áõ¥Âà∞ "‰ªªÂä°ÈòüÂàó" ‰∏≠ÂÜçÊ¨°ÊâßË°åÊúâÂÖ≥ `loop` ÁöÑ‰ªªÂä°.

## ÊµÅÁïÖÁöÑÊ∏≤Êüì

ËØïÊÉ≥‰∏Ä‰∏ã‰Ω†Âú®È°µÈù¢‰∏äÂà∂‰Ωú‰∫Ü‰∏Ä‰∏™Âä®ÁîªÊïàÊûú‰ΩøÁî®Â¶Ç‰∏ã‰ª£Á†Å:

```javascript
function animate(){
  // ‰øÆÊîπÊ†∑Âºè
}

setInterval(animate,1000/60);
```

‰Ω†Â∏åÊúõÂä®ÁîªÂèØ‰ª•ËææÂà∞ 60fps ÊâÄ‰ª•Âêë `setInterval` ‰º†ÂÖ•‰∫Ü `1000/60` ÊúüÂæÖÂÆÉÂèØ‰ª•ÊØèÁßíÊâßË°å 60 Ê¨°Âä®ÁîªÂáΩÊï∞.

‰ΩÜÊòØÁî±‰∫é `setInterval` Âπ∂‰∏çÁ≤æÁ°ÆÂú®‰∏ÄÂ∏ß‰∏≠ÂèØËÉΩÊâßË°å‰∫ÜÂ§öÊ≠§, ‰πüÂèØËÉΩ‰∏ÄÊ¨°‰πüÊ≤°ÊúâÊâßË°å, ÊàñËÄÖÊâßË°å‰∫Ü‰∏Ä‰∏™ËÄóÊó∂ÁöÑ‰ªªÂä°ÂØºËá¥ÊµèËßàÂô®Êó†Ê≥ïÂú®‰∏ÄÂ∏ß‰∏≠ËøõË°åÊ∏≤ÊüìÊìç‰Ωú.

Êàë‰ª¨Â∏åÊúõÊØè‰∏ÄÂ∏ß‰∏≠Ëá≥Â∞ëÊúâ‰∏ÄÊ¨°Ê∏≤ÊüìËøáÁ®ã, ‰ΩÜÊòØ‰ªªÂä°ÁöÑÊâßË°åÊòØÈöèÊú∫ÁöÑ‰ªªÂä°ÊâßË°å‰ºöÊâì‰π±ÂéüÊúâËßÑÂæãÁöÑÊ∏≤ÊüìËøáÁ®ã:

![1566277658471](C:\Users\zhao\Documents\library\article\assets\1566277658471.png)

ËÄåÊµèËßàÂô®Êú¨Ë∫´ÁöÑÊ∏≤ÊüìÂÆûÈôÖ‰∏äÊòØÈùûÂ∏∏Êô∫ËÉΩÂíåËäÇÁ∫¶ËÆ°ÁÆóÁöÑ, ‰æãÂ¶ÇÈ°µÈù¢Ê∏≤ÊüìÈ¢ëÁéáËá™Âä®ÂíåÂ±èÂπïÂà∑Êñ∞ÁéáË∞ÉÊï¥Âà∞‰∏ÄËá¥, ÂΩìÈ°µÈù¢ÈùôÊ≠¢ÊàñËÄÖ‰∏çÂèØËßÜÁöÑÊó∂ÂÄôÈ°µÈù¢‰ºöÂÅúÊ≠¢Ê∏≤Êüì, ËÄå‰ΩøÁî® `setInterval` Á≠âÂæàÈöæÂÆåÁæéÁöÑÂíåÈ°µÈù¢Ê∏≤ÊüìËøáÁ®ãÁõ∏ÁªìÂêà.

‰∏Ä‰∏™Ëß£ÂÜ≥ÈóÆÈ¢òÁöÑÂäûÊ≥ïÂ∞±ÊòØ‰ΩøÁî® `requestAnimationFrame`.

> **window.requestAnimationFrame()** ÂëäËØâÊµèËßàÂô®‚Äî‚Äî‰Ω†Â∏åÊúõÊâßË°å‰∏Ä‰∏™Âä®ÁîªÔºåÂπ∂‰∏îË¶ÅÊ±ÇÊµèËßàÂô®Âú®‰∏ãÊ¨°ÈáçÁªò‰πãÂâçË∞ÉÁî®ÊåáÂÆöÁöÑÂõûË∞ÉÂáΩÊï∞Êõ¥Êñ∞Âä®Áîª

‰ΩøÁî® `requestAnimationFrame` Êàë‰ª¨ÂèØ‰ª•‰ΩøÁî®ÊµèËßàÂô®ÁöÑÊ∏≤ÊüìÈÄªËæëÂ∞ÜÂéüÊú¨ÊùÇ‰π±ÁöÑÊ∏≤ÊüìËøáÁ®ãÂèòÂæóÊúâÂ∫èËµ∑Êù•, ËÆ©ÊµèËßàÂô®ÂÜ≥ÂÆö‰ΩïÊó∂ËøõË°åÊ∏≤Êüì, ÂØπ‰∫éÂä®ÁîªÊ∏≤ÊüìËøôÂÜçÂ•Ω‰∏çËøá‰∫Ü, Áé∞Âú®ÊúâÂÖ≥Âä®ÁîªÁöÑ‰ªªÂä°ÈÉΩË¢´ÊéíÂàóÂà∞‰∫ÜÊ∏≤Êüì‰ªªÂä°ÁöÑÂâçÈù¢:

![1566279040998](C:\Users\zhao\Documents\library\article\assets\1566279040998.png)

## ÂæÆ‰ªªÂä° (micro task)

ÂæÆ‰ªªÂä°ÊòØ‰∏Ä‰∏™Â§çÊùÇÁöÑÊ¶ÇÂøµÂæàÂ§ö‰∫∫‰∏çÁêÜËß£ÂÖ∂Ë°å‰∏∫, Êàë‰ª¨‰ªéÂæÆ‰ªªÂä°ÁöÑËÆæËÆ°ÁõÆÁöÑ‰∏äÊù•Ëß£ÈáäÂæÆ‰ªªÂä°ÁöÑÂ∑•‰ΩúÂéüÁêÜ.

Âæà‰πÖÂâçW3CÁªôÊµèËßàÂô®Âà∂ÂÆö‰∫Ü‰∏Ä‰∫õAPI, Ëøô‰∫õAPIÁî®‰∫éÁõëÂê¨DOMÁöÑÂèòÂåñ:

```javascript
element.addEventListener("DOMNodeInserted", function (ev) {
  // ...
}, false);
```

‰ΩÜÊòØËøô‰∏™APIÊúâÁùÄ‰∏•ÈáçÁöÑÊÄßËÉΩÈóÆÈ¢ò, Âè™Ë¶Å‰øÆÊîπÂÖÉÁ¥†ÁöÑÂ±ûÊÄßÂØπÂ∫îÁöÑ‰∫ã‰ª∂Â∞±‰ºöË¢´Ëß¶Âèë, ÂØπÂêå‰∏Ä‰∏™Â±ûÊÄß‰øÆÊîπ100Ê¨°Â∞±‰ºöËß¶Âèë100Ê¨°ÁöÑ‰∫ã‰ª∂, Âè¶Â§ñ‰∫ã‰ª∂ÂÖ∑ÊúâÂÜíÊ≥°ÁöÑÁâπÊÄßÂ≠êÂÖÉÁ¥†ÁöÑ‰øÆÊîπ‰πü‰ºöÂØºËá¥Áà∂ÂÖÉÁ¥†Ëß¶ÂèëËØ•‰∫ã‰ª∂:

```javascript
let i = 100;
while(i--){
  const span = document.createElement('span');
  element.appendChild(span); // Ëß¶Âèë‰∫ã‰ª∂‰∏ÄÊ¨°
  span.textContent = 'Test'; // ÂÜçÊ¨°Ëß¶Âèë‰∫ã‰ª∂‰∏ÄÊ¨°
}
```

ÁªìÊûúÂ∞±ÊòØÊó†ËÆ∫‰Ω†Âú® `DOMNodeInserted` ÂõûË∞É‰∏≠ÂÜôÂ§ö‰πàÁÆÄÂçïÁöÑ‰ª£Á†Å, Â§çÊùÇÁöÑDOMÊìç‰ΩúÂØºËá¥‰∫ã‰ª∂Â∞±‰ºöË¢´ÂØÜÈõÜË∞ÉÁî®Â§ßÂ§ßÈôç‰ΩéÊÄßËÉΩ, ÊâÄ‰ª•Ëøô‰∏™APIË¢´Â∫üÂºÉ‰∫Ü.

ÁõëÂê¨DOM‰øÆÊîπÁöÑÈúÄÊ±Ç‰æùÁÑ∂Â≠òÂú®, ‰ΩÜÊòØÊàë‰ª¨Â∏åÊúõËøô‰∏™Êé•Âè£ÁöÑË°®Áé∞Â∞±ÂíåÊ∏≤Êüì‰∏ÄÊ†∑Â∞ÜDOM‰øÆÊîπËøõË°åÂêàÂπ∂ÂêéÂè™Ëß¶Âèë‰∏ÄÊ¨°, Ëøô‰∏™ËßÑËåÉÂú®DOM3‰∏≠Ë¢´Êé®Âá∫‰ªñÂ∞±ÊòØ [`MutationObserver`](https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver), ‰ªéËÄåÂºïÂÖ•‰∫Ü "ÂæÆ‰ªªÂä°" Âíå "ÂæÆ‰ªªÂä°ÈòüÂàó" Ëøô‰∏™Ê¶ÇÂøµ.

ÂæÆ‰ªªÂä°ÊòØÂºÇÊ≠•ÁöÑÊàë‰ª¨Áî®‰∏™ `Promise` Êù•‰∏æ‰æã:

```javascript
Promise.resolve().then(()=>console.log('hello world'));
console.log('foobar');
```

ËæìÂá∫:

```
foobar
hello world
```

`foobar` ÂÖà‰∫é `hello world` ËæìÂá∫ËøôÁÇπËØÅÊòé‰∫ÜÂÆÉ. ËôΩÁÑ∂‰ªñÊòØÂºÇÊ≠•ÁöÑ‰ΩÜËøô‰∏ç‰ª£Ë°®‰ªñÂøÖÈ°ªÈÅµÂæ™ "‰∫ã‰ª∂Âæ™ÁéØ" Âíå "Ê∏≤Êüì" Âà∂ÂÆöÁöÑËßÑÂàô. Áõ∏Âèç "ÂæÆ‰ªªÂä°" ÊúâËá™Â∑±ÁöÑÁé©Ê≥ï.

‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑÁâπÂæÅÂ∞±ÊòØ**Âè™ÊúâÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫ÂêéÂæÆ‰ªªÂä°ÊâçÁÆóÊâßË°åÂÆåÊàê**, Êàë‰ª¨Êää‰πãÂâçÁöÑ "‰∫ã‰ª∂Âæ™ÁéØ" ‰æãÂ≠êÊîπ‰∏∫ÂæÆ‰ªªÂä°ÁâàÊú¨:

```javascript
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>test</title>
</head>
<body>
  <video src="https://vjs.zencdn.net/v/oceans.mp4" controls autoplay></video>
  <button id="button">while true</button>
  <script>
    document.getElementById('button').addEventListener('click',()=>{
      function loop(){
          Promise.resolve().then(loop);
      }
      loop();
    });
  </script>
</body>
</html>
```

ÁªìÊûúÂ∞±ÊòØÂΩìÁÇπÂáªÊåâÈíÆÂêéÈ°µÈù¢Ê∏≤Êüì‰ºöÂÅúÊ≠¢ÊµèËßàÂô®ËøõÂÖ•Âà∞ÈòªÂ°û‰∏≠, ÂéüÂõ†ÂæàÁÆÄÂçï "ÂæÆ‰ªªÂä°ÈòüÂàó" ‰∏≠Ê∞∏ËøúÊúâ‰ªªÂä°ÊâÄ‰ª•ÊµèËßàÂô®‰∏ÄÁõ¥Âú®Á≠âÂæÖ "ÂæÆ‰ªªÂä°ÈòüÂàó" Ê∏ÖÁ©∫ÁÑ∂Âêé‰∏ÄÁõ¥ÊâßË°åÂæÆ‰ªªÂä°, ‰∏çÂπ∏ÁöÑÊòØËøôÊòØ‰∏Ä‰∏™Êó†Â∞ΩÁöÑ‰ªªÂä°ÈòüÂàóÊâÄ‰ª•ÂÆÉÊ∞∏ËøúÊó†Ê≥ïÊâßË°åÂÆå.

ÂæÆ‰ªªÂä°ÁöÑÂè¶Â§ñ‰∏Ä‰∏™ÁâπÊÄßÂ∞±ÊòØ **JavaScript Ë∞ÉÁî®Ê†à‰∏ÄÊó¶Ë¢´Ê∏ÖÁ©∫, ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÊâßË°å‰ºöÂÖà‰∫éÂÖ∂‰ªñÈòüÂàó**, ËØ∑ËßÇÂØü‰∏ãÈù¢ÁöÑ‰æãÂ≠ê:

```javascript
const button = document.getElementById('button');

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 1'));
	console.log('task 1');
});

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 2'));
	console.log('task 2');
});
```

ÁÇπÂáªÊåâÈíÆÂêéËæìÂá∫È°∫Â∫è:

```
task 1
Microtask 1
task 2
Microtask 2
```

ÊåâÈíÆÁÇπÂáªÂêéÁöÑÊâßË°åÊµÅÁ®ãÂ¶Ç‰∏ã:

1. "‰∫ã‰ª∂Âæ™ÁéØ" Â∞ÜÁ¨¨‰∏Ä‰∏™ÁÇπÂáª‰∫ã‰ª∂‰∏≠ÁöÑÂåøÂêçÂáΩÊï∞ÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä°
   2. ÊâßË°å `console.log('task 1')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
   4. ÊâßË°åÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°
   5. ÊâßË°å `console.log('Microtask 1')`
   6. ÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫
2. "‰∫ã‰ª∂Âæ™ÁéØ" Â∞ÜÁ¨¨‰∫å‰∏™ÁÇπÂáª‰∫ã‰ª∂‰∏≠ÁöÑÂåøÂêçÂáΩÊï∞ÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä°
   2. ÊâßË°å `console.log('task 2')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
   4. ÊâßË°åÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°
   5. ÊâßË°å `console.log('Microtask 2')`
   6. ÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫

‰∏çËøáÂ¶ÇÊûúË¶ÅÊääËøô‰∏™‰æãÂ≠êÁ®çÁ®ç‰øÆÊîπ‰∏Ä‰∏ãÊÉÖÂÜµÂç¥Áï•Êúâ‰∏çÂêå:

```javascript
const button = document.createElement('button');

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 1'));
	console.log('task 1');
});

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 2'));
	console.log('task 2');
});

button.click();
```

ËøôÊ¨°Êàë‰ª¨ÊâãÂä®Ëß¶Âèë `click` ‰∫ã‰ª∂, ËæìÂá∫ÁªìÊûúÂ¶Ç‰∏ã:

```
task 1
task 2
Microtask 1
Microtask 2
```

ËøôÊ¨°ÁöÑÊâßË°åÊµÅÁ®ã‰∏∫:

1. `button.click()` Ë¢´ÂéãÂÖ•Ë∞ÉÁî®Ê†àÊâßË°å
2. ÂêåÊ≠•Ëß¶Âèë 'click' ‰∫ã‰ª∂Âπ∂Â∞ÜÁ¨¨‰∏Ä‰∏™‰∫ã‰ª∂ÂõûË∞ÉÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä° `console.log('Microtask 1')`
   2. ÊâßË°å `console.log('task 1')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
- **Ê≥®ÊÑè**: Ê≠§Êó∂ `button.click` Âπ∂Êú™ÊâßË°åÂÆåÊàêËøòÂú®Ë∞ÉÁî®Ê†à‰∏≠
3. ÂêåÊ≠•Ëß¶Âèë 'click' ‰∫ã‰ª∂Âπ∂Â∞ÜÁ¨¨‰∫å‰∏™‰∫ã‰ª∂ÂõûË∞ÉÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä° `console.log('Microtask 2')`
   2. ÊâßË°å `console.log('task 2')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
4. `button.click` ‰ªéË∞ÉÁî®Ê†à‰∏≠ÂºπÂá∫
5. Ê∏ÖÁ©∫ÂæÆ‰ªªÂä°ÈòüÂàó
6. ÊâßË°å `console.log('Microtask 1')`
7. ÊâßË°å `console.log('Microtask 2')`
8. ÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫

# Node.js ‰∏≠ÁöÑ‰∫ã‰ª∂Âæ™ÁéØ

> https://youtu.be/zphcsoSJMvM

## ËÆ°ÁÆóÊú∫Á∫øÁ®ãËøõÂåñÂè≤

ÂõûÂà∞ `ms-dos` Âíå `Apple os` ÁöÑÊó∂‰ª£ÈÇ£Êó∂ÂÄôÁöÑÊìç‰ΩúÁ≥ªÁªü‰ΩøÁî®ÂëΩ‰ª§Ë°åÁïåÈù¢, ËÆ°ÁÆóÊú∫CPUÂè™Êúâ‰∏Ä‰∏™Ê†∏ÂøÉ, Êìç‰ΩúÁ≥ªÁªüÂêå‰∏ÄÊó∂Èó¥‰∏ãÂè™ËÉΩÊâßË°å‰∏Ä‰ª∂‰∫ãÊÉÖ.ÈÄöËøáÊìç‰ΩúÁïåÈù¢ÂëäËØâÊìç‰ΩúÁ≥ªÁªü‰Ω†Ë¶ÅËøêË°å‰∏Ä‰∏™Â∫îÁî®Á®ãÂ∫è, Ê≠§Êó∂Á≥ªÁªü‰ºöÂÅúÊ≠¢ËøêË°åÂπ∂ËøêË°åÈÇ£‰∏™Á®ãÂ∫è, ÂΩìÂ∫îÁî®Á®ãÂ∫èÊâßË°åÂÆåÂêéÂèàÊääÊâßË°åÊùÉÂäõ‰∫§Áî±Êìç‰ΩúÁ≥ªÁªü.

ËøôÁßçËÆæËÆ°ÊúâÁùÄÈùûÂ∏∏Â§ßÁöÑÈôêÂà∂, ‰Ω†Êó†Ê≥ïÂêåÊó∂ÊâßË°åÂ§ö‰ª∂‰∫ãÊÉÖ, ‰∫éÊòØ‰∏ÄÁßçË¢´Áß∞‰ΩúÂçè‰ΩúÂ§ö‰ªªÂä°(cooperative multitasking)ÁöÑÊú∫Âà∂Âá∫Áé∞‰∫Ü. ËøôÁßçËÆæËÆ°‰∏ã‰Ω†ÂèØ‰ª•ÂêåÊó∂ËøêË°åÂ§ö‰∏™Á®ãÂ∫è.

‰ΩÜÊòØËøôÁßçÊú∫Âà∂Âá∫Áé∞ÂêéË°®Áé∞ÂêÑÂ§ßÊìç‰ΩúÁ≥ªÁªüÁöÑÂÆûÁé∞‰πü‰∏çÊòØÂçÅÂàÜÂÆåÁæé, Âú®ÂΩìÊó∂ÁöÑ `Mac OS` Âíå `windows` Êìç‰ΩúÁ≥ªÁªü‰∏≠ËøôÁßçÂ§öÁ®ãÂ∫èÊâßË°åÁöÑÂÆûÁé∞‰∫§Áî±Â∫îÁî®Á®ãÂ∫èÂÜ≥ÂÆö, Â¶ÇÊûúÁ®ãÂ∫èÊ≤°ÊúâÁºñÂÜôÂØπÂ∫îÁöÑ‰ª£Á†ÅÈÇ£‰πàËøô‰∏™Á®ãÂ∫è‰ºö‰∏ÄÁõ¥Âç†Áî®CPUËµÑÊ∫ê, Â¶ÇÊûú‰∏ÄÊó¶Á®ãÂ∫èÂ¥©Ê∫ÉÁîöËá≥‰ºöÁâµÊâØÂà∞Á≥ªÁªü, ÂØºËá¥Á≥ªÁªüÂ¥©Ê∫É.

ÂêéÊù•ËøôÁßçÊú∫Âà∂Ë¢´Êîπ‰∏∫‰∫ÜÊä¢Âç†ÂºèÂ§ö‰ªªÂä°(preemptive multitasking), ËøêË°åÂì™‰∏™Á®ãÂ∫èÁî±Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆö, Âú®ÂàáÊç¢Â∫îÁî®Á®ãÂ∫èÁöÑÊó∂ÂÄô‰ªñ‰ºöÊääÊ≠£Âú®ËøêË°å‰∏≠ÁöÑÁ®ãÂ∫èÊöÇÂÅúÁÑ∂Âêé‰øùÁïôÂÖ∂Áä∂ÊÄÅÂ≠òÂÇ®Âà∞ÂÖ∂‰ªñ‰ΩçÁΩÆ‰∏≠, ÁÑ∂ÂêéÂä†ËΩΩÂè¶Â§ñ‰∏Ä‰∏™Á®ãÂ∫è. ËøôÈ°πÊú∫Âà∂ÊúÄÂàùÂºïÁî®Âà∞‰∫ÜÈù¢ÂêëÊúçÂä°Âô®ÁöÑ Unix Á≥ªÁªü, Âú®ÈöèÂêéÁöÑÊó∂Èó¥ÈáåÊâçÂ∫îÁî®Âà∞‰∫Ü‰ΩøÁî® NT ÂÜÖÊ†∏ÁöÑ windows2000 ÂíåÂêåÊó∂ÊúüÁöÑ Mac OS 1004 ÁöÑ‰∏™‰∫∫ÁîµËÑë‰∏≠.

Ê≠§Êó∂AMDÂàöÂàöÂèëÂ∏É‰∫ÜÂÆÉÁöÑÂ§öÊ†∏CPU, ‰∏∫‰∫ÜÂÖÖÂàÜÂà©Áî®Â§öÊ†∏CPUÁöÑÊÄßËÉΩ, ÂùáË°°Â§öÁ∫øÁ®ã(symmetric multi threading)ÊäÄÊúØËØûÁîü‰∫Ü, ËØ•ÊäÄÊúØÁöÑÂÆûÈôÖÂ∫îÁî®Ë¢´ intel È¶ñÂÖàÈááÁî®Âπ∂ÈáçÊñ∞ÂëΩÂêç‰∏∫Ë∂ÖÁ∫øÁ®ã(hyper threading). ËØ•ÊäÄÊúØÁöÑ‰∏ªË¶ÅÂéüÁêÜÊòØ: CPUÂú®ÊâßË°å‰ªªÂä°ÁöÑÊó∂ÂÄôÂπ∂Èùû‰∏ÄÁõ¥Êª°ËΩΩÊâßË°å, ËøôÈáåÊúâÂæàÂ§öÁ©∫Èó≤ËµÑÊ∫êÂèØ‰ª•Âà©Áî®, ËÄåË∂ÖÁ∫øÁ®ãÂÖÅËÆ∏‰∏Ä‰∏™CPUÊ†∏ÂøÉÂèØ‰ª•ÂêåÊó∂Â§ÑÁêÜÂ§ö‰ª∂‰∫ãÊÉÖÂÖÖÂàÜÁöÑÂà©Áî®CPUÁ©∫Èó≤ËµÑÊ∫ê.

Âú®‰∏äÊñá‰∏≠Êàë‰ª¨ÊèêÂà∞‰∫Ü‰∏§‰∏™Âü∫Êú¨ÁöÑÊ¶ÇÂøµ "‰ªªÂä°" Âíå "Á∫øÁ®ã", ÂÆûÈôÖ‰∏ä‰ªªÂä°Â∞±ÊòØÊàë‰ª¨Â∏∏ËØ¥ÁöÑ "ËøõÁ®ã", Á∫øÁ®ãÂíåËøõÁ®ãÁöÑÊ¶ÇÂøµÊàë‰ª¨Â∞±Âú®ËøôÈáå‰∏çÊèê‰∫Ü, Êàë‰ª¨ÈúÄË¶ÅÊèêÂà∞ÁöÑ‰∏ÄÁÇπÂ∞±ÊòØÁ∫øÁ®ãÁöÑ "Á´ûÊÄÅ". Á∫øÁ®ãÁöÑÊâßË°åÊòØÂπ∂Ë°åÁöÑÁ∫øÁ®ãÈó¥ÂÖ±‰∫´ÂÜÖÂÆπ, ÂΩì‰∏§‰∏™Á∫øÁ®ãÊìç‰ΩúÂêå‰∏Ä‰∏™Êï∞ÊçÆÁöÑÊó∂ÂÄô‰ºöÂá∫Áé∞ËøôÁßçÈóÆÈ¢ò.

ÂÅáËÆæÊàë‰ª¨Êúâ‰∏§‰∏™Á∫øÁ®ãÁ∫øÁ®ãAÂêëÂÖ®Â±ÄÂèòÈáèÂÜôÂÖ•‰∏Ä‰∏™Êï∞ÊçÆ,Á∫øÁ®ãBËØªÂèñÂØπÂ∫îÁöÑÂÖ®Â±ÄÂèòÈáè,Áî±‰∫é‰∏§‰∏™Á∫øÁ®ãÈÉΩÊòØÂπ∂Ë°åÁöÑÊâÄ‰ª•Á∫øÁ®ãAÂèØËÉΩÂú®Á∫øÁ®ãBËØªÂèñÂâçËøõË°å‰∫ÜÂÜôÂÖ•, ‰πüÊúâÂèØËÉΩÁ∫øÁ®ãBÂÖàËØªÂèñÂêéÁ∫øÁ®ãAÂÜçÂÜôÂÖ•, ÊØèÊ¨°ËøêË°åÈÉΩ‰ºöÂæóÂà∞‰∏çÂêåÁöÑÁªìÊûú. ËøôËÆ©Á®ãÂ∫èÂÖÖÊª°‰∫Ü‰∏çÁ°ÆÂÆöÊÄß‰πü‰ºöÂØºËá¥ÂæàÂ§öbug, ËÆ∏Â§öËØ≠Ë®ÄÈÉΩÊèê‰æõ‰∫ÜÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÊìç‰ΩúÊù•ÈÅøÂÖçÈóÆÈ¢ò‰∏çËøáÂç≥‰ΩøÊòØÁªèÈ™å‰∏∞ÂØåÁöÑÁ®ãÂ∫èÂëòÂæÄÂæÄ‰πüÂæó‰ªîÁªÜÊÄùËÄÉÊâçËÉΩËÆæËÆ°Âá∫Á∫øÁ®ãÂÆâÂÖ®ÁöÑÁ®ãÂ∫è.

**ÂØπ‰∫éNodeÊù•ËØ¥Ëß£ÂÜ≥ÁöÑÊñπÂºèÈùûÂ∏∏ÁÆÄÂçïÁõ¥Êé•, Êàë‰ª¨‰ΩøÁî®ÂçïÁ∫øÁ®ãÊ®°Âûã, ‰∏çÂÖÅËÆ∏‰Ω†‰ΩøÁî®Â§öÁ∫øÁ®ãÊ®°Âûã(Node 11‰∏≠Ê∑ªÂä†‰∫ÜÂÆûÈ™å‰∏≠ÁöÑÂ§öÁ∫øÁ®ãÊîØÊåÅ).**

## Event loop

Node.js ÁöÑÂÆòÊñπÁΩëÁ´ô‰∏äÊúâ‰∏ÄÁØáËß£Èáä Event loop ÁöÑ[ÊñáÁ´†](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#the-node-js-event-loop-timers-and-process-nexttick), Êú¨Êù•ÊâìÁÆóÂÄüÁî®ÂÖ∂‰ªñ‰∫∫ÁöÑÁøªËØëÁöÑ‰∏çËøáÊ≤°Êúâ‰∏ÄÁØáÊòØÂéüÊ±ÅÂéüÂë≥ÁöÑÁâàÊú¨, Âè™Â•ΩËá™Â∑±Âä®Êâã‰∫Ü.

### ‰ªÄ‰πàÊòØ‰∫ã‰ª∂Âæ™ÁéØ

‰∫ã‰ª∂Âæ™ÁéØÂÖÅËÆ∏node.jsÊâßË°åÈùûÈòªÂ°ûI/OÊìç‰Ωú. ËôΩÁÑ∂ JavaScript ÊòØÂçïÁ∫øÁ®ãÁöÑ, ‰ΩÜÊòØ‰∫ã‰ª∂Âæ™ÁéØ‰ºöÂ∞ΩÂèØËÉΩÁöÑÂ∞ÜÊìç‰ΩúËΩ¨ÁßªÂà∞Á≥ªÁªüÂÜÖÊ†∏‰∏≠Êù•ÂÆåÊàê.

Áé∞‰ª£ÁöÑÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÈÉΩÊòØÂ§öÁ∫øÁ®ãÁöÑ, ÂÆÉ‰ª¨ÂèØ‰ª•Âú®ÂêéÂè∞Â§ÑÁêÜÂ§öÁßçÊìç‰Ωú. ‰∏ÄÊó¶Ëøô‰∫õÊìç‰ΩúÂÆåÊàê, Á≥ªÁªüÂÜÖÊ†∏‰ºöÈÄöÁü• Node.js ‰ª•‰æøÂ∞Ü‰∫ã‰ª∂ÂõûË∞ÉÊîæÂÖ•ËΩÆËØ¢ÈòüÂàó‰∏≠Á≠âÂæÖÊâßË°å. (Êàë‰ª¨‰ºöÂú®ÈöèÂêéÁöÑÂÜÖÂÆπËÆ®ËÆ∫ÂÆÉ‰ª¨ÁöÑÂÖ∑‰ΩìÂ∑•‰ΩúÁªÜËäÇ)

### Ëß£Êûê‰∫ã‰ª∂Âæ™ÁéØ

ÂΩì Node.js ÂêØÂä®ÁöÑÊó∂ÂÄô, ‰ªñ‰ºöÂàùÂßãÂåñ‰∫ã‰ª∂Âæ™ÁéØ, Â§ÑÁêÜËæìÂÖ•ÁöÑËÑöÊú¨ÂÜÖÂÆπ (ÊàñËÄÖËøõÂÖ• [REPL](https://nodejs.org/api/repl.html#repl_repl)), ËÑöÊú¨ÂèØËÉΩ‰ºöË∞ÉÁî®ÂºÇÊ≠•Êé•Âè£, ËÆæÁΩÆÂÆöÊó∂Âô®, ÊàñËÄÖË∞ÉÁî® `process.nextTick()`, ÁÑ∂ÂêéÂºÄÂßãÂ§ÑÁêÜ‰∫ã‰ª∂Âæ™ÁéØ.

‰∏ãÈù¢ÁöÑÁÆÄÂõæ‰∏≠Â±ïÁ§∫‰∫Ü‰∫ã‰ª∂Âæ™ÁéØÁöÑÊìç‰ΩúÊµÅÁ®ã:

```
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îå‚îÄ>‚îÇ        timers ËÆ°Êó∂Âô®   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îÇ     I/O callbacks     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îÇ     idle, prepare     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ   incoming:   ‚îÇ
‚îÇ  ‚îÇ         poll ËΩÆËØ¢      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  connections, ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ   data, etc.  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îÇ        check Ê£ÄÊü•      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚î§    close callbacks    ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

> ÊØè‰∏Ä‰∏™ÊñπÊ°Ü‰ª£Ë°®‰∫Ü‰∫ã‰ª∂Âæ™ÁéØ‰∏≠‰∏çÂêåÁöÑÈò∂ÊÆµ(‰∫ã‰ª∂Âæ™ÁéØ‰ºöÈáçÂ§çÊâßË°åËøô‰∫õÊ≠•È™§).

ÊØè‰∏Ä‰∏™Èò∂ÊÆµÈÉΩÊúâ FIFO ÈòüÂàóÁî®‰∫éÊâßË°å. ËôΩÁÑ∂‰∏çÂêåÁöÑÈòüÂàóÊâßË°åÊñπÂºè‰∏çÂêå, ÊÄªÁöÑÊù•Áúã, ÂΩì‰∫ã‰ª∂Âæ™ÁéØËøõÂÖ•ËØ•Èò∂ÊÆµÂêé‰ºöÊâßË°åËØ•Èò∂ÊÆµÁöÑÊâÄÊúâÁöÑÊìç‰Ωú, ÁÑ∂ÂêéË∞ÉÁî®ÂØπÂ∫îÁöÑÂõûË∞ÉÁõ¥Âà∞ÈòüÂàóËÄóÂ∞ΩÊàñËÄÖËææÂà∞‰∫ÜÂõûË∞ÉÊâßË°å‰∏äÈôê. Âú®Âà∞Ëææ‰∏äËø∞ÊÉÖÂÜµÂêé‰∫ã‰ª∂Âæ™ÁéØËøõÂÖ•‰∏ã‰∏ÄÈò∂ÊÆµ, ÁÑ∂ÂêéÁªßÁª≠ËøôÊ†∑ÁöÑÊµÅÁ®ã.

Áî±‰∫éÂçï‰∏™Êìç‰ΩúÁöÑÊâßË°åÂèØËÉΩ‰ºö‰∫ßÁîüÈ¢ùÂ§ñÁöÑÊìç‰Ωú‰ª•ÂèäÂú®ËΩÆËØ¢Èò∂ÊÆµ‰∫ßÁîüÁöÑÊñ∞‰∫ã‰ª∂‰ºöË¢´ÂÜÖÊ†∏ÊéíÈòü, Ëøô‰∫õÊñ∞ÁöÑÊìç‰Ωú‰ºöÂú®Â§ÑÁêÜËΩÆËØ¢‰∫ã‰ª∂ÁöÑÊó∂ÂÄôÊéíÈòü. Âõ†Ê≠§, ÊâßË°å‰∏Ä‰∏™ÈïøËÄóÊó∂ÁöÑÂõûË∞ÉÂèØ‰ª•Âú®ËΩÆËØ¢Èò∂ÊÆµË∂ÖÂá∫ÂÆöÊó∂Âô®ÁöÑÈòàÂÄº.

> *Windows and the Unix/Linux* Âπ≥Âè∞Áï•ÊúâÂ∑ÆÂà´, ‰ΩÜÊòØËøô‰∏çÂΩ±ÂìçÊàë‰ª¨ÁöÑËÆ®ËÆ∫. Êàë‰ª¨ÊúÄÂÖ≥ÂøÉÁöÑÊòØ Node.js ÂÆûÈôÖÊâßË°åÁöÑÈÇ£ÈÉ®ÂàÜ‰πüÂ∞±ÊòØ‰∏äÈù¢ÁöÑÂÜÖÂÆπ.

### Èò∂ÊÆµÊÄªËßà

- timer: Ê≠§Èò∂ÊÆµÊâßË°åÁî± `setTimeout()` Âíå `setInterval()` ËÆæÂÆöÁöÑÂõûË∞É.
- pending callbacks: ÊâßË°åË¢´Êé®ËøüÂà∞‰∏ã‰∏ÄËΩÆÂæ™ÁéØÁöÑ I/O ÂõûË∞É.
- idle, prepare: ‰ªÖÂÜÖÈÉ®‰ΩøÁî®.
- poll: Ëé∑ÂèñÊñ∞ÁöÑI/O‰∫ã‰ª∂; ÊâßË°å I/O ÂõûË∞É(Èô§‰∫Ü close ÂõûË∞É‰ª•Âèä timer ÂõûË∞ÉÂíå `setImmediate` ÂõûË∞ÉÈÉΩ‰ºöÂú®ËøôÈáåÊâßË°å), node‰ºöÂú®ÈÄÇÂΩìÊù°‰ª∂‰∏ãÂú®ËøôÈáåÈòªÂ°û.
- check: `setImmediate` ÂõûË∞ÉÂ∞Ü‰ºöÂú®Ê¨°ÊâßË°å.
- close callbacks: ‰∏Ä‰∫õÊâßË°åÂÖ≥Èó≠ÁöÑÂáΩÊï∞, ‰æãÂ¶Ç `socket.on('close', ...)`.

Node ‰ºöÂú®‰∏§Ê¨°‰∫ã‰ª∂Âæ™ÁéØÈó¥Ê£ÄÊü•ÊòØÂê¶Â≠òÂú® I/O Êìç‰ΩúÂíåÊàñËÄÖ timer, Â¶ÇÊûúÊ≤°ÊúâÂ∞±‰ºöÈÄÄÂá∫ÊâßË°å.

### ÂêÑÈò∂ÊÆµ‰∏≠ÁöÑÁªÜËäÇ

#### timer

timer ÊåáÂÆö‰∫ÜËøêË°åÂõûË∞ÉÁöÑÈòàÂÄºÊó∂Èó¥, ËÄå‰∏çÊòØ‰∫∫‰ª¨ÊâÄÊÉ≥ÁöÑÊâßË°åÊó∂Èó¥. ÂÆöÊó∂Âô®ÂõûË∞ÉÂ∞Ü‰ºöÂú®ÊåáÂÆöÁöÑÊó∂Èó¥Âà∞ËææÂêéÂ∞ΩÂø´ÁöÑÊâßË°å, ‰∏çËøá timer ÁöÑÊâßË°å‰ºöÂèóÂà∞Êìç‰ΩúÁ≥ªÁªüË∞ÉÂ∫¶ÂíåÂÖ∂‰ªñÂõûË∞ÉÊâßË°åÁöÑÂΩ±ÂìçË¢´Âª∂Âêé.

> ‰ªéÊäÄÊúØ‰∏äËÆ≤, ÂÜ≥ÂÆöÊòØÂê¶ÊâßË°å timer ÂõûË∞ÉÊòØÂú®ËΩÆËØ¢Èò∂ÊÆµÊéßÂà∂ÁöÑ, Âú® timer Èò∂ÊÆµÊâç‰ºöÊâßË°åËøô‰∫õÂõûË∞É.

‰∏æ‰æãÊù•ËØ¥, ‰Ω†Âà∂ÂÆö‰∫Ü‰∏Ä‰∏™Âª∂Êó∂ 100ms ÁöÑ timer, ÁÑ∂ÂêéÂºÇÊ≠•ËøõË°åËØªÂèñÊñá‰ª∂Ëä±Ë¥π‰∫Ü 95ms:

```javascript
const fs = require('fs');

function someAsyncOperation(callback) {
  // Assume this takes 95ms to complete
  fs.readFile('/path/to/file', callback);
}

const timeoutScheduled = Date.now();

setTimeout(() => {
  const delay = Date.now() - timeoutScheduled;

  console.log(`${delay}ms have passed since I was scheduled`);
}, 100);


// do someAsyncOperation which takes 95 ms to complete
someAsyncOperation(() => {
  const startCallback = Date.now();

  // do something that will take 10ms...
  while (Date.now() - startCallback < 10) {
    // do nothing
  }
});
```

ÂΩì‰∫ã‰ª∂Âæ™ÁéØËøõÂÖ•ËΩÆËØ¢ÈòüÂàóÂêé, Ê≠§Êó∂ÈòüÂàóÊòØÁ©∫ÁöÑ(`fs.readFile()` ËøòÊú™ÂÆåÊàê), Áé∞Âú®Êàë‰ª¨Á≠âÂæÖËÆ°Êó∂Âô®Âà∞ËææÊåáÂÆöÁöÑÈòàÂÄº. Ëøá‰∫Ü 95ms Âêé `fs.readFile` ËØªÂèñÂÆåÊØïÂπ∂‰∏îÊâßË°åÂõûË∞ÉÂÖ±Ëä±Ë¥π 10ms. ÂΩìÂõûË∞ÉÊâßË°åÂÆåÊàê, ËΩÆËØ¢ÈòüÂàó‰∏≠Ê≤°Êúâ‰ªª‰ΩïÂÜÖÂÆπ‰∫Ü, Ê≠§Êó∂‰∫ã‰ª∂Âæ™ÁéØ‰ºöÁúãÂà∞Â∑≤ÁªèÂà∞ËææÈòàÂÄºÁöÑ timer, ÁÑ∂ÂêéÂú® timerÈò∂ÊÆµÂéªÊâßË°åÂõûË∞É. ÊâÄ‰ª•Âú®Ëøô‰∏™‰æãÂ≠ê‰∏≠ÁöÑÂª∂Êó∂ÂáΩÊï∞‰ºöÂú® 105ms ÂêéÊâßË°å.

> ‰∏∫‰∫ÜÈò≤Ê≠¢‰∫ã‰ª∂Âæ™ÁéØË¢´ÈïøÊó∂Èó¥Á©∫ÁΩÆ,  [libuv](https://libuv.org/) Êúâ‰∏Ä‰∏™ÊúÄÂ§ßÈôêÂÄº(ÂèñÂÜ≥‰∫éÊìç‰ΩúÁ≥ªÁªü)Áî®‰∫éÈôêÂà∂ËΩÆËØ¢ÈòüÂàóÁöÑÊâßË°åÊ¨°Êï∞.

#### pending callbacks

Á≥ªÁªüÊìç‰Ωú‰æãÂ¶Ç: TCPÁ±ªÂûãÈîôËØØÊâßË°åÂõûË∞É‰ºöÂÆâÊéíÂú®Ëøô‰∏™Èò∂ÊÆµÊâßË°å. ‰æãÂ¶ÇÂΩìÂ∞ùËØï TCP ËøûÊé•ÁöÑÊó∂ÂÄôÊé•Êî∂Âà∞‰∫Ü‰∏Ä‰∏™ `ECONNREFUSED` ÈîôËØØ, Êúâ‰∫õ *nix Á≥ªÁªü‰ºöËøõË°åÁ≠âÂæÖËÄå‰∏çÊòØÁ´ãÂç≥ÊäõÂá∫ÈîôËØØ. Ëøô‰∫õÂõûË∞É‰ºöË¢´Ê∑ªÂä†Âà∞ÈòüÂàó‰∏≠Âú® `pending callbacks` Èò∂ÊÆµÊâßË°å.

#### poll

Âú®Ëøô‰∏™Èò∂ÊÆµ‰∏≠‰∏ªË¶ÅÂÆåÊàê‰∏§‰∏™ÂäüËÉΩ:

1. ËÆ°ÁÆóË¢´ÈòªÂ°ûÂíåËΩÆËØ¢ I/O Ëä±Ë¥πÁöÑÊó∂Èó¥, ÁÑ∂Âêé
2. Â§ÑÁêÜËΩÆËØ¢ÈòüÂàó‰∏≠ÁöÑ‰∫ã‰ª∂

ÂΩì‰∫ã‰ª∂ËΩÆËØ¢Âà∞‰∫Ü poll Èò∂ÊÆµÁöÑÊó∂ÂÄôÂèëÁé∞Ê≤°ÊúâËÆ°Êó∂Âô®Âà∞ËææÈòàÂÄº, Ê≠§Êó∂‰ºöÂèëÁîü‰∏§ÁßçÊÉÖÂÜµ:

1. Â¶ÇÊûúËΩÆËØ¢ÈòüÂàó‰∏≠ÊúâÂÜÖÂÆπ, ‰∫ã‰ª∂Âæ™ÁéØ‰ºöÈÅçÂéÜËΩÆËØ¢ÈòüÂàóÁÑ∂ÂêéÈÄê‰∏™ÊâßË°åÂÜÖÈÉ®ÁöÑÂõûË∞É, Áõ¥Âà∞ÈòüÂàóÊ∏ÖÁ©∫ÊàñÊé•ËøëËΩÆËØ¢Èò∂ÊÆµÁöÑÂõûË∞ÉÊâßË°å‰∏äÈôê(‰∏äÈôêÂèñÂÜ≥‰∫éÊìç‰ΩúÁ≥ªÁªü).
2. Â¶ÇÊûúËΩÆËØ¢ÈòüÂàó‰∏∫Á©∫, Ê≠§Êó∂
   - Â¶ÇÊûúÂ≠òÂú® `setImmediate()` ‰ªªÂä°, ‰∫ã‰ª∂Âæ™ÁéØ‰ºöÁªìÊùüËΩÆËØ¢Èò∂ÊÆµÁõ¥Êé•Ë∑≥ÂÖ• check Èò∂ÊÆµÂéªÊâßË°åÈÇ£‰∫õ `setImmediate()` ‰ªªÂä°.
   - Â¶ÇÊûúÊ≤°ÊúâÈúÄË¶ÅÂ§ÑÁêÜÁöÑ `setImmediate()` ‰ªªÂä°, ‰∫ã‰ª∂Âæ™ÁéØ‰ºöÂú®ËΩÆËØ¢Èò∂ÊÆµÁ≠âÂæÖÊñ∞ÁöÑ‰ªªÂä°Ë¢´Ê∑ªÂä†Âà∞ËΩÆËØ¢ÈòüÂàó‰∏≠, ÁÑ∂ÂêéÁ´ãÂç≥Â§ÑÁêÜËøô‰∫õÊ∑ªÂä†ËøõÊù•ÁöÑ‰ªªÂä°.

ËΩÆËØ¢ÈòüÂàó‰∏∫Á©∫Âêé, ‰∫ã‰ª∂Âæ™ÁéØÂ∞ÜÊ£ÄÊü•Â∑≤ËææÂà∞Êó∂Èó¥ÈòàÂÄºÁöÑËÆ°Êó∂Âô®. Â¶ÇÊûú‰∏Ä‰∏™ÊàñËÄÖÂ§ö‰∏™ËÆ°Êó∂Âô®Âà∞ËææÈòàÂÄº, ‰∫ã‰ª∂Âæ™ÁéØ‰ºöÁßªÂä®Âà∞ timer Èò∂ÊÆµÁÑ∂ÂêéÊâßË°åÈÇ£‰∫õËÆ°Êó∂Âô®ÂõûË∞É.

#### check

Ëøô‰∏™Èò∂ÊÆµÂÖÅËÆ∏Âú®ËΩÆËØ¢ÂêéÁ´ãÂç≥ÊâßË°åÂõûË∞É. Â¶ÇÊûúËΩÆËØ¢Èò∂ÊÆµËøõÂÖ•Á≠âÂæÖ, Âπ∂‰∏îÊúâË¢´ `setImmediate()` ËÆæÂÆöÁöÑÂõûË∞É, ÈÇ£‰πà‰∫ã‰ª∂Âæ™ÁéØÊúâÂèØËÉΩ‰ºöÁßªÂä®Âà∞ check Èò∂ÊÆµËÄå‰∏çÊòØÁªßÁª≠Âú®ËΩÆËØ¢Èò∂ÊÆµÁ≠âÂæÖ.

`setImmediate()` ÂÆûÈôÖ‰∏äÊòØ‰∏Ä‰∏™ÁâπÊÆäÁöÑËÆ°Êó∂Âô®, Âú®‰∫ã‰ª∂Âæ™ÁéØÁöÑ‰∏Ä‰∏™ÂçïÁã¨Èò∂ÊÆµ‰∏≠ÊâßË°å. Âú®ËΩÆËØ¢Èò∂ÊÆµÂêéÊâßË°åÁöÑ check Èò∂ÊÆµÂõûË∞ÉÁöÑÊâßË°åÊòØÈÄöËøá `libuv` Êé•Âè£ËøêË°åÁöÑ.

## ‰∏çÊòØÂçïÁ∫øÁ®ãÁöÑ Node

JavaScript ÊòØÂçïÁ∫øÁ®ãÁöÑËøôÊ≤°ÊúâÈóÆÈ¢ò, Âõ†‰∏∫Âú® Node ‰∏≠ÊâÄÊúâÁöÑ "JavaScript ËÑöÊú¨", "V8 ÂºïÊìé", "‰∫ã‰ª∂Âæ™ÁéØ", ÈÉΩËøêË°åÂú®‰∏Ä‰∏™Á∫øÁ®ã‰∏≠Ëøô‰∏™Á∫øÁ®ãË¢´Áß∞‰∏∫ "‰∏ªÁ∫øÁ®ã".

**‰ΩÜÊòØËøô‰∏çÊÑèÂë≥ÁùÄ Node Êú¨Ë∫´ÊòØÂçïÁ∫øÁ®ãÁöÑÂõ†‰∏∫ Node ËøòÊúâÂÖ∂‰ªñÈÉ®ÂàÜ**. Node ÁöÑÊ∫êÁ†Å‰∏≠ËøòÂåÖÊã¨‰∫Ü C++ ‰ª£Á†Å, C++ÈÉ®ÂàÜÊã•ÊúâÊìç‰ΩúÁ∫øÁ®ãÁöÑËÉΩÂäõ, ËøôÂèñÂÜ≥‰∫é‰Ω†Ë∞ÉÁî® JavaScript APIÁöÑÊñπÂºè. ‰æãÂ¶ÇÂ¶ÇÊûú‰Ω†Ë∞ÉÁî®‰∫Ü‰∏Ä‰∏™ Node ÁöÑ API, Ëøô‰∏™ API ËÉåÂêéÊòØÁî± C++ ‰ª£Á†ÅÊèê‰æõÊîØÊåÅÁöÑ. Â¶ÇÊûú‰Ω†ÂêåÊ≠•ÁöÑË∞ÉÁî®ÈÇ£‰πà C++ ‰ª£Á†Å‰ºöÂú®‰∏ªÁ∫øÁ®ã‰∏äÊâßË°å. Â¶ÇÊûú‰Ω†Ë∞ÉÁî®‰∏Ä‰∏™ÂºÇÊ≠•ÁöÑ Node Êé•Âè£, ÈÇ£‰πà C++ ÊúâÂèØËÉΩ‰ºö‰ΩøÁî®È¢ùÂ§ñÁöÑÁ∫øÁ®ãÊù•ÊâßË°åËøô‰∏™‰ªªÂä°.

ÊâÄ‰ª•‰ΩøÁî®ÂêåÊ≠• API ÈÇ£‰πà Node Â∞±Ê≤°ÊúâÊú∫‰ºöÂà©Áî®Â§öÁ∫øÁ®ãÁöÑÂπ∂Ë°åËÆ°ÁÆóÁöÑÁâπÊÄßÊù•ÊèêÂçáÊÄßËÉΩ, ÊâÄ‰ª•Âú®‰ªª‰ΩïÊó∂ÂÄôÈÉΩÊé®Ëçê‰ΩøÁî®ÂºÇÊ≠•ÁöÑÊé•Âè£, ËøôÊ†∑ÂèØ‰ª•Âà©Áî® Node ÂÜÖÈÉ®ÁöÑÁ∫øÁ®ãÊú∫Âà∂ËøõË°å‰ºòÂåñÊâßË°åÊïàÁéá.

Âú®ÈªòËÆ§ÊÉÖÂÜµ‰∏ã Node ‰ºö‰ΩøÁî®Á∫øÁ®ãÊ±†Á∫øÁ®ãÊ±†ÁöÑÂÆπÈáè‰∏∫ 4 (ÂèØ‰ª•ÈÄöËøáÁéØÂ¢ÉÂèòÈáèËøõË°å‰øÆÊîπ), ÂΩìÈúÄË¶ÅÁ∫øÁ®ãÁöÑ‰ªªÂä°Ë∂ÖËøá4‰∏™Âêé, Node ‰ºöÂ∞Ü‰ªªÂä°ÊîæÂÖ•Âà∞‰ªªÂä°ÈòüÂàó‰∏≠. ‰∏ÄÊó¶Á©∫Èó≤Á∫øÁ®ãÂá∫Áé∞ Node ‰ºöÂ∞Ü‰ªªÂä°‰ªéÈòüÂàó‰∏≠ÂèñÂá∫ÊîæÂÖ•Âà∞Á∫øÁ®ã‰∏≠ÊâßË°å.

**ÂõæÁâá:**‰ΩøÁî®ÂëΩ‰ª§Ë°åÂêØÂä®ÁöÑ Node Â∞±‰ΩøÁî®‰∫Ü12‰∏™Á∫øÁ®ã:

![1566385151734](C:\Users\zhao\Documents\library\article\assets\1566385151734.png)

ËøòÊúâ‰∏Ä‰∫õÂºÇÊ≠•‰ªªÂä°‰∏çÂà©Áî®Á∫øÁ®ãÊ±†, ‰æãÂ¶Ç `http.request` ËÉåÂêé C++ ‰ºöÂ∞ΩÂèØËÉΩÁöÑË∞ÉÁî®ÂºÇÊ≠•Êé•Âè£Êù•Â∞Ü‰ªªÂä°ÂßîÊâòÁªôÊìç‰ΩúÁ≥ªÁªü, Âà©Áî®Á≥ªÁªüÊèê‰æõÁöÑÊé•Âè£ epoll(linux) kqueue(mac os), GetQueuedCompletionStatusEx(Windows).

‰∏ãÂàóÁöÑÂàóË°®‰∏≠‰æã‰∏æ‰∫ÜÂºÇÊ≠• API ËÉåÂêéÁöÑËøêË°åÊú∫Âà∂:

- Kernal Async
  - TCP/UDP servers and clients
  - pipes
  - dns.resolveXXX
- *NIX Only
  - UNIX domain sockets
  - TTY input
  - *NIX signals
  - Child Process
- Thread Pool
  - fs.*
  - dns.lookup
  - pipes(edge case)
- Windows Only
  - Child Process
  - TTY Input
  - TCP servers(edge cases)

Âú®Á∫øÁ®ãÁöÑ

## ÂçïÁ∫øÁ®ãÁöÑ Event Loop

ÂæàÂ§ö‰∫∫ËÆ§‰∏∫ Event loop ÊòØÁã¨Á´ãÁöÑÂÆÉËøêË°åÂú®‰∏Ä‰∏™ÂçïÁã¨ÁöÑÁ∫øÁ®ã‰∏≠, ‰ΩÜÊòØÂÆûÈôÖ‰∏ä Event Loop ‰Ωú‰∏∫ JavaScript ÈÉ®ÂàÜÁöÑÂÜÖÂÆπÊòØÂíå JavaScript ‰∏ÄÊ†∑ËøêË°åÂú®‰∏ªÁ∫øÁ®ã‰∏äÁöÑ.





# ÂºïÁî®

> https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/
>
> https://nodejs.org/dist/latest-v12.x/docs/api/worker_threads.html
>
> https://www.dynatrace.com/news/blog/all-you-need-to-know-to-really-understand-the-node-js-event-loop-and-its-metrics/#disqus_thread
>
> https://blog.csdn.net/Fundebug/article/details/86487117
>
> https://www.cnblogs.com/MuYunyun/p/7287413.html
>
> http://www.ruanyifeng.com/blog/2018/02/node-event-loop.html
>
> https://jsbin.com/dijodahawi/edit?html,css,js,console,output
>
> https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
>
> https://segmentfault.com/a/1190000019759283



