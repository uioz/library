# ÂâçË®Ä

‰∫ã‰ª∂Âæ™ÁéØ(event loop)ÊòØ‰∏Ä‰∏™Âú® JavaScript Â∏∏Ë¢´ÊèêËµ∑ÁöÑÊ¶ÇÂøµ, ÂÆÉÂ≠òÂú®‰∫éÊµèËßàÂô®‰πüÂ≠òÂú®‰∫é Node.js ‰∏≠, Âõ†‰∏∫ÂÆÉÂ§çÊùÇÁöÑËøêË°åÊú∫Âà∂‰ª§‰∫∫Èöæ‰ª•Áê¢Á£®, Êõ¥ÊòØÊàê‰∏∫Èù¢ËØïÊó∂ÂÄôÁöÑÂøÖËÄÉÈ¢òÁõÆ.

Êú¨ÁØáÊñáÁ´†ÁöÑÂÜÖÂÆπÊ∫êËá™ÊàëÂØπÁΩëÁªú‰∏äÁöÑ‰∏Ä‰∫õ‰ªãÁªç "‰∫ã‰ª∂Âæ™ÁéØ" ÁöÑÊºîËÆ≤ËßÜÈ¢ë‰∏≠ÂÜÖÂÆπÁöÑÊÄªÁªì, ÂÖ∂‰∏≠Â§ßÂ§öÊï∞Êù•Ëá™‰∫é `jsconf`. Âú®ÊØè‰∏ÄÁ´†‰∏≠ÊàëÈÉΩÈôÑ‰∏äÁöÑËßÜÈ¢ëÂú∞ÂùÄ, Âª∫ËÆÆ‰πãÈó¥Áõ¥Êé•ËßÇÁúãËßÜÈ¢ëÁõ∏‰∫éÊñáÂ≠óÊù•ËØ¥ËßÜÈ¢ëÊõ¥ÂÆπÊòìÁêÜËß£.

# ÊµèËßàÂô® - ‰∫ã‰ª∂Âæ™ÁéØÂàùÊé¢

> https://youtu.be/8aGhZQkoFbQ

## JavaScriptËøêË°åÁöÑÂü∫Êú¨ÊµÅÁ®ã

Êàë‰ª¨ÈÉΩÁü•ÈÅìJavaScriptÊòØ‰∏Ä‰∏™ÂçïÁ∫øÁ®ãÁöÑÁºñÁ®ãËØ≠Ë®Ä, ËøôÊÑèÂë≥ÁùÄÂÆÉÂè™ËÉΩÊúâ‰∏Ä‰∏™Ë∞ÉÁî®Ê†à, ÊâßË°åËøáÁ®ã‰∏≠ÊØèÊ¨°Âè™ËÉΩÂÅö‰∏Ä‰ª∂‰∫ãÊÉÖ.

‰∏∫‰∫ÜÂÖÖÂàÜÁêÜËß£, Êàë‰ª¨Êù•‰æã‰∏æ‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰æãÂ≠ê:

```javascript
function fun1() {
  return 'fun1'
}

function fun2() {
  return 'fun2' + fun1();
}

function fun3() {
  console.log(fun2());
}

fun3();
```

‰∏ÄÊó¶‰ª£Á†ÅÊâßË°åË∞ÉÁî®Ê†à‰∏≠ÂáΩÊï∞ÂéãÂÖ•ÁöÑÈ°∫Â∫èÂ¶Ç‰∏ã:

```
+----------+ +----------+ +----------+
|    stack | |    stack | |    stack |
|          | |          | |          |
|          | |          | |          |
|          | |          | | +------+ |
|          | |          | | | fun3 | |
|          | |          | | +------+ |
|          | |          | |          |
|          | | +------+ | | +------+ |
|          | | | fun2 | | | | fun2 | |
|          | | +------+ | | +------+ |
|          | |          | |          |
| +------+ | | +------+ | | +------+ |
| | fun1 | | | | fun1 | | | | fun1 | |
| +------+ | | +------+ | | +------+ |
|          | |          | |          |
+----------+ +----------+ +----------+
```

‰Ωç‰∫éÊ†àÈ°∂ÁöÑÂáΩÊï∞(fun3)ÊâßË°åÂÆåÊàêÂêéË∞ÉÁî®Ê†à‰ºöÊää‰ªñÂºπÂá∫:

```
+----------+ +----------+ +----------+
|    stack | |    stack | |    stack |
|          | |          | |          |
|          | |          | |          |
|          | |          | |          |
|   üí•     | |          | |          |
|          | |          | |          |
|          | |          | |          |
| +------+ | |          | |          |
| | fun2 | | |    üí•    | |          |
| +------+ | |          | |          |
|          | |          | |          |
| +------+ | | +------+ | |          |
| | fun1 | | | | fun1 | | |    ‚ú®    |
| +------+ | | +------+ | |          |
|          | |          | |          |
+----------+ +----------+ +----------+
```

Ë∞ÉÁî®Ê†àË¢´JavaScriptÂºïÊìé‰ΩøÁî®ÂíåÁõëËßÜ, ÊâÄ‰ª•ÂΩìÊàë‰ª¨Âú®ÂáΩÊï∞‰∏≠ÊäõÂá∫‰∫Ü‰∏Ä‰∏™ÈîôËØØ‰ΩÜÊòØÊ≤°ÊúâÂØπÂ∫îÁöÑ `try/catch` ËØ≠Âè•ÁöÑÊó∂ÂÄô:

```javascript
function fun1() {
  throw new Error('Warning: Nuclear Missile Launched') // ÊäõÂá∫‰∏Ä‰∏™ÈîôËØØ‰ΩÜÊòØÊ≤°ÊúâÂØπ‰∫éÁöÑ try/catch ËØ≠Âè•
}

function fun2() {
  return 'fun2' + fun1();
}

function fun3() {
  console.log(fun2());
}

fun3();
```

ÂèØ‰ª•Âú®ÊéßÂà∂Âè∞‰∏≠ÁöÑÊä•Èîô‰∏≠ÁúãÂà∞Ë∞ÉÁî®Ê†àÁöÑ‰ø°ÊÅØ:

![1566047594418](C:\Users\zhao\Documents\library\article\assets\1566047594418.png)

‰ΩÜÊòØË∞ÉÁî®Ê†à‰πüÊòØËÑÜÂº±ÁöÑÂ¶ÇÊûúÊàë‰ª¨ÂàõÂª∫‰∏Ä‰∏™Êó†Ê≥ï‰∏≠Êñ≠Ë∞ÉÁî®ÂáΩÊï∞, ÈÇ£‰πàË∞ÉÁî®Ê†à‰ºöÁû¨Èó¥ÁàÜÁÇ∏üí•ËøôÁßçË°å‰∏∫Ë¢´Áß∞‰∏∫ "Ê†àÊ∫¢Âá∫". ÂèØÂñúÂèØË¥∫ÁöÑÊòØJavaScript‰ºöÁõëËßÜË∞ÉÁî®Ê†à, ‰∏ÄÊó¶Ë∞ÉÁî®Ê†àÂá∫Áé∞ "Ê†àÊ∫¢Âá∫" JavaScript ‰ºöÁªàÊ≠¢‰ª£Á†ÅÁöÑÊâßË°åÂπ∂‰∏îÊäõÂá∫ÈîôËØØ:

```javascript
function foobar() {
	foobar();
}

foobar();
```

ÊäõÂá∫ "Ê†àÊ∫¢Âá∫" ÈîôËØØ:

![1566048013705](C:\Users\zhao\Documents\library\article\assets\1566048013705.png)

## ‰∫ÜËß£ "ÈòªÂ°û" ‰ª•ÂèäÂÆÉÁöÑÂç±ÂÆ≥

Âú® Web ÂºÄÂèë‰∏≠Êàë‰ª¨ÁªèÂ∏∏Ë¶Å‰ºöÂê¨Âà∞Ë¶ÅÈÅøÂÖçÊµèËßàÂô®ÈòªÂ°û, "ÈòªÂ°û" Ëøô‰∏™ËØçÊÑüËßâ‰∏äÊúâÁÇπÂÉèÊàë‰ª¨Â∏∏ËØ¥ÁöÑ "ÁîµËÑëÂç°‰Ωè‰∫Ü" ‰∏≠ÁöÑ "Âç°".

ÂÆûÈôÖ‰∏äÈòªÂ°ûÂπ∂Ê≤°Êúâ‰∏Ä‰∏™‰∏•Ê†ºÁöÑÂÆö‰πâ, JavaScript ÁöÑËøêË°åÈÄüÂ∫¶ÊòØÂæàÂø´ÁöÑ, ÊâßË°åÂá†‰∏™ÁÆÄÂçïÁöÑ "console.log" ‰Ω†Êó†Ê≥ï‰Ωì‰ºöÂà∞ËøôÂÖ∂‰∏≠ÊâÄËä±Ë¥πÁöÑÊó∂Èó¥, Â¶ÇÊûúË∞ÉÁî®Ê†à‰∏≠Ê≠£Âú®ÊâßË°åÁöÑÂáΩÊï∞Ëä±Ë¥π‰∫ÜÂ§ßÈáèÁöÑÊó∂Èó¥, Êàë‰ª¨ÊÑüËßâÊµèËßàÂô®Ë¢´Âç°‰Ωè‰∫Ü, ‰ΩìÈ™å‰∏çÊµÅÁïÖÊ≠§Êó∂Êàë‰ª¨ËØ¥, ÊµèËßàÂô®Ë¢´ÈòªÂ°û‰∫Ü.

‰ΩÜÊòØÊµèËßàÂô®‰∏ç‰ªÖ‰ªÖÊâßË°å JavaScript ‰ª£Á†ÅËøò‰ºöÂºÇÊ≠•ÁöÑÂä†ËΩΩÂ§ñÈÉ®ËµÑÊ∫êÊñá‰ª∂, Ëøô‰∫õÂä†ËΩΩÁöÑÊµÅÁ®ã‰πüÂèØ‰ª•Ë¢´ JavaScript ÊâÄÊéßÂà∂, ‰æãÂ¶ÇÊàë‰ª¨ÈÄöËøá JavaScript ÂèëËµ∑‰∏Ä‰∏™ÂêåÊ≠•ÁöÑÁΩëÁªúËØ∑Ê±Ç:

```javascript
var oReq = new XMLHttpRequest();
oReq.onload = function(){};
oReq.open("get", "https://xxx.com/", false); // false Ë°®Á§∫ÂêåÊ≠•ÂèëÈÄÅËØ∑Ê±Ç(ËøôÁßçÊñπÂºèÂ∑≤Áªè‰∏çÂú®Ë¢´Êé®Ëçê‰ΩøÁî®‰ªÖ‰ªÖÁî®‰∫éÁ§∫‰æã)
oReq.send();
alert('running!'); // Âè™ÊúâËØ∑Ê±ÇÂÆåÊàêÂêé alert Êâç‰ºöÊâßË°å
```

Ëøô‰∏™ËØ∑Ê±ÇÊúâÂèØËÉΩÈúÄË¶Å 20ms ÊàñËÄÖ 300ms ÁîöËá≥Êõ¥Èïø, Âú®ËØ∑Ê±ÇÁöÑËøáÁ®ã‰∏≠ÊµèËßàÂô®‰ºö‰∏ÄÁõ¥Á≠âÂæÖËØ∑Ê±ÇÂÆåÊàêÁîöËá≥‰ºöÂÅúÊ≠¢È°µÈù¢ÁöÑÊ∏≤Êüì, Êàë‰ª¨ÂèØ‰ª•ÊòéÊòæÁöÑÊÑüÂèóÂà∞ÊµèËßàÂô®Âç°‰Ωè‰∫Ü, ËøôÊòØÂÖ∏ÂûãÁöÑÈòªÂ°û.

## ÂºÇÊ≠•ÂõûË∞É

ÊµèËßàÂô®Â∞ÜÊâÄÊúâÂèØËÉΩËä±Ë¥πÂ§ßÈáèÊó∂Èó¥Á≠âÂæÖÁöÑÊìç‰ΩúÈÉΩÊèê‰æõ‰∫ÜÂØπÂ∫îÁöÑÂºÇÊ≠•Êé•Âè£, ËøôÁßçËß£ÂÜ≥ÊñπÂºèË¢´Áß∞‰∏∫ "ÂºÇÊ≠•ÂáΩÊï∞" ÊàñËÄÖ "ÂõûË∞ÉÂáΩÊï∞" ÊàñËÄÖ "ÂºÇÊ≠•ÂõûË∞É" Á≠â.

‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑ‰æãÂ≠êÂ¶Ç‰∏ã:

```javascript
console.log('hello');

setTimeout(function foobar(){
    console.log('delay');
},1000);

console.log('world');
```

Êàë‰ª¨ÈÉΩÁü•ÈÅìËøôÊÆµ‰ª£Á†Å‰ºöËæìÂá∫ÁöÑÈ°∫Â∫èÊòØ:

1. hello
2. world
3. delay

ÈÇ£‰πàÊµèËßàÂô®Âà∞Â∫ïÊòØÂ¶Ç‰ΩïËß£ÈáäËøôÊÆµ‰ª£Á†ÅÁöÑÂë¢, Êàë‰ª¨ÂèØ‰ª•ËßÇÂØüÊµèËßàÂô®ÁöÑË∞ÉÁî®Ê†à:

```javascript
console.log('hello'); // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('hello'); // ÊâßË°åÂÆåÊàêÊ†àÂºπÂá∫

setTimeout            // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
setTimeout            // ÊâßË°åÂÆåÊàêÊ†àÂºπÂá∫

console.log('world'); // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('world'); // ÊâßË°åÂÆåÊàêÊ†àÂºπÂá∫

// -------1000msËøáÂêé------

foobar                // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('delay'); // ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
console.log('delay'); // ÊâßË°åÂÆåÊàêÂºπÂá∫
foobar                // ÊâßË°åÂÆåÊàêÂºπÂá∫

```

ÊúÄÁ•ûÂ•áÁöÑ‰∫ãÊÉÖÂá∫Áé∞‰∫Ü `setTimeout` ÊâßË°åÂÆåÊàêÂêéÂ∞±Ë¢´Ë∞ÉÁî®Ê†àÂºπÂá∫‰∫Ü, ‰ΩÜÊòØ‰∏çÁü•‰ΩïÊïÖ 1000ms Âêé `setTimeout` ‰∏≠ÁöÑ `foobar` Ë¢´Á•ûÂ•áÁöÑÂî§ÈÜí‰∫Ü, ËøôÊòØÊÄé‰πàÂõû‰∫ã?

## webapi

Âú® JavaScript ‰∏≠ÊâßË°åÂÖÉÁ¥†ÁªëÂÆö‰∫ã‰ª∂, ‰ΩøÁî® `setTimeout` ËÆæÁΩÆ‰∏Ä‰∏™Âª∂Êó∂ÊâßË°å, ÊàñËÄÖÂèëËµ∑‰∏ÄÊ¨°ÁΩëÁªúËØ∑Ê±Ç. Ëøô‰∫õÈÉΩÊòØwebÂºÄÂèëËÄÖÁöÑÂÆ∂Â∏∏‰æøÈ•≠, ÂØπ‰∫éÊàë‰ª¨Êù•ËØ¥Ëøô‰∫õÂÜÖÂÆπÂ∞±ÊòØ JavaScript ÁöÑ‰∏ÄÈÉ®ÂàÜ‰∫Ü, ‰ΩÜÊòØÂÆûÈôÖ‰∏äËøô‰∫õÂÜÖÂÆπÂπ∂Ê≤°ÊúâÂú® ECMAScript Âà∂ÂÆöÁöÑÊ†áÂáÜ‰∏≠, ÂåÖÊã¨Êàë‰ª¨ËÆ®ËÆ∫ÁöÑ "‰∫ã‰ª∂Âæ™ÁéØ" Êú∫Âà∂ÂÆÉ‰πüÊ≤°ÊúâÂ≠òÂú®‰∫éËßÑËåÉ‰∏≠‰πüÂ∞±ÊòØËØ¥Ëøô‰∏™Êú∫Âà∂ÊòØÁã¨Á´ã‰∫é JavaScript ÂºïÊìéÁöÑÂäüËÉΩ.

Ëøô‰∫õAPIË¢´Áß∞‰∏∫ `webapi` ÂÆÉ‰ª¨ÊúâËá™Â∑±ÁöÑËßÑËåÉÂíåÂÆûÁé∞‰∏é JavaScript ËøôÈó®ËØ≠Ë®ÄÊ≤°ÊúâÂÖ≥Á≥ª, Âú®Ëøô‰ªΩÊù•Ëá™‰∫éMDNÁöÑ[È°µÈù¢‰∏ä](https://developer.mozilla.org/zh-CN/docs/Web/API)Âàó‰∏æ‰∫ÜÂ§ßÈÉ®ÂàÜÁöÑAPI.

## Âü∫Êú¨‰∫ã‰ª∂Âæ™ÁéØ

Êàë‰ª¨‰πãÂâçÊèêÂà∞‰∫Ü JavaScript Áî±‰∫éÂÖ∂ÂçïÁ∫øÁ®ãÁöÑÁâπÊÄßÂè™ËÉΩÂú®Âêå‰∏ÄÊó∂Èó¥ÊâßË°åÂêå‰∏ÄÈó¥‰∫ãÊÉÖ, ËøôÊòØÊ≠£Á°ÆÁöÑ, ‰ΩÜÊòØÊµèËßàÂô®‰∏ç‰ªÖ‰ªÖÊã•ÊúâËß£Èáä JavaScript ËÑöÊú¨ÁöÑÂºïÊìé, ËøòÊúâ‰∏ÄÂ†ÜÂÖ∂‰ªñÁöÑÁ®ãÂ∫èÊù•Â§ÑÁêÜËØ∏Â¶Ç `DOM` `XmlHttpRequest` `setTimeout` Ëøô‰∫õ‰ªªÂä°.

Ëøô‰∫õÁ®ãÂ∫èÂêÑÂè∏ÂÖ∂ËÅåÂÆåÊàêËá™Â∑±Ë¥üË¥£ÁöÑÈÉ®ÂàÜ, ÂÆÉ‰ª¨ÊòØÁã¨Á´ã‰∫é JavaScript ÂºïÊìé‰πãÂ§ñÁöÑÂÜÖÂÆπ, Ëøô‰∫õÁ®ãÂ∫èÂèØËÉΩËøêË°åÂú®Áã¨Á´ãÁ∫øÁ®ã‰∏äÊàñËÄÖËøõÁ®ã‰∏äÂÆÉ‰ª¨ÈÄöËøá`webapi` Êù•Âíå JavaScriptÂºïÊìéËøõË°åÈÄö‰ø°, ÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶ÅÈÄöËøá "ÂõûË∞É" ÁöÑÊñπÂºèËøõË°åÂºÇÊ≠•ÁºñÁ®ã.

ËÄå **‰∫ã‰ª∂Âæ™ÁéØ** Áî®‰∫éÁÆ°ÁêÜËøô‰∫õÂºÇÊ≠•‰ªªÂä°Âú®ÂêàÈÄÇÁöÑÊó∂Êú∫ÊâßË°å.

`setTimeout` ‰Ωú‰∏∫ `webapi` ÂÖ∏ÂûãÁöÑ‰æãÂ≠ê, Êàë‰ª¨Êù•ËßÇÂØü‰∏Ä‰∏ãÂÆÉÊòØÂ¶Ç‰ΩïËøêË°åÁöÑ, È¶ñÂÖà `setTimeout` ‰∏ÄÊó¶Ë¢´ÊâßË°å‰æøÂ∞ÜÂáΩÊï∞Èí©Â≠êÁßª‰∫§ÁªôÂØπÂ∫îÁöÑ `webapi` Âπ∂‰∏îÂºÄÂßãËÆ°Êó∂:

```
+--------------------------------+     +---------------------+
|                                |     |webapis              |
|                                |     | +----------------+  |
| setTimeout(function foobar() { |     | |                |  |
| 	console.log('delay')         | +-> | | timer-0 -- cb()|  |
| },0);                          |     | |                |  |
|                                |     | +----------------+  |
|                                |     |                     |
+--------------------------------+     +---------------------+
```

Áî±‰∫éÊàë‰ª¨ÁöÑÂÄíËÆ°Êó∂ÊòØ0, ÊâÄ‰ª•ËÆ°Êó∂‰ºöÁ´ãÂç≥ÂÆåÊàê, `webapi` Â∞ÜÂáΩÊï∞Èí©Â≠êÁßª‰∫§Áªô **‰ªªÂä°ÈòüÂàó** .

```
+--------------------------------+     +----------+
|                                |     |webapis   |
|                                |     |          |
| setTimeout(function foobar() { |     |          |
| 	console.log('delay')         |     |          | +-+
| },0);                          |     |          |   |
|                                |     |          |   |
|                                |     |          |   |
+--------------------------------+     +----------+   |
                                                      |
+-------------------------------------------------+   |
|                               task queue        |   |
| +--------------+                                |   |
| |              |                                |   |
| |    cb()      |                                | <-+
| |              |                                |
| +--------------+                                |
|                                                 |
+-------------------------------------------------+

```

Êé•‰∏ãÊù•Áªà‰∫éËΩÆÂà∞ **‰∫ã‰ª∂Âæ™ÁéØ** ‰∏äÂú∫‰∫Ü, ‰∫ã‰ª∂Âæ™ÁéØÂÆåÊàê‰∏Ä‰ª∂ÈùûÂ∏∏ÁÆÄÂçïÁöÑÂ∑•‰Ωú, ÂÆÉÂà§Êñ≠Â¶ÇÊûú:

1. Ë∞ÉÁî®Ê†àÊòØÁ©∫ÁöÑ
2. ‰ªªÂä°ÈòüÂàó‰∏≠Â≠òÂú®ÁùÄ‰ªªÂä°

ÈÇ£‰πàÂ∞±Â∞ÜËøô‰∏™‰ªªÂä°ÁßªÂÖ•Âà∞Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å:

```
+--------------------------------+ +------------------+
|                                | |           stack  |
|                                | | +--------------+ |
| setTimeout(function foobar() { | | |              | |
| 	console.log('delay')         | | |  cb - foobar | |
| },0);                          | | |              | |
|                                | | +--------+-----+ |
|                                | |          ^       |
+--------------------------------+ |          |       |
event loop ‚è≥                      |          |       |
+----+---------------------------+ |          |       |
|    |                           | |          |       |
|    |                           | |          |       |
|    +-- task ------> push -------------------+       |
|                                | |                  |
+--------------------------------+ +------------------+

```

ÁÑ∂ÂêéÂæÄÂ§çÂæ™ÁéØËøô‰∏™ËøáÁ®ã, ËøôÂ∞±ÊòØ‰∫ã‰ª∂Âæ™ÁéØÁöÑÂü∫Êú¨ÊµÅÁ®ã.

Áé∞Âú®Êàë‰ª¨Êù•ÊèêÂá∫‰∏Ä‰∏™ `ajax` ÁöÑ‰æãÂ≠ê, Â∞ùËØï‰∏Ä‰∏ã‰Ω†ËÉΩËØ¥Âá∫‰ªñÁöÑÊâßË°åÊµÅÁ®ãÂêó:

```javascript
console.log('hello');

$.get('https:www.google.com',function foobar(){ console.log('callback') });

console.log('world');
```

‰ªñÁöÑÊâßË°åÊµÅÁ®ãÂ¶Ç‰∏ã:

1. console.log('hello') --> ÂéãÂÖ•Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å
2. console.log('hello') --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
3. $.get --> ÂéãÂÖ•Ê†à‰∏≠ÊâßË°å
4. $.get --> Ë∞ÉÁî®‰∫Ü `webapi` ‰∏≠ÁöÑ `XHR` ÂèëËµ∑‰∫ÜÁΩëÁªúËØ∑Ê±Ç, Âπ∂‰øùÂ≠òÂÖ∂ÂáΩÊï∞Èí©Â≠ê
5. $.get --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
6. console.log('world') --> ÂéãÂÖ•Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å
7. console.log('world') --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
8. ÁΩëÁªúËØ∑Ê±ÇÂÆåÊàê `webapi` Â∞ÜÂáΩÊï∞Èí©Â≠êÁßªÂä®Âà∞‰ªªÂä°ÈòüÂàó‰∏≠
9. ‰∫ã‰ª∂Âæ™ÁéØ--> Ê£ÄÊü•Ë∞ÉÁî®Ê†àÊòØÂê¶‰∏∫Á©∫ Ê£ÄÊü•‰ªªÂä°ÈòüÂàó‰∏≠ÊòØÂê¶Êúâ‰ªªÂä° (‰∫ã‰ª∂Âæ™ÁéØ‰∏ÄÁõ¥Â≠òÂú®Âπ∂ÈùûÂú®Âè™Âú®Ê≠§ÂàªËøõË°åÊ£ÄÊü•)
   1. Ë∞ÉÁî®Ê†à‰∏∫Á©∫
   2. Ê£ÄÊü•Âà∞ËØ∑Ê±Ç‰ªªÂä°
   3. Â∞ÜËØ•‰ªªÂä°(foobarÂáΩÊï∞)ÂéãÂÖ•Âà∞Ë∞ÉÁî®Ê†à‰∏≠
10. console.log('callback') --> ÂéãÂÖ•Ë∞ÉÁî®Ê†à‰∏≠ÊâßË°å
11. console.log('callback') --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
12. foobar --> ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
13. Ë∞ÉÁî®Ê†àÂÜçÊ¨°Ê∏ÖÁ©∫

# ‰∫ã‰ª∂Âæ™ÁéØÂ¶Ç‰ΩïÂΩ±ÂìçÊ∏≤Êüì

> https://youtu.be/cCOL7MC4Pl0

Âú®‰∏ä‰∏ÄËäÇ‰∏≠Êàë‰ª¨ÊèêÂà∞‰∫Ü JavaScript ÊòØÂçïÁ∫øÁ®ãÁöÑÂ¶ÇÊûúËä±Ë¥πÂ§ßÈáèÁöÑÊó∂Èó¥ËøêË°å JavaScript ÈÇ£‰πàÂ∞±‰ºöÈòªÂ°ûÊµèËßàÂô®, ÂØºËá¥ÊµèËßàÂô®Êó†Ê≥ïÂÆåÊàêÂÖ∂‰ªñÂ∑•‰Ωú, Âπ∂‰∏îÂàùÊ¨°‰∫ÜËß£‰∫Ü "‰∫ã‰ª∂Âæ™ÁéØ" ÊòØÂ¶Ç‰ΩïËß£ÂÜ≥Ê≠§ÈóÆÈ¢òÁöÑ. Âú®Ëøô‰∏ÄËäÇ‰∏≠Êàë‰ª¨‰ºöÊõ¥Âä†‰∫ÜËß£Âè¶Â§ñ‰∏Ä‰∏™ËØùÈ¢ò "‰∫ã‰ª∂Âæ™ÁéØ" ‰∏éÈ°µÈù¢Ê∏≤Êüì‰πãÈó¥ÁöÑÂÖ≥Á≥ª.

ÂÆûÈôÖ‰∏ä‰∫ã‰ª∂Âæ™ÁéØÁöÑ‰ΩúÁî®ËåÉÂõ¥ÂèØËÉΩË∂Ö‰πé‰Ω†ÁöÑÊÉ≥Ë±°, ÊâÄÊúâÁöÑDOM‰∫ã‰ª∂ÂÆûÈôÖ‰∏äÈÉΩÊòØÂèóÂà∞‰∫Ü "‰∫ã‰ª∂Âæ™ÁéØ" ÊéßÂà∂ÁöÑ, Èô§Ê≠§‰ª•Â§ñËøòÂåÖÊã¨ÂåÖÊã¨ÁΩëÁªúËØ∑Ê±Ç, IOÊìç‰ΩúÁ≠âÁ≠â. Âõ†‰∏∫Âú®ËÉåÂêéËøô‰∫õ‰∫ã‰ª∂ÁöÑËß¶ÂèëËÄÖÂÆûÈôÖ‰∏äÈÉΩÊòØÂ∞Ü‰∏é‰∫ã‰ª∂ÊúâÂÖ≥ÁöÑ‰ø°ÊÅØÊîæÂÖ•Âà∞‰∫Ü "‰ªªÂä°ÈòüÂàó" ‰∏≠ÁúüÊ≠£ËÆ©Ëøô‰∫õÂÜÖÂÆπË¢´ÊâßË°åÁöÑÂÆûÈôÖ‰∏äÊòØ "‰∫ã‰ª∂Âæ™ÁéØ", ËøòËÆ∞Âæó "‰∫ã‰ª∂Âæ™ÁéØ" ÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÂêó? 

ÂΩì‰∏ãÂàóÊù°‰ª∂ÊàêÁ´ãÊó∂, "‰∫ã‰ª∂Âæ™ÁéØ" ‰ºöÂ∞ÜÊúÄËøëÁöÑ‰ªªÂä°ÁßªÈÄÅÂà∞ "Ë∞ÉÁî®Ê†à" ‰∏≠:

1. ‰ªªÂä°ÈòüÂàó‰∏≠Âê´Êúâ‰ªªÂä°
2. Ë∞ÉÁî®Ê†à‰∏∫Á©∫

‰ΩÜÊòØÊµèËßàÂô®‰∏ç‰ªÖÂèØ‰ª•ÊâßË°å JavaScript Ëøò‰ºöÂèØ‰ª•Â§ÑÁêÜÈ°µÈù¢Ê∏≤Êüì, Êàë‰ª¨Áü•ÈÅìÂ¶ÇÊûúËøõË°åÂ§ßÈáèÁöÑ JavaScript ËÆ°ÁÆó‰ºöÈòªÂ°ûÈ°µÈù¢Ê∏≤Êüì, ËøôÈáåÂà∞Â∫ïÊúâ‰ΩïÁßçËÅîÁ≥ª? Âú®Ê≠§‰πãÂâçÊàë‰ª¨ÂÖàÊù•‰∫ÜËß£‰∏Ä‰∏ãÂü∫Êú¨ÁöÑÊ∏≤ÊüìÊ¶ÇÂøµ.

## Âü∫Êú¨ÁöÑÊ∏≤Êüì

Êàë‰ª¨Âú®È°µÈù¢‰∏≠Âä®ÊÄÅÁöÑ‰øÆÊîπÊ†∑ÂºèÁïåÈù¢Êàë‰ª¨ÂèØ‰ª•ÁúãÂà∞ÂÆûÊó∂ÁöÑÊïàÊûú, ÊâÄ‰ª•ÁªôÊàë‰ª¨‰∏ÄÁßç‰øÆÊîπÊ†∑ÂºèÊòØÂêåÊ≠•ÁöÑÊìç‰ΩúÁöÑÈîôËßâ, ÂÆûÈôÖ‰∏äÊµèËßàÂô®Âú®ËÉåÂêéËøõË°å‰∫Ü‰ºòÂåñ, ÈáçÂ§çÂ§öÊ≠§ÁöÑÊ†∑ÂºèÊìç‰Ωú‰ºöË¢´ËøõË°åÂêàÂπ∂ÁÑ∂ÂêéÁî±ÊµèËßàÂô®ÂÜ≥ÂÆö‰∏Ä‰∏™ÂêàÈÄÇÁöÑÊó∂Êú∫ÁÑ∂ÂêéÁªü‰∏ÄÊõ¥Êñ∞: 

```javascript
element.style.transition = "transform 1s";
element.style.transform = "translateX(100px)";
element.style.transform = "translateX(500px)";
```

Â∫îÁî®‰∫ÜÊ†∑ÂºèÁöÑÂÖÉÁ¥†Âπ∂‰∏ç‰ºöÊ®™ÂêëÂú® 100px Âíå 500px ‰πãÈó¥Êù•ÂõûÁßªÂä®ËÄåÊòØÁõ¥Êé•ÁßªÂä®Âà∞‰∫Ü 500px, ÊµèËßàÂô®ÊäõÂºÉ‰∫ÜÊóßÁöÑÊó†Áî®ÁöÑÊ†∑Âºè‰øÆÊîπ.

ÊâÄ‰ª•ËØ¥‰øÆÊîπÊ†∑ÂºèÂπ∂‰∏çÊòØÂÆûÊó∂ÁöÑ, ËøôÁßçÊâπÈáèÊõ¥Êñ∞Ê†∑ÂºèÁöÑÊú∫Âà∂ÂØºËá¥ÂÆÉÂíå "‰∫ã‰ª∂Âæ™ÁéØ" ‰πãÈó¥‰∫ßÁîü‰∫Ü‰∏Ä‰∫õÂæÆÂ¶ôÁöÑÂÖ≥ËÅî, Âú®‰∫ÜËß£Ëøô‰∫õÂÖ≥ËÅîÂâçÊàë‰ª¨ÂÖàÊù•‰∫ÜËß£‰∏Ä‰∏ãÊµèËßàÂô®ÁöÑÂü∫Êú¨Ê∏≤ÊüìÊú∫Âà∂.

ÂÖÉÁ¥†Ê†∑ÂºèÂÜ≥ÂÆöÊ∏≤ÊüìÁöÑÁªìÊûú, ‰ªé‰∏ÄÂ†Ü‰ª£Á†ÅËΩ¨‰∏∫ÂèØËßÜÂåñÁöÑÁïåÈù¢ÁªèÂéÜ‰∫ÜËÆ∏Â§öÁéØËäÇ, ËøôÈáåÊàë‰ª¨Êù•ÁÆÄÂçïÁöÑ‰∫ÜËß£‰∏Ä‰∏ãÂÖ∂‰∏≠ÁöÑÂá†‰∏™ÂÖ≥ÈîÆÊ≠•È™§:

1. ËÆ°ÁÆóÊ†∑Âºè - Êî∂ÈõÜ css ËÆ°ÁÆóÂ∫îÁî®Âà∞ÊØè‰∏™ÂÖÉÁ¥†‰∏äÁöÑÊ†∑Âºè
2. Â∏ÉÂ±Ä - Á°ÆÂÆöÈ°µÈù¢‰∏äÁöÑÂÖÉÁ¥†ÁöÑ‰ΩçÁΩÆ‰∏éÂ±ÇÂè†ÂÖ≥Á≥ª
3. ÁªòÂà∂ - ÂàõÂª∫ÂÆûÈôÖÁöÑÂÉèÁ¥†ÁªòÂà∂Âà∞È°µÈù¢‰∏ä

## Ë¢´Âä®ÁöÑÊ∏≤Êüì

Âú®‰∏ãÈù¢ÁöÑËøô‰∏™‰æãÂ≠ê‰∏≠‰ΩøÁî®‰∫Ü‰∏Ä‰∏™ `video` Êù•Ë°®Á§∫È°µÈù¢ËøõË°åÂä®ÊÄÅÁöÑÊåÅÁª≠ÁöÑÈ°µÈù¢Ê∏≤Êüì, Ëøô‰∫õÂµåÂÖ•ÁöÑÂÜÖÂÆπÂèØ‰ª•Âú®‰∏çÂèó JavaScript ÁöÑÂπ≤Êâ∞‰∏ãÂΩ±ÂìçÈ°µÈù¢ÁöÑÊòæÁ§∫, ÂΩìÁÇπÂáªÊåâÈíÆÁöÑÊó∂ÂÄô JavaScript ËøõÂÖ•Ê≠ªÂæ™ÁéØ:

```javascript
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>test</title>
</head>
<body>
  <video src="https://vjs.zencdn.net/v/oceans.mp4" controls autoplay></video>
  <button id="button">while true</button>
  <script>
    document.getElementById('button').addEventListener('click',()=>{
      while(true);
    });
  </script>
</body>
</html>
```

ÂΩìÊàë‰ª¨ÁÇπÂáª‰∫ÜÊåâÈíÆÁöÑÊó∂ÂÄô:

1. click ‰∫ã‰ª∂Ë¢´ÊîæÂÖ•Âà∞‰∫Ü‰ªªÂä°ÈòüÂàó‰∏≠
2. ‰∫ã‰ª∂Âæ™ÁéØÂ∞Üclick ‰∫ã‰ª∂ÂéãÂÖ•Ë∞ÉÁî®Ê†à
3. `while true` ÊâßË°å

Ê≠§Êó∂Ê∏≤ÊüìÂ∑•‰ΩúÂú®Á≠âÂæÖ JavaScript ÊâßË°åÂÆåÊàê, ‰ΩÜÊòØ JavaScript ËøõÂÖ•‰∫ÜÊó†ÈôêÂæ™ÁéØ‰∏≠ÊâÄ‰ª•Ê∏≤ÊüìÂ∑•‰ΩúÂ∞±‰∏ÄÁõ¥Âú®Á≠âÂæÖ‰∏≠Ê∞∏Ëøú‰∏ç‰ºöÂæóÂà∞ÂÆåÊàê.

‰ΩÜÊòØÈ°µÈù¢ÁöÑÊ∏≤ÊüìÂç¥ÂèóÂà∞‰∫ÜÊù•Ëá™‰∫ã‰ª∂Âæ™ÁéØ‰∏≠ÁöÑÈòªÂ°û, ‰∏∫‰ªÄ‰πà‰ºöËøôÊ†∑?

Ëß£ÈáäËøôÁßçË°å‰∏∫ÁöÑ‰∏Ä‰∏™Â•ΩÁöÑÊñπÂºèÂ∞±ÊòØ: **Êàë‰ª¨‰∏çÂ¶®ÊääÈ°µÈù¢ÁöÑÊ∏≤ÊüìËøáÁ®ã‰πüËßÜ‰∏∫ "‰ªªÂä°ÈòüÂàó" ‰∏≠ÁöÑ‰∏Ä‰∏™‰ªªÂä°, Ëøô‰∏™‰ªªÂä°ÁöÑÂàõÂª∫ËÄÖÂ∞±ÊòØÊµèËßàÂô®Êú¨Ë∫´,ÂÆÉÂú®‰∏Ä‰∏™ÂêàÈÄÇÁöÑÊó∂Êú∫ÊääÊ∏≤Êüì‰ªªÂä°ÊîæÂÖ•Âà∞‰ªªÂä°ÈòüÂàó‰∏≠Á≠âÂæÖÊâßË°å, ‰ΩÜÊòØÁî±‰∫é‰ª£Á†ÅÈòªÂ°ûÂØºËá¥È°µÈù¢Êó†Ê≥ïÂèäÊó∂Êõ¥Êñ∞.**

## ÊÄùËÄÉ

‰∏ãÂàó‰ª£Á†Å‰ºöÈÄ†ÊàêÈòªÂ°ûÂêó:

```javascript
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>test</title>
</head>
<body>
  <video src="https://vjs.zencdn.net/v/oceans.mp4" controls autoplay></video>
  <button id="button">while true</button>
  <script>
    function loop(){
      setTimeout(loop,0);
    }
    loop();
  </script>
</body>
</html>
```

ËøôÊÆµ‰ª£Á†Å‰∏ç‰ªÖ‰∏ç‰ºöÈÄ†ÊàêÈòªÂ°ûÁîöËá≥‰∏ç‰ºöÈÄ†ÊàêÊ†àÊ∫¢Âá∫, ÊØèÊ¨°Ë∞ÉÁî® `loop` ÂáΩÊï∞‰ºöÂêë "‰ªªÂä°ÈòüÂàó" Ê∑ªÂä†‰∏Ä‰∏™‰ªªÂä°ÁÑ∂Âêé `loop` Â∞±‰ºöË¢´ÂºπÂá∫Ë∞ÉÁî®Ê†à, Ê≠§Êó∂ÁöÑË∞ÉÁî®Ê†àÂ∞±Ë¢´Ê∏ÖÁ©∫‰∫Ü. ËÄåË¥üË¥£ÊéßÂà∂‰ªªÂä°ÈòüÂàóÁöÑ‰∫ã‰ª∂Âæ™ÁéØÂè™ÊúâÂú®Ë∞ÉÁî®Ê†à‰∏∫Á©∫ÁöÑÊó∂ÂÄôÊâçËÉΩÁªßÁª≠ÊâßË°å‰ªªÂä°, ‰πüÂ∞±ÊòØËØ¥Ë∞ÉÁî®Ê†àÊ∞∏Ëøú‰∏ç‰ºöÁ¥ØÂä†.

ÂÖ∂Ê¨°‰ªªÂä°ÁöÑÊâßË°åÂπ∂‰∏çÂΩ±Âêë‰ªªÂä°ÈòüÂàóÊ∑ªÂä†ÂÜÖÂÆπ, Âú®Ë∞ÉÁî® `setTimeout(loop,0)` Âêé "‰∫ã‰ª∂Âæ™ÁéØ" ÁªßÁª≠Â∑•‰ΩúÂ§ÑÁêÜÈÇ£‰∫õÂ∑≤ÁªèË¢´Â°´ÂÖ•Âà∞‰ªªÂä°ÈòüÂàó‰∏≠Âú®Ê≠§‰πãÂâçÁöÑÂ°´ÂÖ•ÁöÑÂÖ∂‰ªñ‰∫ã‰ª∂‰ª•ÂèäÈ°µÈù¢ÁöÑÊ∏≤Êüì, Áõ¥Âà∞ "‰ªªÂä°ÈòüÂàó" ‰∏≠ÂÜçÊ¨°ÊâßË°åÊúâÂÖ≥ `loop` ÁöÑ‰ªªÂä°.

## ÊµÅÁïÖÁöÑÊ∏≤Êüì

ËØïÊÉ≥‰∏Ä‰∏ã‰Ω†Âú®È°µÈù¢‰∏äÂà∂‰Ωú‰∫Ü‰∏Ä‰∏™Âä®ÁîªÊïàÊûú‰ΩøÁî®Â¶Ç‰∏ã‰ª£Á†Å:

```javascript
function animate(){
  // ‰øÆÊîπÊ†∑Âºè
}

setInterval(animate,1000/60);
```

‰Ω†Â∏åÊúõÂä®ÁîªÂèØ‰ª•ËææÂà∞ 60fps ÊâÄ‰ª•Âêë `setInterval` ‰º†ÂÖ•‰∫Ü `1000/60` ÊúüÂæÖÂÆÉÂèØ‰ª•ÊØèÁßíÊâßË°å 60 Ê¨°Âä®ÁîªÂáΩÊï∞.

‰ΩÜÊòØÁî±‰∫é `setInterval` Âπ∂‰∏çÁ≤æÁ°ÆÂú®‰∏ÄÂ∏ß‰∏≠ÂèØËÉΩÊâßË°å‰∫ÜÂ§öÊ≠§, ‰πüÂèØËÉΩ‰∏ÄÊ¨°‰πüÊ≤°ÊúâÊâßË°å, ÊàñËÄÖÊâßË°å‰∫Ü‰∏Ä‰∏™ËÄóÊó∂ÁöÑ‰ªªÂä°ÂØºËá¥ÊµèËßàÂô®Êó†Ê≥ïÂú®‰∏ÄÂ∏ß‰∏≠ËøõË°åÊ∏≤ÊüìÊìç‰Ωú.

Êàë‰ª¨Â∏åÊúõÊØè‰∏ÄÂ∏ß‰∏≠Ëá≥Â∞ëÊúâ‰∏ÄÊ¨°Ê∏≤ÊüìËøáÁ®ã, ‰ΩÜÊòØÈöèÊú∫ÁöÑ‰ªªÂä°ÊâßË°å‰ºöÊâì‰π±ÁêÜÊÉ≥‰∏≠ÊúâËßÑÂæãÁöÑÊ∏≤ÊüìËøáÁ®ã, ÂØºËá¥Ê∏≤ÊüìÊìç‰Ωú‰∏çËÉΩÂπ≥ÂùáÂàÜÂ∏ÉÂà∞ÊØèÂ∏ß‰∏≠:

![1566277658471](C:\Users\zhao\Documents\library\article\assets\1566277658471.png)

ËÄåÊµèËßàÂô®Êú¨Ë∫´ÁöÑÊ∏≤ÊüìÂÆûÈôÖ‰∏äÊòØÈùûÂ∏∏Êô∫ËÉΩ‰∏îËäÇÁ∫¶ËÆ°ÁÆó. ‰æãÂ¶ÇÈ°µÈù¢Ê∏≤ÊüìÈ¢ëÁéáËá™Âä®ÂíåÂ±èÂπïÂà∑Êñ∞ÁéáË∞ÉÊï¥Âà∞‰∏ÄËá¥, ÂΩìÈ°µÈù¢ÈùôÊ≠¢ÊàñËÄÖ‰∏çÂèØËßÜÁöÑÊó∂ÂÄôÈ°µÈù¢‰ºöÂÅúÊ≠¢Ê∏≤Êüì, ËÄå‰ΩøÁî® `setInterval` Á≠âÂæàÈöæÂÆåÁæéÁöÑÂíåÈ°µÈù¢Ê∏≤ÊüìËøáÁ®ãÁõ∏ÁªìÂêà.

‰∏Ä‰∏™Ëß£ÂÜ≥ÈóÆÈ¢òÁöÑÂäûÊ≥ïÂ∞±ÊòØ‰ΩøÁî® `requestAnimationFrame`.

> **window.requestAnimationFrame()** ÂëäËØâÊµèËßàÂô®‚Äî‚Äî‰Ω†Â∏åÊúõÊâßË°å‰∏Ä‰∏™Âä®ÁîªÔºåÂπ∂‰∏îË¶ÅÊ±ÇÊµèËßàÂô®Âú®‰∏ãÊ¨°ÈáçÁªò‰πãÂâçË∞ÉÁî®ÊåáÂÆöÁöÑÂõûË∞ÉÂáΩÊï∞Êõ¥Êñ∞Âä®Áîª

‰ΩøÁî® `requestAnimationFrame` Êàë‰ª¨ÂèØ‰ª•‰ΩøÁî®ÊµèËßàÂô®ÁöÑÊ∏≤ÊüìÈÄªËæëÂ∞ÜÂéüÊú¨ÊùÇ‰π±ÁöÑÊ∏≤ÊüìËøáÁ®ãÂèòÂæóÊúâÂ∫èËµ∑Êù•, ËÆ©ÊµèËßàÂô®ÂÜ≥ÂÆö‰ΩïÊó∂ËøõË°åÊ∏≤Êüì, ÂØπ‰∫éÂä®ÁîªÊ∏≤ÊüìËøôÂÜçÂ•Ω‰∏çËøá‰∫Ü, Áé∞Âú®ÊúâÂÖ≥Âä®ÁîªÁöÑ‰ªªÂä°ÈÉΩË¢´ÊéíÂàóÂà∞‰∫ÜÊ∏≤Êüì‰ªªÂä°ÁöÑÂâçÈù¢:

![1566279040998](C:\Users\zhao\Documents\library\article\assets\1566279040998.png)

# macrotask(ÂÆè‰ªªÂä°) Âíå microtask(ÂæÆ‰ªªÂä°)

ÊúâÂÖ≥ÂÆè‰ªªÂä°ÁöÑÊ¶ÇÂøµÂú®ÂâçÈù¢Êàë‰ª¨Â∑≤ÁªèÊ∂âÂèäÂà∞‰∫Ü, Âú®ÊµèËßàÂô®‰∏≠‰ª•‰∏ãÁöÑÂá†‰∏™ÂºÇÊ≠• API ÊòØÂÆè‰ªªÂä°Áõ∏ÂÖ≥:

- setTimeout
- setInterval
- setImmediate
- UI rendering

ËÄåÂæÆ‰ªªÂä°ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊ¶ÇÂøµ, Êàë‰ª¨‰ªéÂæÆ‰ªªÂä°ÁöÑËÆæËÆ°ÂéÜÂè≤Êù•Ëß£ÈáäÂæÆ‰ªªÂä°‰∏∫‰ªÄ‰πàËøôÊ†∑ÊâßË°å.

Âæà‰πÖÂâçW3CÁªôÊµèËßàÂô®Âà∂ÂÆö‰∫Ü‰∏Ä‰∫õAPI, Ëøô‰∫õAPIÁî®‰∫éÁõëÂê¨DOMÁöÑÂèòÂåñ:

```javascript
element.addEventListener("DOMNodeInserted", function (ev) {
  // ...
}, false);
```

‰ΩÜÊòØËøô‰∏™APIÊúâÁùÄ‰∏•ÈáçÁöÑÊÄßËÉΩÈóÆÈ¢ò, Âè™Ë¶Å‰øÆÊîπÂÖÉÁ¥†ÁöÑÂ±ûÊÄßÂØπÂ∫îÁöÑ‰∫ã‰ª∂Â∞±‰ºöË¢´Ëß¶Âèë, ÂØπÂêå‰∏Ä‰∏™Â±ûÊÄß‰øÆÊîπ100Ê¨°Â∞±‰ºöËß¶Âèë100Ê¨°ÁöÑ‰∫ã‰ª∂, Âè¶Â§ñ‰∫ã‰ª∂ÂÖ∑ÊúâÂÜíÊ≥°ÁöÑÁâπÊÄßÂ≠êÂÖÉÁ¥†ÁöÑ‰øÆÊîπ‰πü‰ºöÂØºËá¥Áà∂ÂÖÉÁ¥†Ëß¶ÂèëËØ•‰∫ã‰ª∂:

```javascript
let i = 100;
while(i--){
  const span = document.createElement('span');
  element.appendChild(span); // ËøΩÂä†ÂÖÉÁ¥†Ëß¶Âèë‰∫ã‰ª∂‰∏ÄÊ¨°
  span.textContent = 'Test'; // ‰øÆÊîπËøΩÂä†ÁöÑÂÖÉÁ¥†ÁöÑÂ±ûÊÄßÂèàËß¶Âèë‰∏ÄÊ¨°‰∫ã‰ª∂
}
```

ÁªìÊûúÂ∞±ÊòØÊó†ËÆ∫‰Ω†Âú® `DOMNodeInserted` ÂõûË∞É‰∏≠ÂÜôÂ§ö‰πàÁÆÄÂçïÁöÑ‰ª£Á†Å, Â§çÊùÇÁöÑDOMÊìç‰ΩúÂØºËá¥‰∫ã‰ª∂Â∞±‰ºöË¢´ÂØÜÈõÜË∞ÉÁî®Â§ßÂ§ßÈôç‰ΩéÊÄßËÉΩ, ÊâÄ‰ª•Ëøô‰∏™APIË¢´Â∫üÂºÉ‰∫Ü.

ÁõëÂê¨DOM‰øÆÊîπÁöÑÈúÄÊ±Ç‰æùÁÑ∂Â≠òÂú®, ‰ΩÜÊòØÊàë‰ª¨Â∏åÊúõËøô‰∏™Êé•Âè£ÁöÑË°®Áé∞Â∞±ÂíåÊ∏≤Êüì‰∏ÄÊ†∑Â∞ÜDOM‰øÆÊîπËøõË°åÂêàÂπ∂ÂêéÂè™Ëß¶Âèë‰∏ÄÊ¨°, Ëøô‰∏™ËßÑËåÉÂú®DOM3‰∏≠Ë¢´Êé®Âá∫‰ªñÂ∞±ÊòØ [`MutationObserver`](https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver), ‰ªéËÄåÂºïÂÖ•‰∫Ü "ÂæÆ‰ªªÂä°" Âíå "ÂæÆ‰ªªÂä°ÈòüÂàó" Ëøô‰∏™Ê¶ÇÂøµ.

ÂæÆ‰ªªÂä°ÊòØÂºÇÊ≠•ÁöÑÊàë‰ª¨Áî®‰∏™ `Promise` Êù•‰∏æ‰æã:

```javascript
Promise.resolve().then(()=>console.log('hello world'));
console.log('foobar');
```

ËæìÂá∫:

```
foobar
hello world
```

`foobar` ÂÖà‰∫é `hello world` ËæìÂá∫ËøôÁÇπËØÅÊòé‰∫ÜÂÆÉ. ËôΩÁÑ∂‰ªñÊòØÂºÇÊ≠•ÁöÑ‰ΩÜËøô‰∏ç‰ª£Ë°®‰ªñÂøÖÈ°ªÈÅµÂæ™ "‰∫ã‰ª∂Âæ™ÁéØ" Âíå "Ê∏≤Êüì" Âà∂ÂÆöÁöÑËßÑÂàô. Áõ∏Âèç "ÂæÆ‰ªªÂä°" ÊúâËá™Â∑±ÁöÑÁé©Ê≥ï.

‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑÁâπÂæÅÂ∞±ÊòØ**Âè™ÊúâÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫ÂêéÂæÆ‰ªªÂä°ÊâçÁÆóÊâßË°åÂÆåÊàê**, Êàë‰ª¨Êää‰πãÂâçÁöÑ "‰∫ã‰ª∂Âæ™ÁéØ" ‰æãÂ≠êÊîπ‰∏∫ÂæÆ‰ªªÂä°ÁâàÊú¨:

```javascript
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>test</title>
</head>
<body>
  <video src="https://vjs.zencdn.net/v/oceans.mp4" controls autoplay></video>
  <button id="button">while true</button>
  <script>
    document.getElementById('button').addEventListener('click',()=>{
      function loop(){
          Promise.resolve().then(loop);
      }
      loop();
    });
  </script>
</body>
</html>
```

ÁªìÊûúÂ∞±ÊòØÂΩìÁÇπÂáªÊåâÈíÆÂêéÈ°µÈù¢Ê∏≤Êüì‰ºöÂÅúÊ≠¢ÊµèËßàÂô®ËøõÂÖ•Âà∞ÈòªÂ°û‰∏≠, ÂéüÂõ†ÂæàÁÆÄÂçï "ÂæÆ‰ªªÂä°ÈòüÂàó" ‰∏≠Ê∞∏ËøúÊúâ‰ªªÂä°ÊâÄ‰ª•ÊµèËßàÂô®‰∏ÄÁõ¥Âú®Á≠âÂæÖ "ÂæÆ‰ªªÂä°ÈòüÂàó" Ê∏ÖÁ©∫ÁÑ∂Âêé‰∏ÄÁõ¥ÊâßË°åÂæÆ‰ªªÂä°, ‰∏çÂπ∏ÁöÑÊòØËøôÊòØ‰∏Ä‰∏™Êó†Â∞ΩÁöÑ‰ªªÂä°ÈòüÂàóÊâÄ‰ª•ÂÆÉÊ∞∏ËøúÊó†Ê≥ïÊâßË°åÂÆå.

ÂæÆ‰ªªÂä°ÁöÑÂè¶Â§ñ‰∏Ä‰∏™ÁâπÊÄßÂ∞±ÊòØ **JavaScript Ë∞ÉÁî®Ê†à‰∏ÄÊó¶Ë¢´Ê∏ÖÁ©∫, ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°ÊâßË°å‰ºöÂÖà‰∫éÂÖ∂‰ªñÈòüÂàó**, ËØ∑ËßÇÂØü‰∏ãÈù¢ÁöÑ‰æãÂ≠ê:

```javascript
const button = document.getElementById('button');

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 1'));
	console.log('task 1');
});

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 2'));
	console.log('task 2');
});
```

ÁÇπÂáªÊåâÈíÆÂêéËæìÂá∫È°∫Â∫è:

```
task 1
Microtask 1
task 2
Microtask 2
```

ÊåâÈíÆÁÇπÂáªÂêéÁöÑÊâßË°åÊµÅÁ®ãÂ¶Ç‰∏ã:

1. "‰∫ã‰ª∂Âæ™ÁéØ" Â∞ÜÁ¨¨‰∏Ä‰∏™ÁÇπÂáª‰∫ã‰ª∂‰∏≠ÁöÑÂåøÂêçÂáΩÊï∞ÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä°
   2. ÊâßË°å `console.log('task 1')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
   4. ÊâßË°åÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°
   5. ÊâßË°å `console.log('Microtask 1')`
   6. ÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫
2. "‰∫ã‰ª∂Âæ™ÁéØ" Â∞ÜÁ¨¨‰∫å‰∏™ÁÇπÂáª‰∫ã‰ª∂‰∏≠ÁöÑÂåøÂêçÂáΩÊï∞ÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä°
   2. ÊâßË°å `console.log('task 2')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
   4. ÊâßË°åÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°
   5. ÊâßË°å `console.log('Microtask 2')`
   6. ÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫

‰∏çËøáÂ¶ÇÊûúË¶ÅÊääËøô‰∏™‰æãÂ≠êÁ®çÁ®ç‰øÆÊîπ‰∏Ä‰∏ãÊÉÖÂÜµÂç¥Áï•Êúâ‰∏çÂêå:

```javascript
const button = document.createElement('button');

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 1'));
	console.log('task 1');
});

button.addEventListener('click',()=>{
	Promise.resolve().then(()=>console.log('Microtask 2'));
	console.log('task 2');
});

button.click();
```

ËøôÊ¨°Êàë‰ª¨ÊâãÂä®Ëß¶Âèë `click` ‰∫ã‰ª∂, ËæìÂá∫ÁªìÊûúÂ¶Ç‰∏ã:

```
task 1
task 2
Microtask 1
Microtask 2
```

ËøôÊ¨°ÁöÑÊâßË°åÊµÅÁ®ã‰∏∫:

1. `button.click()` Ë¢´ÂéãÂÖ•Ë∞ÉÁî®Ê†àÊâßË°å
2. ÂêåÊ≠•Ëß¶Âèë 'click' ‰∫ã‰ª∂Âπ∂Â∞ÜÁ¨¨‰∏Ä‰∏™‰∫ã‰ª∂ÂõûË∞ÉÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä° `console.log('Microtask 1')`
   2. ÊâßË°å `console.log('task 1')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
- **Ê≥®ÊÑè**: Ê≠§Êó∂ `button.click` Âπ∂Êú™ÊâßË°åÂÆåÊàêËøòÂú®Ë∞ÉÁî®Ê†à‰∏≠
3. ÂêåÊ≠•Ëß¶Âèë 'click' ‰∫ã‰ª∂Âπ∂Â∞ÜÁ¨¨‰∫å‰∏™‰∫ã‰ª∂ÂõûË∞ÉÂéãÂÖ•Ë∞ÉÁî®Ê†à
   1. ÂæÆ‰ªªÂä°ÈòüÂàó‰∏≠Ê∑ªÂä†‰ªªÂä° `console.log('Microtask 2')`
   2. ÊâßË°å `console.log('task 2')`
   3. ÂåøÂêçÂáΩÊï∞ÊâßË°åÂÆåÊàêÂºπÂá∫Ë∞ÉÁî®Ê†à
4. `button.click` ‰ªéË∞ÉÁî®Ê†à‰∏≠ÂºπÂá∫
5. Ê∏ÖÁ©∫ÂæÆ‰ªªÂä°ÈòüÂàó
6. ÊâßË°å `console.log('Microtask 1')`
7. ÊâßË°å `console.log('Microtask 2')`
8. ÂæÆ‰ªªÂä°ÈòüÂàóÊ∏ÖÁ©∫

Âú®ÊµèËßàÂô®‰∏≠‰ª•‰∏ãÁöÑ API ÊòØÂæÆ‰ªªÂä°ÁöÑ‰ªªÂä°Ê∫ê:

- Promise
- MutationObserver

# Node.js ‰∏≠ÁöÑ‰∫ã‰ª∂Âæ™ÁéØ

> https://youtu.be/zphcsoSJMvM

## ËÆ°ÁÆóÊú∫Á∫øÁ®ãËøõÂåñÂè≤

ÂõûÂà∞ `ms-dos` Âíå `Apple os` ÁöÑÊó∂‰ª£ÈÇ£Êó∂ÂÄôÁöÑÊìç‰ΩúÁ≥ªÁªü‰ΩøÁî®ÂëΩ‰ª§Ë°åÁïåÈù¢, ËÆ°ÁÆóÊú∫CPUÂè™Êúâ‰∏Ä‰∏™Ê†∏ÂøÉ, Êìç‰ΩúÁ≥ªÁªüÂêå‰∏ÄÊó∂Èó¥‰∏ãÂè™ËÉΩÊâßË°å‰∏Ä‰ª∂‰∫ãÊÉÖ.ÈÄöËøáÊìç‰ΩúÁïåÈù¢ÂëäËØâÊìç‰ΩúÁ≥ªÁªü‰Ω†Ë¶ÅËøêË°å‰∏Ä‰∏™Â∫îÁî®Á®ãÂ∫è, Ê≠§Êó∂Á≥ªÁªü‰ºöÂÅúÊ≠¢ËøêË°åÂπ∂ËøêË°åÈÇ£‰∏™Á®ãÂ∫è, ÂΩìÂ∫îÁî®Á®ãÂ∫èÊâßË°åÂÆåÂêéÂèàÊääÊâßË°åÊùÉÂäõ‰∫§Áî±Êìç‰ΩúÁ≥ªÁªü.

ËøôÁßçËÆæËÆ°ÊúâÁùÄÈùûÂ∏∏Â§ßÁöÑÈôêÂà∂, ‰Ω†Êó†Ê≥ïÂêåÊó∂ÊâßË°åÂ§ö‰ª∂‰∫ãÊÉÖ, ‰∫éÊòØ‰∏ÄÁßçË¢´Áß∞‰ΩúÂçè‰ΩúÂ§ö‰ªªÂä°(cooperative multitasking)ÁöÑÊú∫Âà∂Âá∫Áé∞‰∫Ü. ËøôÁßçËÆæËÆ°‰∏ã‰Ω†ÂèØ‰ª•ÂêåÊó∂ËøêË°åÂ§ö‰∏™Á®ãÂ∫è.

‰ΩÜÊòØËøôÁßçÊú∫Âà∂Âá∫Áé∞ÂêéË°®Áé∞ÂêÑÂ§ßÊìç‰ΩúÁ≥ªÁªüÁöÑÂÆûÁé∞‰πü‰∏çÊòØÂçÅÂàÜÂÆåÁæé, Âú®ÂΩìÊó∂ÁöÑ `Mac OS` Âíå `windows` Êìç‰ΩúÁ≥ªÁªü‰∏≠ËøôÁßçÂ§öÁ®ãÂ∫èÊâßË°åÁöÑÂÆûÁé∞‰∫§Áî±Â∫îÁî®Á®ãÂ∫èÂÜ≥ÂÆö, Â¶ÇÊûúÁ®ãÂ∫èÊ≤°ÊúâÁºñÂÜôÂØπÂ∫îÁöÑ‰ª£Á†ÅÈÇ£‰πàËøô‰∏™Á®ãÂ∫è‰ºö‰∏ÄÁõ¥Âç†Áî®CPUËµÑÊ∫ê, Â¶ÇÊûú‰∏ÄÊó¶Á®ãÂ∫èÂ¥©Ê∫ÉÁîöËá≥‰ºöÁâµÊâØÂà∞Á≥ªÁªü, ÂØºËá¥Á≥ªÁªüÂ¥©Ê∫É.

ÂêéÊù•ËøôÁßçÊú∫Âà∂Ë¢´Êîπ‰∏∫‰∫ÜÊä¢Âç†ÂºèÂ§ö‰ªªÂä°(preemptive multitasking), ËøêË°åÂì™‰∏™Á®ãÂ∫èÁî±Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆö, Âú®ÂàáÊç¢Â∫îÁî®Á®ãÂ∫èÁöÑÊó∂ÂÄô‰ªñ‰ºöÊääÊ≠£Âú®ËøêË°å‰∏≠ÁöÑÁ®ãÂ∫èÊöÇÂÅúÁÑ∂Âêé‰øùÁïôÂÖ∂Áä∂ÊÄÅÂ≠òÂÇ®Âà∞ÂÖ∂‰ªñ‰ΩçÁΩÆ‰∏≠, ÁÑ∂ÂêéÂä†ËΩΩÂè¶Â§ñ‰∏Ä‰∏™Á®ãÂ∫è. ËøôÈ°πÊú∫Âà∂ÊúÄÂàùÂºïÁî®Âà∞‰∫ÜÈù¢ÂêëÊúçÂä°Âô®ÁöÑ Unix Á≥ªÁªü, Âú®ÈöèÂêéÁöÑÊó∂Èó¥ÈáåÊâçÂ∫îÁî®Âà∞‰∫Ü‰ΩøÁî® NT ÂÜÖÊ†∏ÁöÑ windows2000 ÂíåÂêåÊó∂ÊúüÁöÑ Mac OS 1004 ÁöÑ‰∏™‰∫∫ÁîµËÑë‰∏≠.

Ê≠§Êó∂AMDÂàöÂàöÂèëÂ∏É‰∫ÜÂÆÉÁöÑÂ§öÊ†∏CPU, ‰∏∫‰∫ÜÂÖÖÂàÜÂà©Áî®Â§öÊ†∏CPUÁöÑÊÄßËÉΩ, ÂùáË°°Â§öÁ∫øÁ®ã(symmetric multi threading)ÊäÄÊúØËØûÁîü‰∫Ü, ËØ•ÊäÄÊúØÁöÑÂÆûÈôÖÂ∫îÁî®Ë¢´ intel È¶ñÂÖàÈááÁî®Âπ∂ÈáçÊñ∞ÂëΩÂêç‰∏∫Ë∂ÖÁ∫øÁ®ã(hyper threading). ËØ•ÊäÄÊúØÁöÑ‰∏ªË¶ÅÂéüÁêÜÊòØ: CPUÂú®ÊâßË°å‰ªªÂä°ÁöÑÊó∂ÂÄôÂπ∂Èùû‰∏ÄÁõ¥Êª°ËΩΩÊâßË°å, ËøôÈáåÊúâÂæàÂ§öÁ©∫Èó≤ËµÑÊ∫êÂèØ‰ª•Âà©Áî®, ËÄåË∂ÖÁ∫øÁ®ãÂÖÅËÆ∏‰∏Ä‰∏™CPUÊ†∏ÂøÉÂèØ‰ª•ÂêåÊó∂Â§ÑÁêÜÂ§ö‰ª∂‰∫ãÊÉÖÂÖÖÂàÜÁöÑÂà©Áî®CPUÁ©∫Èó≤ËµÑÊ∫ê.

Âú®‰∏äÊñá‰∏≠Êàë‰ª¨ÊèêÂà∞‰∫Ü‰∏§‰∏™Âü∫Êú¨ÁöÑÊ¶ÇÂøµ "‰ªªÂä°" Âíå "Á∫øÁ®ã", ÂÆûÈôÖ‰∏ä‰ªªÂä°Â∞±ÊòØÊàë‰ª¨Â∏∏ËØ¥ÁöÑ "ËøõÁ®ã", Á∫øÁ®ãÂíåËøõÁ®ãÁöÑÊ¶ÇÂøµÊàë‰ª¨Â∞±Âú®ËøôÈáå‰∏çÊèê‰∫Ü, Êàë‰ª¨ÈúÄË¶ÅÊèêÂà∞ÁöÑ‰∏ÄÁÇπÂ∞±ÊòØÁ∫øÁ®ãÁöÑ "Á´ûÊÄÅ". Á∫øÁ®ãÁöÑÊâßË°åÊòØÂπ∂Ë°åÁöÑÁ∫øÁ®ãÈó¥ÂÖ±‰∫´ÂÜÖÂÆπ, ÂΩì‰∏§‰∏™Á∫øÁ®ãÊìç‰ΩúÂêå‰∏Ä‰∏™Êï∞ÊçÆÁöÑÊó∂ÂÄô‰ºöÂá∫Áé∞ËøôÁßçÈóÆÈ¢ò.

ÂÅáËÆæÊàë‰ª¨Êúâ‰∏§‰∏™Á∫øÁ®ãÁ∫øÁ®ãAÂêëÂÖ®Â±ÄÂèòÈáèÂÜôÂÖ•‰∏Ä‰∏™Êï∞ÊçÆ,Á∫øÁ®ãBËØªÂèñÂØπÂ∫îÁöÑÂÖ®Â±ÄÂèòÈáè,Áî±‰∫é‰∏§‰∏™Á∫øÁ®ãÈÉΩÊòØÂπ∂Ë°åÁöÑÊâÄ‰ª•Á∫øÁ®ãAÂèØËÉΩÂú®Á∫øÁ®ãBËØªÂèñÂâçËøõË°å‰∫ÜÂÜôÂÖ•, ‰πüÊúâÂèØËÉΩÁ∫øÁ®ãBÂÖàËØªÂèñÂêéÁ∫øÁ®ãAÂÜçÂÜôÂÖ•, ÊØèÊ¨°ËøêË°åÈÉΩ‰ºöÂæóÂà∞‰∏çÂêåÁöÑÁªìÊûú. ËøôËÆ©Á®ãÂ∫èÂÖÖÊª°‰∫Ü‰∏çÁ°ÆÂÆöÊÄß‰πü‰ºöÂØºËá¥ÂæàÂ§öbug, ËÆ∏Â§öËØ≠Ë®ÄÈÉΩÊèê‰æõ‰∫ÜÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÊìç‰ΩúÊù•ÈÅøÂÖçÈóÆÈ¢ò, ‰∏çËøáÂç≥‰ΩøÊòØÁªèÈ™å‰∏∞ÂØåÁöÑÁ®ãÂ∫èÂëòÂæÄÂæÄ‰πüÂæó‰ªîÁªÜÊÄùËÄÉÊâçËÉΩËÆæËÆ°Âá∫Á∫øÁ®ãÂÆâÂÖ®ÁöÑÁ®ãÂ∫è.

**ÂØπ‰∫éNodeÊù•ËØ¥Ëß£ÂÜ≥ÁöÑÊñπÂºèÈùûÂ∏∏ÁÆÄÂçïÁõ¥Êé•, Êàë‰ª¨‰ΩøÁî®ÂçïÁ∫øÁ®ãÊ®°Âûã, ‰∏çÂÖÅËÆ∏‰Ω†‰ΩøÁî®Â§öÁ∫øÁ®ãÊ®°Âûã(Node 11‰∏≠Ê∑ªÂä†‰∫ÜÂÆûÈ™å‰∏≠ÁöÑÂ§öÁ∫øÁ®ãÊîØÊåÅ).**

## Event loop

Node.js ÂÆòÁΩë‰∏≠[ÊúâÁØá](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)‰∏ìÈó®‰ªãÁªç‰∫ã‰ª∂Âæ™ÁéØÁöÑÊñáÁ´†, ‰πüÊòØËøôËäÇÁöÑ**Ê†∏ÂøÉ**, ËøôÁØáÊñáÁ´†Â∑≤ÁªèË¢´ÁøªËØëÂÆåÊàê üëâ[ËÆøÈóÆËøûÊé•](https://segmentfault.com/a/1190000020353471). Êú¨Êù•ÊâìÁÆóÊîæÂà∞ËøôËøôÁØáÊñáÁ´†‰∏≠Êù•ÁöÑ‰ΩÜÊòØËøôÊ†∑ÂÅöÂØºËá¥Êú¨ÊñáÂ§™Èïø‰∫Ü, ÊâÄ‰ª•Â∞±ÁßªÈô§Âá∫Âéª‰∫Ü, ÊòØ‰∏ÄÁØáÂçÅÂàÜÈáçË¶ÅÁöÑÊñáÁ´†, ÂØπ‰∫éÁêÜËß£ Node.js ‰∏≠ÁöÑ‰∫ã‰ª∂Âæ™ÁéØËá≥ÂÖ≥ÈáçË¶Å.

## ÊúâÂÖ≥‰∫ã‰ª∂Âæ™ÁéØÁöÑÂ∏∏ËßÅÈîôËØØ

> https://youtu.be/gl9qHml-mKc

### NodeÊòØÂçïÁ∫øÁ®ãÁöÑ

JavaScript ÊòØÂçïÁ∫øÁ®ãÁöÑËøôÊ≤°ÊúâÈóÆÈ¢ò, Âõ†‰∏∫Âú® Node ‰∏≠ÊâÄÊúâÁöÑ "JavaScript ËÑöÊú¨", "V8 ÂºïÊìé", "‰∫ã‰ª∂Âæ™ÁéØ", ÈÉΩËøêË°åÂú®‰∏Ä‰∏™Á∫øÁ®ã‰∏≠Ëøô‰∏™Á∫øÁ®ãË¢´Áß∞‰∏∫ "‰∏ªÁ∫øÁ®ã".

**‰ΩÜÊòØËøô‰∏çÊÑèÂë≥ÁùÄ Node Êú¨Ë∫´ÊòØÂçïÁ∫øÁ®ãÁöÑÂõ†‰∏∫ Node ËøòÊúâÂÖ∂‰ªñÈÉ®ÂàÜ**. Node ÁöÑÊ∫êÁ†Å‰∏≠ËøòÂåÖÊã¨‰∫Ü C++ ‰ª£Á†Å, C++ÈÉ®ÂàÜÊã•ÊúâÊìç‰ΩúÁ∫øÁ®ãÁöÑËÉΩÂäõ, ËøôÂèñÂÜ≥‰∫é‰Ω†Ë∞ÉÁî® JavaScript APIÁöÑÊñπÂºè. ‰æãÂ¶ÇÂ¶ÇÊûú‰Ω†Ë∞ÉÁî®‰∫Ü‰∏Ä‰∏™ Node ÁöÑ API, Ëøô‰∏™ API ËÉåÂêéÊòØÁî± C++ ‰ª£Á†ÅÊèê‰æõÊîØÊåÅÁöÑ. Â¶ÇÊûú‰Ω†ÂêåÊ≠•ÁöÑË∞ÉÁî®ÈÇ£‰πà C++ ‰ª£Á†Å‰ºöÂú®‰∏ªÁ∫øÁ®ã‰∏äÊâßË°å. Â¶ÇÊûú‰Ω†Ë∞ÉÁî®‰∏Ä‰∏™ÂºÇÊ≠•ÁöÑ Node Êé•Âè£, ÈÇ£‰πà C++ ÊúâÂèØËÉΩ‰ºö‰ΩøÁî®È¢ùÂ§ñÁöÑÁ∫øÁ®ãÊù•ÊâßË°åËøô‰∏™‰ªªÂä°.

ÊâÄ‰ª•‰ΩøÁî®ÂêåÊ≠• API ÈÇ£‰πà Node Â∞±Ê≤°ÊúâÊú∫‰ºöÂà©Áî®Â§öÁ∫øÁ®ãÁöÑÂπ∂Ë°åËÆ°ÁÆóÁöÑÁâπÊÄßÊù•ÊèêÂçáÊÄßËÉΩ, ÊâÄ‰ª•Âú®‰ªª‰ΩïÊó∂ÂÄôÈÉΩÊé®Ëçê‰ΩøÁî®ÂºÇÊ≠•ÁöÑÊé•Âè£, ËøôÊ†∑ÂèØ‰ª•Âà©Áî® Node ÂÜÖÈÉ®ÁöÑÁ∫øÁ®ãÊú∫Âà∂ËøõË°å‰ºòÂåñÊâßË°åÊïàÁéá.

Âú®ÈªòËÆ§ÊÉÖÂÜµ‰∏ã Node ‰ºö‰ΩøÁî®Á∫øÁ®ãÊ±†Á∫øÁ®ãÊ±†ÁöÑÂÆπÈáè‰∏∫ 4 (ÂèØ‰ª•ÈÄöËøáÁéØÂ¢ÉÂèòÈáèËøõË°å‰øÆÊîπ), ÂΩìÈúÄË¶ÅÁ∫øÁ®ãÁöÑ‰ªªÂä°Ë∂ÖËøá4‰∏™Âêé, Node ‰ºöÂ∞Ü‰ªªÂä°ÊîæÂÖ•Âà∞‰ªªÂä°ÈòüÂàó‰∏≠. ‰∏ÄÊó¶Á©∫Èó≤Á∫øÁ®ãÂá∫Áé∞ Node ‰ºöÂ∞Ü‰ªªÂä°‰ªéÈòüÂàó‰∏≠ÂèñÂá∫ÊîæÂÖ•Âà∞Á∫øÁ®ã‰∏≠ÊâßË°å.

**ÂõæÁâá:**Âú® windows10  ‰∏ä‰ΩøÁî®ÂëΩ‰ª§Ë°åÂàöÂàöÂêØÂä®ÁöÑ Node Â∞±‰ΩøÁî®‰∫Ü12‰∏™Á∫øÁ®ã:

![1566385151734](C:\Users\zhao\Documents\library\article\assets\1566385151734.png)

### Event Loop ÊòØÂü∫‰∫éÂ§öÁ∫øÁ®ãÊ®°ÂûãÁöÑ

Êúâ‰∏Ä‰∫õ‰ªªÂä°‰∏ç‰æùËµñÁ∫øÁ®ãÊ±†ËÄåÊòØ‰æùËµñÊìç‰ΩúÁ≥ªÁªüÊèê‰æõÁöÑÊé•Âè£, ‰æãÂ¶Ç `http.request` ËÉåÂêé C++ ‰ºöÂ∞ΩÂèØËÉΩÁöÑË∞ÉÁî®Á≥ªÁªüÊèê‰æõÁöÑÂºÇÊ≠•Êé•Âè£ epoll(linux) kqueue(mac os), GetQueuedCompletionStatusEx(Windows)Êù•Â∞Ü‰ªªÂä°ÂßîÊâòÁªôÊìç‰ΩúÁ≥ªÁªüÂéªÂÆåÊàê.

‰∏ãÂàóÁöÑÂàóË°®‰∏≠‰æã‰∏æ‰∫ÜÂºÇÊ≠• API ËÉåÂêéÁöÑËøêË°åÊú∫Âà∂:

- Kernel Async
  - `tcp/udp` sockets, servers
  - unix domain sockets, servers
  - pipes
  - tty input
  - dns.resolveXXX
- Thread Pool
  - files
  - fs.*
  - dns.lookup
  - pipes(exceptional)
- Signal Handler(posix only)
  - child processes
  - signals
- Wait Thread(windows only)
  - child processes
  - console input
  - tcp servers(exceptional)

### Event Loop ËøêË°åÂú®Áã¨Á´ãÁ∫øÁ®ã‰∏≠

ÂæàÂ§ö‰∫∫ËÆ§‰∏∫ Event loop ÊòØÁã¨Á´ãÁöÑÂÆÉËøêË°åÂú®‰∏Ä‰∏™ÂçïÁã¨ÁöÑÁ∫øÁ®ã‰∏≠, ‰ΩÜÊòØÂÆûÈôÖ‰∏ä Event Loop ‰Ωú‰∏∫ JavaScript ÈÉ®ÂàÜÁöÑÂÜÖÂÆπÊòØÂíå JavaScript ‰∏ÄÊ†∑ËøêË°åÂú®‰∏ªÁ∫øÁ®ã‰∏äÁöÑ.

### Event Loop ÁöÑÊ¶ÇÂøµÁ±ª‰ºº‰∫éÊ†àÊàñËÄÖÈòüÂàó

Â¶ÇÊûú‰Ω†ÁúãËøá Node.js ÂÆòÊñπ‰ªãÁªç‰∫ã‰ª∂Âæ™ÁéØÁöÑÊñáÁ´†‰Ω†Â∞±‰ºöÁü•ÈÅì([ÊñáÁ´†Âú∞ÂùÄ](#Event Loop)), ‰∫ã‰ª∂Âæ™ÁéØÂπ∂‰∏çÊòØÁÆÄÂçïÁöÑÊ†àÊàñËÄÖÈòüÂàóÁöÑÊ¶ÇÂøµ, ËÄåÊòØÂ§ö‰∏™ "Èò∂ÊÆµ" ÁöÑÈõÜÂêà, Âú®‰∏çÂêåÁöÑ "Èò∂ÊÆµ" ‰∏≠Áî®‰∫é‰øùÂ≠ò‰ªªÂä°ÁöÑÊï∞ÊçÆÁªìÊûÑÂíåÊâßË°åÈÄªËæëÊòØ‰∏çÂêåÁöÑ.

# ‰∫ã‰ª∂Âæ™ÁéØÂú® Node ‰∫éÊµèËßàÂô®‰∏≠ÁöÑÂºÇÂêå

‰∏§ËÄÖÁöÑ‰∏çÂêåÁÇπ‰∏ªË¶ÅÂú®‰∫ã‰ª∂Âæ™ÁéØÁöÑÊâßË°åÊú∫Âà∂‰∏ä:

- ÊµèËßàÂô®Âú®ÊâßË°åÂÆåÂÆè‰ªªÂä°(micro-task)Âêé‰ºöÊ£ÄÊü•ÊòØÂê¶Â≠òÂú®ÂæÆ‰ªªÂä°(micro-task), Â¶ÇÊûúÂ≠òÂú®ÂæÆ‰ªªÂä°ÂàôÂè™ÊúâÂ∞ÜÊâÄÊúâÁöÑÂæÆ‰ªªÂä°ÊâßË°åÂÆåÊàêÂêéÊâç‰ºöÁªßÁª≠ÊâßË°åÂÆè‰ªªÂä°.
- Node Êää‰∫ã‰ª∂Âæ™ÁéØÂàÜ‰∏∫‰∫ÜÂ§ö‰∏™Èò∂ÊÆµ, Âú®‰∏Ä‰∏™Èò∂ÊÆµ‰∏≠ÈõÜ‰∏≠ÊâßË°åÂêåÁ±ªÂûãÁöÑ‰ªªÂä°, ÊâßË°å‰ªªÂä°ÊâÄ‰∫ßÁîüÁöÑÊñ∞ÁöÑ‰ªªÂä°Ë¢´ËÆ∞ÂΩï, Êé®Ëá≥‰∏ã‰∏ÄËΩÆÂæ™ÁéØÊâßË°å. ÂæÆ‰ªªÂä°Âú®ËØ•Èò∂ÊÆµÁöÑÊú´Â∞æÊâßË°å.

Ê≠§Â§ñ Node ËøòÊúâÁâπÊÆäÁöÑ `process.nextTick`, ËØ• API Ë¢´ËßÜ‰∏∫ÂæÆ‰ªªÂä°Ê∫ê‰πã‰∏Ä, ‰ΩÜÊòØÊâßË°åÊñπÂºèÂíåÊµèËßàÂô®‰∏≠ÁöÑÊñπÂºè‰∏çÂêå. Âú® `Node11` Âêé Node Á´ØÁöÑÂæÆ‰ªªÂä°ÊâßË°åÊïàÊûúÂºÄÂßãÂíåÊµèËßàÂô®Á´ØË∂ãÂêå.

Node ÂíåÊµèËßàÂô®ÂÖ±Êúâ `setTimeout` Âíå `Promise` Ëøô‰∏§‰∏™Êé•Âè£, ‰∏Ä‰∏™Ë¢´ËßÜ‰∏∫ÂÆè‰ªªÂä°Ê∫êÂè¶‰∏Ä‰∏™Ë¢´ËßÜ‰∏∫ÂæÆ‰ªªÂä°Ê∫ê, Êàë‰ª¨‰ΩøÁî®Ëøô‰∏§‰∏™ `API` Êù•ÂÅö‰∏™Â∞èÊµãËØï, ÊµãËØïÁî®‰æãÂ¶Ç‰∏ã:

```javascript
setTimeout(() => {
  console.log('setTimeout - 1');
  setTimeout(() => {
    console.log('setTimeout - 1 - 1')
  });
  new Promise(resolve => resolve()).then(() => {
    console.log('setTimeout - 1 - then')
    new Promise(resolve => resolve()).then(() => {
      console.log('setTimeout - 1 - then - then')
    });
  });
});

setTimeout(() => {
  console.log('setTimeout - 2');
  setTimeout(() => {
    console.log('setTimeout - 2 - 1')
  });
  new Promise(resolve => resolve()).then(() => {
    console.log('setTimeout - 2 - then')
    new Promise(resolve => resolve()).then(() => {
      console.log('setTimeout - 2 - then - then')
    });
  });
});
```

Âú®ÊµèËßàÂô®Á´ØËæìÂá∫Â¶Ç‰∏ã:

```
setTimeout - 1
setTimeout - 1 - then
setTimeout - 1 - then - then
setTimeout - 2
setTimeout - 2 - then
setTimeout - 2 - then - then
setTimeout - 1 - 1
setTimeout - 2 - 1
```

Ëß£Èáä:

```
// ‰∏§‰∏™ setTimeout ‰∏≠ÁöÑ‰ªªÂä°ÈÉΩÂ∑≤ÁªèË¢´Âà∞‰ªªÂä°ÈòüÂàó‰∏≠.
-------------
// ÊâßË°å‰ªªÂä° - 1
setTimeout - 1
    - setTimeout Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ‰ªªÂä° - 3
    - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
	// Á¨¨‰∏Ä‰∏™‰ªªÂä°ÁªìÊùü, ÂèëÁé∞ÂæÆ‰ªªÂä°Â≠òÂú®, ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 1 - then
    - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
    // ÂæÆ‰ªªÂä°ÊâßË°åÂÆåÊàê, ÂèëÁé∞Êñ∞ÁöÑÂæÆ‰ªªÂä°, ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 1 - then - then
    // ÂæÆ‰ªªÂä°ÊâßË°åÂÆåÊàê
// ÊâßË°å‰ªªÂä° - 2
setTimeout - 2
    - setTimeout Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ‰ªªÂä° - 4
    - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
	// Á¨¨‰∏Ä‰∏™‰ªªÂä°ÁªìÊùü, ÂèëÁé∞ÂæÆ‰ªªÂä°Â≠òÂú®, ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 2 - then
    - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
    // ÂæÆ‰ªªÂä°ÊâßË°åÂÆåÊàê, ÂèëÁé∞Êñ∞ÁöÑÂæÆ‰ªªÂä°, ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 1 - then - then
    // ÂæÆ‰ªªÂä°ÊâßË°åÂÆåÊàê
// ÊâßË°å‰ªªÂä° 3
setTimeout - 1 - 1
// ÊâßË°å‰ªªÂä° 4
setTimeout - 2 - 1
```

Node10 ÊâßË°åÂ¶Ç‰∏ã:

```
// ËøõÂÖ• timer Èò∂ÊÆµ
-------------
// ÊâßË°å‰ªªÂä° - 1
setTimeout - 1
  - setTimeout Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ‰ªªÂä° - 3
  - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
// ÊâßË°å‰ªªÂä° - 2
setTimeout - 2
  - setTimeout Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ‰ªªÂä° - 4
  - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
// timer Èò∂ÊÆµÁªìÊùü
// ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 1 - then
  - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
// ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 2 - then
  - Promise Ê∑ªÂä†‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÂæÆ‰ªªÂä°
// ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 1 - then - then
// ÊâßË°åÂæÆ‰ªªÂä°
setTimeout - 2 - then - then
// ÂæÆ‰ªªÂä°Â§ÑÁêÜÂÆåÊàê
// ËøõÂÖ•ÂÖ∂‰ªñÈò∂ÊÆµÂºÄÂßãÂæ™ÁéØ -> Áõ¥Âà∞ÂÜçÊ¨°ËøõÂÖ• timer Èò∂ÊÆµ
// ÊâßË°å‰ªªÂä° 3
setTimeout - 1 - 1
// ÊâßË°å‰ªªÂä° 4
setTimeout - 2 - 1
```

**Ê≠£Â¶Ç‰πãÂâçÊâÄËØ¥ Node11 ÂêéÊâßË°åÈÄªËæëÂèëÁîü‰∫ÜÂèòÂåñÊâßË°åÈÄªËæëÂêëÊµèËßàÂô®Èù†Êã¢**, ËøôÈáåÁªôÂá∫ Node12 ‰∏≠ÊâßË°åÁõ∏Âêå‰ª£Á†ÅÁöÑËæìÂá∫:

```
setTimeout - 1
setTimeout - 2
setTimeout - 1 - then
setTimeout - 2 - then
setTimeout - 1 - then - then
setTimeout - 2 - then - then
setTimeout - 1 - 1
setTimeout - 2 - 1
```

Âè¶Â§ñÊàë‰ª¨ÈÉΩÁü•ÈÅì Node Êúâ‰∏Ä‰∏™ `process.nextTick`, ‰øÆÊîπ‰πãÂâçÁöÑ‰ª£Á†ÅÂêé:

```javascript

setTimeout(() => {
  console.log('setTimeout - 1');
  setTimeout(() => {
    console.log('setTimeout - 1 - 1')
  });
  process.nextTick(() => {
    console.log('setTimeout - 1 - nextTick')
    process.nextTick(() => {
      console.log('setTimeout - 1 - nextTick - nextTick')
    });
  });
});

setTimeout(() => {
  console.log('setTimeout - 2');
  setTimeout(() => {
    console.log('setTimeout - 2 - 1')
  });
  process.nextTick(() => {
    console.log('setTimeout - 2 - nextTick')
    process.nextTick(() => {
      console.log('setTimeout - 2 - nextTick - nextTick')
    });
  });
});
```

Âú® Node10 ‰∏≠ËæìÂá∫Â¶Ç‰∏ã:

```
setTimeout - 1
setTimeout - 2
setTimeout - 1 - nextTick
setTimeout - 2 - nextTick
setTimeout - 1 - nextTick - nextTick
setTimeout - 2 - nextTick - nextTick
setTimeout - 1 - 1
setTimeout - 2 - 1
```

Êàë‰ª¨ÂèØ‰ª•ÁúãÂà∞ËæìÂá∫ÂíåÁªìÊûúÂíå‰ΩøÁî® `Promise` Âà´Êó†‰∫åËá¥, Âè¶Â§ñÂú® Node12 ‰∏≠ÁöÑËæìÂá∫Â¶Ç‰∏ã:

```javascript
setTimeout - 1
setTimeout - 1 - nextTick
setTimeout - 1 - nextTick - nextTick
setTimeout - 2
setTimeout - 2 - nextTick
setTimeout - 2 - nextTick - nextTick
setTimeout - 1 - 1
setTimeout - 2 - 1
```

ÁªìÊûúÂíå‰πãÂâçÁöÑ‰ΩøÁî® `Promise` ‰πüÊòØÊ≤°ÊúâÂå∫Âà´ÁöÑ, ‰∏çËøáÂêåÊ†∑Ë∫´‰∏∫ÂæÆ‰ªªÂä°Ê∫ê‰πã‰∏Ä, Âú® Node ‰∏≠ËøòÊòØÊúâÂÖàÂêé‰πãÂàÜÁöÑ:

```javascript

setTimeout(() => {
  console.log('setTimeout - 1');
  
  process.nextTick(() => {
    console.log('setTimeout - 1 - nextTick')
    process.nextTick(() => {
      console.log('setTimeout - 1 - nextTick - nextTick')
    });
  });

  new Promise(resolve => resolve()).then(() => {
    console.log('setTimeout - 1 - then')
    new Promise(resolve => resolve()).then(() => {
      console.log('setTimeout - 1 - then - then')
    });
  });
});
```

Node10 Âíå Node12 ËæìÂá∫:

```
setTimeout - 1
setTimeout - 1 - nextTick
setTimeout - 1 - nextTick - nextTick
setTimeout - 1 - then
setTimeout - 1 - then - then
```

ÂèØ‰ª•ÁúãÂá∫ `process.nextTick` ÁöÑ‰ºòÂÖàÁ∫ßÈ´ò‰∫é `Promise` ÁöÑ.

# ÂèÇËÄÉ

> https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/
>
> https://nodejs.org/dist/latest-v12.x/docs/api/worker_threads.html
>
> https://www.dynatrace.com/news/blog/all-you-need-to-know-to-really-understand-the-node-js-event-loop-and-its-metrics/#disqus_thread
>
> https://blog.csdn.net/Fundebug/article/details/86487117
>
> https://www.cnblogs.com/MuYunyun/p/7287413.html
>
> http://www.ruanyifeng.com/blog/2018/02/node-event-loop.html
>
> https://jsbin.com/dijodahawi/edit?html,css,js,console,output
>
> https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
>
> https://segmentfault.com/a/1190000019759283



